<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График работы аптеки</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: white;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
        }
        
        .header {
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        
        
        .title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #000;
            letter-spacing: 0;
            text-transform: none;
            text-align: center;
            padding: 15px 25px;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            border-radius: 0;
            border: 1px solid #000;
            display: inline-block;
            transition: none;
        }
        
        .title:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }
        
        
        
        .header-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-label {
            font-weight: 600;
            min-width: 100px;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .header-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 15px;
            transition: none;
            background-color: white;
            min-width: 150px;
            font-weight: 500;
        }
        
        .header-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background-color: white;
        }
        
        .header-input:hover {
            border-color: #000;
            background-color: white;
        }
        
        
        
        
        
        

        .controls-bottom {
            margin-top: 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .controls-bottom-left {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .controls-bottom-right {
            margin-left: auto;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-add {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
            text-transform: none;
            letter-spacing: 0;
        }
        
        .btn-add:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }
        
        .btn-add:active {
            background: repeating-linear-gradient(
                45deg,
                #d0d0d0 0px,
                #d0d0d0 4px,
                rgba(208, 208, 208, 0.3) 4px,
                rgba(208, 208, 208, 0.3) 8px
            );
        }
        
        .btn-export {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            ) !important;
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
            text-transform: none;
            letter-spacing: 0;
        }
        
        .btn-export:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            ) !important;
        }
        
        .btn-export:active {
            background: repeating-linear-gradient(
                45deg,
                #d0d0d0 0px,
                #d0d0d0 4px,
                rgba(208, 208, 208, 0.3) 4px,
                rgba(208, 208, 208, 0.3) 8px
            ) !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #000;
            width: 550px;
            max-width: 95vw;
            border-radius: 0;
            box-shadow: none;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #000;
            padding: 24px 24px 0 24px;
            letter-spacing: 0.3px;
        }
        
        .modal-body {
            padding: 0 24px 24px 24px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
            max-height: calc(95vh - 150px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .form-group.required .form-label::after {
            content: ' *';
            color: #f44336;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
            transition: none;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            color: #000;
        }

        .form-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }

        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            cursor: pointer;
            transition: none;
            color: #000;
        }

        .form-select:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }
        
        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .form-checkbox-label {
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding: 20px 24px;
            background: repeating-linear-gradient(
                45deg,
                #f8f9ff 0px,
                #f8f9ff 4px,
                rgba(248, 249, 255, 0.3) 4px,
                rgba(248, 249, 255, 0.3) 8px
            );
            border-top: 1px solid #000;
            flex-wrap: wrap;
        }
        
        .btn-submit {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }
        
        .btn-submit:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }
        
        .btn-delete {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }
        
        .btn-delete:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
        }
        
        .btn-cancel {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
        }
        
        .btn-cancel:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }
        
        .schedule-wrapper {
            overflow-x: auto;
            margin: 25px 0;
            border: 2px solid #e8ecf5;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background-color: white;
            min-width: 1400px;
            table-layout: fixed;
        }
        
        .schedule-table td {
            border: 1px solid #000;
            padding: 4px 5px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            transition: none;
        }
        
        /* Жирные границы для контура таблицы и блоков сотрудников */
        .schedule-table tr.input-row:first-child td {
            border-top: 2px solid #000;
        }
        
        .schedule-table tr.label-row:last-of-type td {
            border-bottom: 2px solid #000;
        }
        
        .col-position {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            );
            color: #000;
            text-align: left;
            font-weight: 600;
            width: 100px;
            padding-left: 8px;
            cursor: pointer;
            border: 1px solid #000;
            border-left: 2px solid #000;
        }
        
        .col-position:hover {
            background: repeating-linear-gradient(
                45deg,
                #c8e6d3 0px,
                #c8e6d3 4px,
                rgba(200, 230, 211, 0.3) 4px,
                rgba(200, 230, 211, 0.3) 8px
            );
        }
        
        .col-name {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            );
            color: #000;
            text-align: left;
            font-weight: 600;
            width: 180px;
            padding-left: 8px;
            padding-right: 8px;
            border: 1px solid #000;
        }
        
        .col-name:hover {
            background: repeating-linear-gradient(
                45deg,
                #c8e6d3 0px,
                #c8e6d3 4px,
                rgba(200, 230, 211, 0.3) 4px,
                rgba(200, 230, 211, 0.3) 8px
            );
        }
        
        .col-schedule {
            background: repeating-linear-gradient(
                45deg,
                #f0f9f4 0px,
                #f0f9f4 4px,
                rgba(240, 249, 244, 0.3) 4px,
                rgba(240, 249, 244, 0.3) 8px
            );
            color: #000;
            text-align: center;
            font-weight: 600;
            font-size: 9px;
            width: 90px;
            padding: 4px;
            border: 1px solid #000;
        }
        
        .col-shift-type {
            background: white;
            color: #000;
            text-align: center;
            font-weight: 600;
            font-size: 9px;
            width: 90px;
            padding: 4px;
            white-space: normal;
            border: 1px solid #000;
        }
        
        .col-total {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            );
            color: #000;
            text-align: center;
            font-weight: 600;
            font-size: 9px;
            width: 90px;
            padding: 4px;
            border: 1px solid #000;
            border-left: 2px solid #000;
            border-right: 2px solid #000;
        }
        
        .day-header {
            background: repeating-linear-gradient(
                45deg,
                #f0f9f4 0px,
                #f0f9f4 4px,
                rgba(240, 249, 244, 0.3) 4px,
                rgba(240, 249, 244, 0.3) 8px
            );
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            width: 40px;
            padding: 4px 0;
            color: #000;
            border: 1px solid #000;
        }
        
        /* Жирные границы для заголовков таблицы */
        .schedule-table thead tr:first-child th,
        .schedule-table thead tr:first-child td {
            border-top: 2px solid #000;
        }
        
        .schedule-table thead tr:last-child th,
        .schedule-table thead tr:last-child td {
            border-bottom: 2px solid #000;
        }
        
        /* Жирные границы для первой строки каждого блока сотрудника */
        .schedule-table tbody tr.input-row td {
            border-top: 2px solid #000;
        }
        
        /* Жирные границы для последней строки каждого блока сотрудника (Количество часов) */
        .schedule-table tbody tr.employee-block-end td {
            border-bottom: 2px solid #000;
        }
        
        /* Жирные границы для всех ячеек в крайних столбцах */
        .schedule-table tbody td.col-position {
            border-left: 2px solid #000;
        }
        
        .schedule-table tbody td.col-total {
            border-left: 2px solid #000;
            border-right: 2px solid #000;
        }
        
        .day-number {
            font-weight: bold;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .day-name {
            font-size: 9px;
            color: #333;
            line-height: 1.2;
        }
        
        .day-header.weekend {
            background: repeating-linear-gradient(
                45deg,
                #ffe4cc 0px,
                #ffe4cc 4px,
                rgba(255, 228, 204, 0.3) 4px,
                rgba(255, 228, 204, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
        }
        
        /* Дополнительное визуальное выделение заголовков и боковых столбцов */
        .schedule-table tbody tr.input-row td.col-position,
        .schedule-table tbody tr.label-row td.col-position {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            ) !important;
        }
        
        .schedule-table tbody tr.input-row td.col-name,
        .schedule-table tbody tr.label-row td.col-name {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            ) !important;
        }
        
        .schedule-table tbody tr.input-row td.col-total,
        .schedule-table tbody tr.label-row td.col-total {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            ) !important;
        }
        
        .data-cell {
            padding: 3px;
            width: 40px;
            background: repeating-linear-gradient(
                45deg,
                white 0px,
                white 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
            cursor: pointer;
            transition: none;
            border: 1px solid #000;
        }
        
        .data-cell:hover {
            background: repeating-linear-gradient(
                45deg,
                #f5f5f5 0px,
                #f5f5f5 4px,
                rgba(245, 245, 245, 0.3) 4px,
                rgba(245, 245, 245, 0.3) 8px
            );
        }
        
        .data-cell.weekend {
            background: repeating-linear-gradient(
                45deg,
                #ffe4cc 0px,
                #ffe4cc 4px,
                rgba(255, 228, 204, 0.3) 4px,
                rgba(255, 228, 204, 0.3) 8px
            );
            border: 1px solid #000;
        }

        
        .data-cell.weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #ffd9b3 0px,
                #ffd9b3 4px,
                rgba(255, 217, 179, 0.3) 4px,
                rgba(255, 217, 179, 0.3) 8px
            );
        }

        /* Перекрываем градиент выходных для незакрытых смен при наведении */
        .data-cell.weekend.day-no-workers:hover {
            background: repeating-linear-gradient(
                45deg,
                #FFD6E6 0px,
                #FFD6E6 4px,
                rgba(255, 214, 230, 0.3) 4px,
                rgba(255, 214, 230, 0.3) 8px
            ) !important;
            background-color: #FFD6E6 !important;
        }
        
        .shift-value {
            font-size: 10px;
            text-align: center;
            color: #000;
        }
        
        .hours-cell {
            background: repeating-linear-gradient(
                45deg,
                white 0px,
                white 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
            text-align: center;
            font-weight: 600;
            font-size: 10px;
            padding: 4px;
            width: 40px;
            cursor: pointer;
            position: relative;
            transition: none;
            border: 1px solid #000;
        }
        
        .hours-cell:hover {
            background: repeating-linear-gradient(
                45deg,
                #f5f5f5 0px,
                #f5f5f5 4px,
                rgba(245, 245, 245, 0.3) 4px,
                rgba(245, 245, 245, 0.3) 8px
            );
        }
        
        .hours-cell.weekend {
            background: repeating-linear-gradient(
                45deg,
                #ffe4cc 0px,
                #ffe4cc 4px,
                rgba(255, 228, 204, 0.3) 4px,
                rgba(255, 228, 204, 0.3) 8px
            );
        }


        .hours-cell.weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #ffd9b3 0px,
                #ffd9b3 4px,
                rgba(255, 217, 179, 0.3) 4px,
                rgba(255, 217, 179, 0.3) 8px
            );
        }

        /* Перекрываем градиент выходных для незакрытых смен при наведении */
        .hours-cell.weekend.day-no-workers:hover {
            background: repeating-linear-gradient(
                45deg,
                #FFD6E6 0px,
                #FFD6E6 4px,
                rgba(255, 214, 230, 0.3) 4px,
                rgba(255, 214, 230, 0.3) 8px
            ) !important;
            background-color: #FFD6E6 !important;
        }

        .hours-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 2px;
        }

        .hours-value {
            flex: 1;
        }

        .delete-btn {
            display: none;
            width: 16px;
            height: 16px;
            padding: 0;
            border: none;
            background-color: transparent;
            color: #333;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
            flex-shrink: 0;
        }

        .hours-cell:hover .delete-btn {
            display: block;
        }
        
        .hours-cell:hover .hours-value {
            display: none;
        }

        .delete-btn:hover {
            color: #f44336;
            transform: scale(1.2);
        }

        .add-btn {
            display: none;
            width: 16px;
            height: 16px;
            padding: 0;
            border: none;
            background-color: transparent;
            color: #333;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
            flex-shrink: 0;
        }

        .hours-cell:hover .add-btn {
            display: block;
        }

        .add-btn:hover {
            color: #4CAF50;
            transform: scale(1.2);
        }
        
        .total-hours-cell {
            background: white;
            color: #000;
            text-align: center;
            font-weight: 600;
            font-size: 10px;
            padding: 4px;
            width: 90px;
            border: 1px solid #000;
        }
        
        .auto-value {
            color: #666;
            font-size: 10px;
        }
        
        .employee-position-cell {
            line-height: 1.2;
        }
        
        .employee-position {
            font-weight: bold;
        }
        
        .employee-status {
            font-size: 9px;
            color: #666;
        }

        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-save {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }
        
        .btn-save:hover {
            background: #e0e0e0;
        }
        
        .btn-export {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }
        
        .btn-export:hover {
            background: #e0e0e0;
        }

        .btn-print {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }

        .btn-print:hover {
            background: #e0e0e0;
        }
        
        .btn-clear {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        
        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }
        .btn-ack-sheet {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .btn-ack-sheet:hover {
            background-color: #45a049;
        }

        .btn-ack-sheet:active {
            background-color: #3d8b40;
        }

        /* ===== СТИЛИ ДЛЯ ЛИСТА ОЗНАКОМЛЕНИЯ ===== */
        .modal-overlay-ack {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-overlay-ack.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
        }

        .modal-ack {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header-ack {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #000;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
        }

        .modal-header-ack h2 {
            margin: 0;
            font-size: 18px;
            color: #000;
        }

        .modal-close-ack {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            border: 1px solid #000;
            border-radius: 0;
            font-size: 28px;
            cursor: pointer;
            color: #000;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close-ack:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
        }

        .modal-body-ack {
            padding: 20px;
        }

        .ack-sheet-preview {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 30px;
            border-radius: 4px;
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            margin: 20px 0;
        }

        .ack-sheet-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .ack-sheet-preview th {
            background-color: #e8e8e8;
            padding: 8px;
            text-align: center;
            border: 1px solid #999;
            font-weight: bold;
            font-size: 12px;
        }

        .ack-sheet-preview td {
            padding: 6px 8px;
            border: 1px solid #999;
            font-size: 12px;
        }

        .ack-sheet-preview .ack-title {
            font-weight: bold;
            font-size: 14px;
            margin: 0;
        }

        .ack-field-box {
            border: 1px solid #000;
            padding: 4px 8px;
            font-size: 12px;
            display: inline-block;
            min-width: 150px;
            background-color: #fff;
        }

        .ack-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .ack-table th {
            background-color: #ffffff;
            border: 1px solid #000;
            padding: 8px;
            font-weight: normal;
            font-size: 12px;
        }

        .ack-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            font-size: 12px;
        }

        /* Стили для журнала выдачи расчетных листков */
        .payroll-journal-title {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
        }

        .payroll-journal-subtitle {
            text-align: center;
            font-weight: normal;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .payroll-journal-pharmacy {
            text-align: center;
            font-weight: normal;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .pharmacy-number-highlight {
            color: #ff0000;
            font-weight: bold;
        }

        .payroll-journal-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }

        .payroll-journal-table th {
            background-color: #ffffff;
            padding: 8px;
            text-align: center !important;
            border: 1px solid #000;
            font-weight: normal;
            font-size: 12px;
        }
        
        .payroll-journal-table th[style*="text-align: center"] {
            text-align: center !important;
        }

        .payroll-journal-table td {
            padding: 6px 8px;
            border: 1px solid #000;
            font-size: 12px;
        }

        .payroll-journal-table tbody tr {
            height: 35px;
        }

        .payroll-journal-footer {
            margin-top: 30px;
            font-size: 12px;
        }

        .payroll-journal-signature-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .payroll-journal-signature-left,
        .payroll-journal-signature-right {
            width: 200px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 200px;
            height: 0;
            margin: 0;
        }

        .signature-label {
            font-size: 10px;
            margin-top: 5px;
        }

        .signature-name {
            margin-bottom: 5px;
            min-height: 20px;
        }

        .modal-footer-ack {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background-color: #f9f9f9;
        }

        .btn-print-ack,
        .btn-download-ack,
        .btn-close-modal-ack {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-print-ack {
            background-color: #FF9800;
            color: white;
        }

        .btn-print-ack:hover {
            background-color: #e68900;
        }

        .btn-download-ack {
            background-color: #4CAF50;
            color: white;
        }

        .btn-download-ack:hover {
            background-color: #45a049;
        }

        .btn-close-modal-ack {
            background-color: #ccc;
            color: #333;
        }

        .btn-close-modal-ack:hover {
            background-color: #bbb;
        }

        
        .btn-clear:hover {
            background-color: #da190b;
        }
        
        .message {
            padding: 14px 20px;
            margin-top: 15px;
            border-radius: 10px;
            display: none;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .message.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .input-row {
            background-color: white;
        }
        
        .label-row {
            background-color: white;
        }

        .cell-edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .cell-edit-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border: 1px solid #000;
            width: 400px;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
            display: flex;
            flex-direction: column;
            animation: slideDown 0.3s ease;
            max-height: 90vh;
        }

        .cell-edit-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            padding: 24px 24px 0 24px;
            color: #000;
            letter-spacing: 0.3px;
        }

        .cell-edit-form-group {
            margin-bottom: 20px;
            padding: 0 24px;
        }

        .cell-edit-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .cell-edit-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
            transition: none;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            color: #000;
        }
        
        .cell-edit-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }

        .cell-edit-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding: 20px 24px;
            background: repeating-linear-gradient(
                45deg,
                #f8f9ff 0px,
                #f8f9ff 4px,
                rgba(248, 249, 255, 0.3) 4px,
                rgba(248, 249, 255, 0.3) 8px
            );
            border-top: 1px solid #000;
        }

        .btn-save-cell {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }

        .btn-save-cell:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }

        .btn-cancel-cell {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
        }

        .btn-cancel-cell:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }

        .calendar-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .calendar-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border: 1px solid #000;
            width: 650px;
            border-radius: 0;
            box-shadow: none;
            max-height: 90vh;
            overflow: visible;
            display: flex;
            flex-direction: column;
            animation: slideDown 0.3s ease;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            padding: 24px 24px 0 24px;
            color: #000;
            letter-spacing: 0.3px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 25px;
            padding: 0 24px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            padding: 10px;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            border-radius: 0;
            box-shadow: none;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #000;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            background-color: white;
            transition: none;
            color: #000;
        }

        .calendar-day:hover {
            background-color: #f0f0f0;
        }

        .calendar-day.shift-day {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
            border-color: #000;
            box-shadow: none;
        }

        .calendar-day.shift-day:hover {
            background: repeating-linear-gradient(
                45deg,
                #d0d0d0 0px,
                #d0d0d0 4px,
                rgba(208, 208, 208, 0.3) 4px,
                rgba(208, 208, 208, 0.3) 8px
            );
            transform: none;
            box-shadow: none;
        }

        .calendar-day.weekend {
            background: repeating-linear-gradient(
                45deg,
                #ffe4cc 0px,
                #ffe4cc 4px,
                rgba(255, 228, 204, 0.3) 4px,
                rgba(255, 228, 204, 0.3) 8px
            );
        }

        .calendar-day.weekend.shift-day {
            background: repeating-linear-gradient(
                45deg,
                #ffe4cc 0px,
                #ffe4cc 4px,
                rgba(255, 228, 204, 0.3) 4px,
                rgba(255, 228, 204, 0.3) 8px
            );
            color: #000;
            box-shadow: none;
        }

        .calendar-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding: 20px 24px;
            background: repeating-linear-gradient(
                45deg,
                #f8f9ff 0px,
                #f8f9ff 4px,
                rgba(248, 249, 255, 0.3) 4px,
                rgba(248, 249, 255, 0.3) 8px
            );
            border-top: 1px solid #000;
        }

        .btn-calendar-save {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
            box-shadow: none;
        }

        .btn-calendar-save:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            transform: none;
            box-shadow: none;
        }

        .btn-calendar-cancel {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: none;
        }

        .btn-calendar-cancel:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
            transform: none;
        }

        .absence-cell {
            background-color: #FFB3BA !important;
        }

        .absence-cell.weekend {
            background-color: #FF9FA5 !important;
        }

        /* Больничные/отпуска с градиентным паттерном */
        .data-cell[data-absence-type="vacation"],
        .data-cell[data-absence-type="vacation"].weekend {
            background: repeating-linear-gradient(
                45deg,
                #fff3cd 0px,
                #fff3cd 4px,
                rgba(255, 243, 205, 0.3) 4px,
                rgba(255, 243, 205, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #fff3cd 0px,
                #fff3cd 4px,
                rgba(255, 243, 205, 0.3) 4px,
                rgba(255, 243, 205, 0.3) 8px
            ) !important;
        }

        .data-cell[data-absence-type="sick"],
        .data-cell[data-absence-type="sick"].weekend {
            background: repeating-linear-gradient(
                45deg,
                #f8d7da 0px,
                #f8d7da 4px,
                rgba(248, 215, 218, 0.3) 4px,
                rgba(248, 215, 218, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #f8d7da 0px,
                #f8d7da 4px,
                rgba(248, 215, 218, 0.3) 4px,
                rgba(248, 215, 218, 0.3) 8px
            ) !important;
        }

        .hours-cell[data-absence-type="vacation"],
        .hours-cell[data-absence-type="vacation"].weekend {
            background: repeating-linear-gradient(
                45deg,
                #fff3cd 0px,
                #fff3cd 4px,
                rgba(255, 243, 205, 0.3) 4px,
                rgba(255, 243, 205, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #fff3cd 0px,
                #fff3cd 4px,
                rgba(255, 243, 205, 0.3) 4px,
                rgba(255, 243, 205, 0.3) 8px
            ) !important;
        }

        .hours-cell[data-absence-type="sick"],
        .hours-cell[data-absence-type="sick"].weekend {
            background: repeating-linear-gradient(
                45deg,
                #f8d7da 0px,
                #f8d7da 4px,
                rgba(248, 215, 218, 0.3) 4px,
                rgba(248, 215, 218, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #f8d7da 0px,
                #f8d7da 4px,
                rgba(248, 215, 218, 0.3) 4px,
                rgba(248, 215, 218, 0.3) 8px
            ) !important;
        }

        /* Hover стили для больничных/отпусков */
        .data-cell[data-absence-type="vacation"]:hover,
        .data-cell[data-absence-type="vacation"].weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #ffeaa7 0px,
                #ffeaa7 4px,
                rgba(255, 234, 167, 0.3) 4px,
                rgba(255, 234, 167, 0.3) 8px
            ) !important;
        }

        .data-cell[data-absence-type="sick"]:hover,
        .data-cell[data-absence-type="sick"].weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #f5c6cb 0px,
                #f5c6cb 4px,
                rgba(245, 198, 203, 0.3) 4px,
                rgba(245, 198, 203, 0.3) 8px
            ) !important;
        }

        .hours-cell[data-absence-type="vacation"]:hover,
        .hours-cell[data-absence-type="vacation"].weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #ffeaa7 0px,
                #ffeaa7 4px,
                rgba(255, 234, 167, 0.3) 4px,
                rgba(255, 234, 167, 0.3) 8px
            ) !important;
        }

        .hours-cell[data-absence-type="sick"]:hover,
        .hours-cell[data-absence-type="sick"].weekend:hover {
            background: repeating-linear-gradient(
                45deg,
                #f5c6cb 0px,
                #f5c6cb 4px,
                rgba(245, 198, 203, 0.3) 4px,
                rgba(245, 198, 203, 0.3) 8px
            ) !important;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 0mm;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white;
                padding: 0;
                margin: 0;
                width: 297mm; /* Ширина A4 landscape */
                height: 210mm; /* Высота A4 landscape */
            }

            .controls-bottom, .buttons, .message {
                display: none !important;
            }

            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;
            }

            .schedule-wrapper {
                overflow: visible !important;
                border: none;
                margin: 0;
                width: 100%;
                transform: scale(1);
                transform-origin: top left;
            }

            .schedule-table {
                min-width: 100% !important;
                font-size: 6px !important;
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .schedule-table td, .schedule-table th {
                padding: 1px 1px !important;
                height: auto !important;
                font-size: 6px !important;
                line-height: 1.1 !important;
            }

            .title {
                font-size: 10px;
                margin-bottom: 3px;
            }

            .delete-btn, .add-btn {
                display: none !important;
            }

            .col-name {
                width: 100px;
            }

            .col-position {
                width: 50px;
            }

            .col-schedule {
                width: 45px;
            }

            .day-header {
                width: 20px;
            }

            .data-cell {
                width: 20px;
            }

            .hours-cell {
                width: 20px;
            }

            .col-total {
                width: 50px;
                font-size: 5px !important;
            }
        }
    

        /* ===== SIDEBAR STYLES ===== */
        .sidebar-wrapper {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 12px rgba(0,0,0,0.15);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.35s ease;
            transform: translateX(100%);
        }

        .sidebar-wrapper.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid #000;
        }

        .sidebar-header-title {
            font-weight: 600;
            font-size: 14px;
            color: #000;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: #000;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .sidebar-close:hover {
            opacity: 0.8;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .ref-section {
            margin-bottom: 25px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #000;
            border-radius: 0;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: none;
            box-shadow: none;
            color: #000;
        }

        .sidebar-btn-pharma {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
        }

        .sidebar-btn-pharma:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
        }

        .sidebar-btn-employee {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
        }

        .sidebar-btn-employee:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            color: #000;
        }

        .sidebar-btn-print {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
        }

        .sidebar-btn-print:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
        }

        .sidebar-toggle-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 56px;
            height: 56px;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 24px;
            cursor: pointer;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            transition: none;
        }

        .sidebar-toggle-btn:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            transform: none;
        }

        .sidebar-toggle-btn:active {
            background: repeating-linear-gradient(
                45deg,
                #d0d0d0 0px,
                #d0d0d0 4px,
                rgba(208, 208, 208, 0.3) 4px,
                rgba(208, 208, 208, 0.3) 8px
            );
            transform: none;
        }
        
        /* Inline версия кнопки сайдбара в controls-bottom */
        .sidebar-toggle-inline {
            position: static !important;
            bottom: auto !important;
            right: auto !important;
            width: auto !important;
            height: auto !important;
            padding: 12px 24px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            display: inline-block !important;
            margin: 0 !important;
            text-transform: none !important;
            letter-spacing: 0 !important;
        }

        @media (max-width: 768px) {
            .sidebar-wrapper {
                width: 280px;
            }
        }

        /* Старые стили для модального окна отсутствия - оставлены для обратной совместимости, но не используются */
        .modal-absence { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-absence-content { 
            background-color: white;
            margin: 10% auto; 
            padding: 30px; 
            border: 1px solid #000;
            border-radius: 0; 
            width: 500px; 
            box-shadow: none; 
        }
        .modal-absence-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #000; }
        .form-group-absence { margin-bottom: 20px; }
        .form-group-absence label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group-absence select, .form-group-absence input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .date-range-group { display: flex; gap: 10px; }
        .date-range-group .form-group-absence { flex: 1; }
        .modal-buttons-absence { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel-absence { 
            background: repeating-linear-gradient(
                45deg,
                #888 0px,
                #888 4px,
                rgba(136, 136, 136, 0.3) 4px,
                rgba(136, 136, 136, 0.3) 8px
            );
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .btn-save-absence { 
            background: repeating-linear-gradient(
                45deg,
                #4CAF50 0px,
                #4CAF50 4px,
                rgba(76, 175, 80, 0.3) 4px,
                rgba(76, 175, 80, 0.3) 8px
            );
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }

        /* Employee Manager Modal Styles */
        .employee-manager-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }

        .employee-manager-modal.active {
            display: block;
        }

        .employee-manager-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #000;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .employee-manager-header {
            padding: 20px 30px;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
        }

        .employee-manager-title {
            font-size: 24px;
            font-weight: 700;
            color: #000;
        }

        .employee-manager-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #000;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-manager-close:hover {
            opacity: 0.8;
        }

        .employee-manager-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .employee-manager-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .employee-manager-select-wrapper {
            flex: 1;
            min-width: 250px;
        }

        .employee-manager-select-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .employee-manager-select-wrapper select,
        .employee-manager-select-wrapper input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            color: #000;
            cursor: pointer;
            box-sizing: border-box;
        }

        .employee-manager-select-wrapper select:focus,
        .employee-manager-select-wrapper input:focus {
            outline: none;
            border-color: #000;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }

        .employee-manager-info {
            display: none;
        }

        .employee-manager-info.active {
            display: block;
        }

        .employee-manager-info-card {
            background: repeating-linear-gradient(
                45deg,
                #f8f9ff 0px,
                #f8f9ff 4px,
                rgba(248, 249, 255, 0.3) 4px,
                rgba(248, 249, 255, 0.3) 8px
            );
            border: 1px solid #000;
            padding: 20px;
            margin-bottom: 20px;
        }

        .employee-manager-info-card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #000;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .employee-manager-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .employee-manager-info-row:last-child {
            border-bottom: none;
        }

        .employee-manager-info-label {
            font-weight: 600;
            color: #333;
        }

        .employee-manager-info-value {
            color: #000;
        }

        .employee-manager-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .employee-manager-stat-card {
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
            border: 1px solid #000;
            padding: 15px;
            text-align: center;
        }

        .employee-manager-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }

        .employee-manager-stat-label {
            font-size: 14px;
            color: #666;
        }

        .employee-manager-work-section {
            margin-bottom: 30px;
        }

        .employee-manager-work-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #000;
            padding: 10px;
            background: repeating-linear-gradient(
                45deg,
                #e8ecf5 0px,
                #e8ecf5 4px,
                rgba(232, 236, 245, 0.3) 4px,
                rgba(232, 236, 245, 0.3) 8px
            );
            border: 1px solid #000;
        }

        .employee-manager-shifts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .employee-manager-shifts-table th,
        .employee-manager-shifts-table td {
            border: 1px solid #000;
            padding: 10px;
            text-align: left;
        }

        .employee-manager-shifts-table th {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            );
            font-weight: 600;
            color: #000;
        }

        .employee-manager-shifts-table tr:nth-child(even) {
            background: repeating-linear-gradient(
                45deg,
                #f9f9f9 0px,
                #f9f9f9 4px,
                rgba(249, 249, 249, 0.3) 4px,
                rgba(249, 249, 249, 0.3) 8px
            );
        }

        .employee-manager-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 15px;
            border: 1px solid #000;
            background: #fff;
            padding: 2px;
        }

        .employee-manager-calendar-header {
            background: repeating-linear-gradient(
                45deg,
                #d4f4dd 0px,
                #d4f4dd 4px,
                rgba(212, 244, 221, 0.3) 4px,
                rgba(212, 244, 221, 0.3) 8px
            );
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }

        .employee-manager-calendar-day {
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
            border: 1px solid #000;
            padding: 8px;
            min-height: 60px;
            position: relative;
        }

        .employee-manager-calendar-day.other-month {
            background: repeating-linear-gradient(
                45deg,
                #f5f5f5 0px,
                #f5f5f5 4px,
                rgba(245, 245, 245, 0.3) 4px,
                rgba(245, 245, 245, 0.3) 8px
            );
            color: #999;
        }

        .employee-manager-calendar-day.weekend {
            background: repeating-linear-gradient(
                45deg,
                #fff3e0 0px,
                #fff3e0 4px,
                rgba(255, 243, 224, 0.3) 4px,
                rgba(255, 243, 224, 0.3) 8px
            );
        }

        .employee-manager-calendar-day.has-shift {
            background: repeating-linear-gradient(
                45deg,
                #c8e6c9 0px,
                #c8e6c9 4px,
                rgba(200, 230, 201, 0.5) 4px,
                rgba(200, 230, 201, 0.5) 8px
            );
            font-weight: 600;
        }

        .employee-manager-calendar-day.has-subwork {
            background: repeating-linear-gradient(
                45deg,
                #bbdefb 0px,
                #bbdefb 4px,
                rgba(187, 222, 251, 0.5) 4px,
                rgba(187, 222, 251, 0.5) 8px
            );
            font-weight: 600;
        }

        .employee-manager-calendar-day.has-shift.has-subwork {
            background: repeating-linear-gradient(
                45deg,
                #b2dfdb 0px,
                #b2dfdb 4px,
                rgba(178, 223, 219, 0.5) 4px,
                rgba(178, 223, 219, 0.5) 8px
            );
        }

        .employee-manager-calendar-day.has-absence {
            background: repeating-linear-gradient(
                45deg,
                #fff3e0 0px,
                #fff3e0 4px,
                rgba(255, 243, 224, 0.3) 4px,
                rgba(255, 243, 224, 0.3) 8px
            );
        }

        .employee-manager-calendar-day.has-shift.has-absence {
            background: repeating-linear-gradient(
                45deg,
                #ffe0b2 0px,
                #ffe0b2 4px,
                rgba(255, 224, 178, 0.3) 4px,
                rgba(255, 224, 178, 0.3) 8px
            );
        }

        .employee-manager-calendar-day-absence {
            font-size: 10px;
            color: #e65100;
            font-weight: 600;
            margin-top: 2px;
        }

        .employee-manager-calendar-day-number {
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .employee-manager-calendar-day-shift {
            font-size: 11px;
            color: #333;
            margin-top: 4px;
            font-weight: 600;
        }

        .employee-manager-calendar-day-time {
            font-size: 10px;
            color: #555;
        }

        .employee-manager-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .employee-manager-empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .employee-manager-compensation-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .employee-manager-compensation-row:hover {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        /* New class to control sizing */
        .auto-resize-input {
            flex: none !important; /* CRITICAL: Override flex:1 from .header-input */
            width: auto;           /* Start with auto, JS will set pixel width */
            min-width: 150px;
            max-width: 100%;
            transition: width 0.1s ease-out;
            box-sizing: border-box;
        }

        select.auto-resize-input {
            cursor: pointer;
            padding-right: 30px; /* Ensure space for arrow if appearance allows, though native select handles it */
        }



        /* ========== CSS ДЛЯ ПЕЧАТИ - МАСШТАБИРОВАНИЕ И СКРЫТИЕ ========== */
        @media print {
            /* МАКСИМУМ ПРИОРИТЕТА */
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* Скрыть ВСЮ навигацию и кнопки */
            body > div:first-child { display: none !important; }
            nav { display: none !important; }
            header { display: none !important; }
            footer { display: none !important; }

            .header-row { display: none !important; }
            .controls-bottom { display: none !important; }
            .buttons { display: none !important; }

            /* Скрыть ВСЕ кнопки */
            button { 
                display: none !important; 
                visibility: hidden !important;
                height: 0 !important;
                width: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            input[type="text"],
            input[type="number"],
            input[type="date"],
            select,
            textarea { 
                display: none !important; 
            }

            /* Модальные окна */
            .modal { display: none !important; }
            .calendar-modal { display: none !important; }
            .modal-absence { display: none !important; }

            /* Основная страница */
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }

            .container {
                max-width: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none !important;
                background-color: white;
            }

            /* Заголовок */
            .header {
                margin: 0 0 3mm 0;
                padding: 0;
            }

            .title {
                font-size: 13pt;
                font-weight: bold;
                text-align: center;
                margin: 0;
                padding: 0;
                cursor: auto !important;
            }

            /* ТАБЛИЦА НА ОДНУ СТРАНИЦУ */
            .schedule-wrapper {
                width: 100%;
                margin: 0;
                padding: 0;
                overflow: visible !important;
            }

            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: avoid;
                table-layout: fixed;
                font-size: 8pt;
                background-color: white;
            }

            .schedule-table tr {
                page-break-inside: avoid;
            }

            /* ЯЧЕЙКИ ТАБЛИЦЫ - оригинальные цвета и высота */
            .schedule-table td {
                border: 1px solid #ccc !important;
                padding: 2px 3px !important;
                height: 16px !important;
                font-size: 7pt !important;
                vertical-align: middle;
                text-align: center;
            }

            /* Статические колонки - ОРИГИНАЛЬНЫЕ РАЗМЕРЫ И ЦВЕТА */
            .col-position {
                background-color: #c0c0c0 !important;
                width: 80px !important;
                font-size: 7pt !important;
                text-align: left !important;
                font-weight: bold !important;
                padding-left: 3px !important;
            }

            .col-name {
                background-color: #c0c0c0 !important;
                width: 130px !important;
                font-size: 7pt !important;
                text-align: left !important;
                font-weight: bold !important;
                padding-left: 2px !important;
                padding-right: 2px !important;
            }

            .col-schedule {
                background-color: #e8e8e8 !important;
                width: 70px !important;
                font-size: 6pt !important;
                text-align: center !important;
                font-weight: bold !important;
                padding: 1px !important;
            }

            .col-total {
                background-color: #e8e8e8 !important;
                width: 70px !important;
                font-size: 5pt !important;
                text-align: center !important;
                font-weight: bold !important;
                padding: 1px !important;
            }

            /* Дни - правильные цвета и размер */
            .day-header {
                background-color: #e8e8e8 !important;
                width: 18px !important;
                font-size: 6pt !important;
                padding: 1px 0 !important;
                text-align: center !important;
                font-weight: bold !important;
            }

            .day-number {
                font-size: 6pt !important;
                line-height: 1;
                font-weight: bold !important;
            }

            .day-name {
                font-size: 5pt !important;
                line-height: 1;
                color: #333 !important;
            }

            /* Выходные - более темный фон */
            .day-header.weekend {
                background-color: #d8d8d8 !important;
            }

            .weekend {
                background-color: #f5f5f5 !important;
            }

            /* Все остальное скрыть */
            .sidebar-wrapper { display: none !important; }

            /* Строки видны */
            .input-row {
                background-color: white !important;
            }
        }
        /* ========== КОНЕЦ CSS ДЛЯ ПЕЧАТИ ========== */

        /* ===== УЛУЧШЕННЫЕ СТИЛИ ДЛЯ МОДАЛЬНЫХ ОКОН СПРАВОЧНИКОВ ===== */

        /* Общие улучшения модального окна */
        .modal-content-improved {
            border-radius: 0 !important;
            box-shadow: none !important;
            border: 1px solid #000 !important;
            background-color: white !important;
            padding: 0 !important;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header-improved {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
            color: #000;
            padding: 24px;
            border-radius: 0;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
        }

        .modal-title-improved {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.3px;
            color: #000;
        }

        .close-improved {
            font-size: 32px;
            font-weight: 300;
            color: #000;
            cursor: pointer;
            transition: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            border: 1px solid #000;
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            );
        }

        .close-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            );
            transform: none;
        }

        /* Тело модального окна */
        .modal-body-improved {
            padding: 28px;
            overflow-y: auto;
            flex: 1;
        }

        /* Секция добавления */
        .add-section-improved {
            background: repeating-linear-gradient(
                45deg,
                #f8f9ff 0px,
                #f8f9ff 4px,
                rgba(248, 249, 255, 0.3) 4px,
                rgba(248, 249, 255, 0.3) 8px
            );
            border: 1px solid #000;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 24px;
            transition: none;
        }

        .add-section-improved:hover {
            border-color: #000;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            box-shadow: none;
        }

        .section-title-improved {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin: 0 0 16px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Сетка формы */
        .form-grid-improved {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .form-grid-2col {
            grid-template-columns: 1fr 1fr;
        }

        .form-group-improved {
            display: flex;
            flex-direction: column;
        }

        .form-label-improved {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .input-improved,
        .select-improved {
            padding: 12px 14px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            font-family: inherit;
            transition: none;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
            color: #000;
        }

        .input-improved:focus,
        .select-improved:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }

        .input-improved::placeholder {
            color: #999;
        }

        /* Кнопки */
        .btn-add-improved {
            background: repeating-linear-gradient(
                45deg,
                #667eea 0px,
                #667eea 4px,
                rgba(102, 126, 234, 0.3) 4px,
                rgba(102, 126, 234, 0.3) 8px
            );
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-add-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #764ba2 0px,
                #764ba2 4px,
                rgba(118, 75, 162, 0.3) 4px,
                rgba(118, 75, 162, 0.3) 8px
            );
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-add-improved:active {
            transform: translateY(0);
        }

        .btn-full-width {
            grid-column: 1 / -1;
        }

        /* Поиск */
        .search-section-improved {
            margin-bottom: 24px;
        }

        .search-input-improved {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e6f2;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input-improved:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Контейнер списка */
        .list-section-improved {
            margin-bottom: 16px;
        }

        .list-container-improved {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e8ecf5;
            border-radius: 8px;
            background: #fafbff;
        }

        .list-container-improved::-webkit-scrollbar {
            width: 8px;
        }

        .list-container-improved::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .list-container-improved::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .list-container-improved::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Элементы списка */
        .list-item-improved {
            padding: 14px 16px;
            border-bottom: 1px solid #e8ecf5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            background: white;
        }

        .list-item-improved:last-child {
            border-bottom: none;
        }

        .list-item-improved:hover {
            background: #f8f9ff;
            padding-left: 20px;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: #999;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .btn-delete-improved {
            background: repeating-linear-gradient(
                45deg,
                #ff5252 0px,
                #ff5252 4px,
                rgba(255, 82, 82, 0.3) 4px,
                rgba(255, 82, 82, 0.3) 8px
            );
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-delete-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #e53935 0px,
                #e53935 4px,
                rgba(229, 57, 53, 0.3) 4px,
                rgba(229, 57, 53, 0.3) 8px
            );
            color: #000;
            transform: translateY(-1px);
        }

        .btn-edit-improved {
            background: repeating-linear-gradient(
                45deg,
                #4caf50 0px,
                #4caf50 4px,
                rgba(76, 175, 80, 0.3) 4px,
                rgba(76, 175, 80, 0.3) 8px
            ) !important;
            color: #000 !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            transition: all 0.2s ease;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .btn-edit-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #45a049 0px,
                #45a049 4px,
                rgba(69, 160, 73, 0.3) 4px,
                rgba(69, 160, 73, 0.3) 8px
            ) !important;
            color: #000 !important;
            transform: translateY(-1px);
        }

        .btn-cancel-edit-improved {
            background: repeating-linear-gradient(
                45deg,
                #9e9e9e 0px,
                #9e9e9e 4px,
                rgba(158, 158, 158, 0.3) 4px,
                rgba(158, 158, 158, 0.3) 8px
            );
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .btn-cancel-edit-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #757575 0px,
                #757575 4px,
                rgba(117, 117, 117, 0.3) 4px,
                rgba(117, 117, 117, 0.3) 8px
            );
            transform: translateY(-1px);
        }

        /* Подвал модального окна */
        .modal-footer-improved {
            padding: 16px 28px;
            background: #f8f9ff;
            border-top: 1px solid #e8ecf5;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel-improved {
            background: repeating-linear-gradient(
                45deg,
                #e0e6f2 0px,
                #e0e6f2 4px,
                rgba(224, 230, 242, 0.3) 4px,
                rgba(224, 230, 242, 0.3) 8px
            );
            color: #555;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-cancel-improved:hover {
            background: repeating-linear-gradient(
                45deg,
                #d0d8ea 0px,
                #d0d8ea 4px,
                rgba(208, 216, 234, 0.3) 4px,
                rgba(208, 216, 234, 0.3) 8px
            );
            color: #333;
        }

        /* Пустой список */
        .empty-list-improved {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-list-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-list-text {
            font-size: 14px;
            margin: 0;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .modal-content-improved {
                width: 95% !important;
                margin: 10% auto !important;
            }

            .form-grid-2col {
                grid-template-columns: 1fr;
            }

            .modal-header-improved {
                padding: 16px;
            }

            .modal-body-improved {
                padding: 16px;
            }

            .modal-footer-improved {
                padding: 12px 16px;
            }
        }

    
        /* Выделение незакрытых смен и дней без работников - пастельный розовый с градиентом */
        .day-no-workers {
            background: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
        }

        .day-header.day-no-workers {
            background: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
        }

        /* Незакрытые смены перекрывают выходные дни с градиентом - более высокая специфичность */
        .data-cell.day-no-workers,
        .data-cell.weekend.day-no-workers {
            background: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
        }

        .hours-cell.day-no-workers,
        .hours-cell.weekend.day-no-workers {
            background: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
            background-image: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
        }

        .day-header.weekend.day-no-workers {
            background: repeating-linear-gradient(
                45deg,
                #FFE6F0 0px,
                #FFE6F0 4px,
                rgba(255, 230, 240, 0.3) 4px,
                rgba(255, 230, 240, 0.3) 8px
            ) !important;
        }
</style>

    <!-- Hidden fields for month/year management -->
    <input type="hidden" id="monthSelect" value="11">
    <input type="hidden" id="yearInput" value="2025">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; position: relative;">
            <div class="title" id="currentMonthDisplay" style="cursor: pointer;" onclick="openMonthYearModal()">
            ГРАФИК СОТРУДНИКОВ АПТЕКИ НА <span id="monthYearText">ДЕКАБРЬ 2025</span> Г.
        </div>
            <!-- Кнопка "Применить" скрыта, так как Firebase синхронизирует данные автоматически -->
            <!-- <button onclick="applyAndLoad()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)'">✓ Применить</button> -->
            </div>
        </div>
            
        <div id="monthYearModal" class="modal">
            <div class="modal-content" style="width: 400px; max-width: 95vw;">
                <div class="modal-title" style="padding: 20px 20px 0 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #2c3e50;">Выбор аптеки, месяца и года</div>
                    <span onclick="closeMonthYearModal()" style="cursor: pointer; font-size: 32px; color: #999; line-height: 1; transition: all 0.2s ease; padding: 5px; border-radius: 6px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.color='#333'; this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.color='#999'; this.style.backgroundColor='transparent'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 0 20px;">
                    <div style="margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Аптека:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <select id="pharmacyNumber" class="form-select" onchange="onGraphicPharmacySelect()" style="flex: 1; min-width: 0; padding: 12px 14px; border: 1px solid #000; border-radius: 0; font-size: 14px; transition: none; background: repeating-linear-gradient(45deg, #fafbff 0px, #fafbff 4px, rgba(250, 251, 255, 0.3) 4px, rgba(250, 251, 255, 0.3) 8px); box-sizing: border-box; color: #000;" onfocus="this.style.outline='none'; this.style.borderColor='#000'; this.style.boxShadow='none'; this.style.background='repeating-linear-gradient(45deg, #ffffff 0px, #ffffff 4px, rgba(255, 255, 255, 0.3) 4px, rgba(255, 255, 255, 0.3) 8px)'" onblur="this.style.borderColor='#000'; this.style.boxShadow='none'; this.style.background='repeating-linear-gradient(45deg, #fafbff 0px, #fafbff 4px, rgba(250, 251, 255, 0.3) 4px, rgba(250, 251, 255, 0.3) 8px)'">
                <option value="">-- Выберите аптеку --</option>
            </select>
                                <button type="button" onclick="changePharmacy(-1)" style="width: 30px; height: 30px; border: 1px solid #000; border-radius: 0; background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #000; transition: none;" onmouseover="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #e0e0e0 0px, #e0e0e0 4px, rgba(224, 224, 224, 0.3) 4px, rgba(224, 224, 224, 0.3) 8px)'" onmouseout="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px)'">▲</button>
                                <button type="button" onclick="changePharmacy(1)" style="width: 30px; height: 30px; border: 1px solid #000; border-radius: 0; background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #000; transition: none;" onmouseover="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #e0e0e0 0px, #e0e0e0 4px, rgba(224, 224, 224, 0.3) 4px, rgba(224, 224, 224, 0.3) 8px)'" onmouseout="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px)'">▼</button>
                </div>
            </div>
        </div>

                    <div style="margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Месяц и год</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <select id="monthYearSelectModal" style="flex: 1; min-width: 0; padding: 12px 14px; border: 1px solid #000; border-radius: 0; font-size: 14px; transition: none; background: repeating-linear-gradient(45deg, #fafbff 0px, #fafbff 4px, rgba(250, 251, 255, 0.3) 4px, rgba(250, 251, 255, 0.3) 8px); box-sizing: border-box; color: #000;" onfocus="this.style.outline='none'; this.style.borderColor='#000'; this.style.boxShadow='none'; this.style.background='repeating-linear-gradient(45deg, #ffffff 0px, #ffffff 4px, rgba(255, 255, 255, 0.3) 4px, rgba(255, 255, 255, 0.3) 8px)'" onblur="this.style.borderColor='#000'; this.style.boxShadow='none'; this.style.background='repeating-linear-gradient(45deg, #fafbff 0px, #fafbff 4px, rgba(250, 251, 255, 0.3) 4px, rgba(250, 251, 255, 0.3) 8px)'">
                        </select>
                                <button type="button" onclick="changeMonthYear(-1)" style="width: 30px; height: 30px; border: 1px solid #000; border-radius: 0; background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #000; transition: none;" onmouseover="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #e0e0e0 0px, #e0e0e0 4px, rgba(224, 224, 224, 0.3) 4px, rgba(224, 224, 224, 0.3) 8px)'" onmouseout="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px)'">▲</button>
                                <button type="button" onclick="changeMonthYear(1)" style="width: 30px; height: 30px; border: 1px solid #000; border-radius: 0; background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #000; transition: none;" onmouseover="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #e0e0e0 0px, #e0e0e0 4px, rgba(224, 224, 224, 0.3) 4px, rgba(224, 224, 224, 0.3) 8px)'" onmouseout="this.style.borderColor='#000'; this.style.background='repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px)'">▼</button>
                    </div>
                    </div>
                </div>
                </div>
                <div class="modal-buttons" style="justify-content: flex-end;">
                    <button onclick="applyMonthYear()" class="btn-submit">Применить</button>
                    <button onclick="closeMonthYearModal()" class="btn-cancel">Отмена</button>
                </div>
            </div>
        </div>

        <div id="addEmployeeModal" class="modal">
            <div class="modal-content" style="width: 550px; max-width: 95vw;">
                <div class="modal-title" id="modalTitle">Добавить сотрудника</div>
                <div class="modal-body">
                <div class="form-group required">
                    <label class="form-label">Ф.И.О. сотрудника:</label>
                    <select id="modalName" class="form-select" onchange="onEmployeeSelect();">
                        <option value="">-- Выберите сотрудника --</option>
                    </select>
                    <input type="hidden" id="modalRealName" value="">
                    <input type="hidden" id="modalIsSubcontractorHidden" value="false">
                </div>
                <div class="form-group required">
                    <label class="form-label">Должность:</label>
                    <input type="text" id="modalPosition" class="form-input" readonly style="background-color: #f9f9f9;">
                </div>
                <div class="form-group" id="scheduleContainer">
                    <label class="form-label">График сменности:</label>
                    <select id="modalSchedule" class="form-select" onchange="updateDefaultHours(); toggleFields();">
                        <option value="">-- Выберите график --</option>
                        <option value="5/2">5/2</option>
                        <option value="2/2">2/2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Начало работы (час):</label>
                    <input type="number" id="modalStartHour" class="form-input" placeholder="9" min="0" max="24">
                </div>
                <div class="form-group">
                    <label class="form-label">Окончание работы (час):</label>
                    <input type="number" id="modalEndHour" class="form-input" placeholder="21" min="0" max="24">
                </div>
                <div class="form-group" id="startDayContainer">
                    <label class="form-label">С какого дня месяца начинается этот график:</label>
                    <input type="number" id="modalStartDay" class="form-input" placeholder="1" min="1" max="31">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-submit" id="btnSaveEmployee" type="button">Добавить</button>
                    <button class="btn-delete" id="btnDeleteEmployee" type="button" style="display: none;">Удалить</button>
                    <button class="btn-cancel" type="button" onclick="closeModal()">Отмена</button>
                </div>
            </div>
        </div>

        <div id="cellEditModal" class="cell-edit-modal">
            <div class="cell-edit-content">
                <div class="cell-edit-title">День <span id="cellEditDay"></span></div>
                
                <div class="cell-edit-form-group">
                    <label class="cell-edit-label">Начало дня:</label>
                    <input type="number" id="cellEditStart" class="cell-edit-input" placeholder="9" min="0" max="24">
                </div>
                
                <div class="cell-edit-form-group">
                    <label class="cell-edit-label">Конец дня:</label>
                    <input type="number" id="cellEditEnd" class="cell-edit-input" placeholder="21" min="0" max="24">
                </div>
                
                <div class="cell-edit-buttons">
                    
                    <button class="btn-save-cell" type="button" onclick="saveCellEdit()">Сохранить</button>
                    <button class="btn-cancel-cell" type="button" onclick="closeCellEdit()">Отмена</button>
                </div>
            </div>
        </div>

        <div id="calendarModal" class="calendar-modal">
            <div class="calendar-content">
                <div class="calendar-title">Календарь смен - <span id="calendarEmployeeName"></span></div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-buttons">
                    <button class="btn-calendar-save" type="button" onclick="saveCalendarModal()">Сохранить</button>
                    <button class="btn-calendar-cancel" type="button" onclick="closeCalendarModal()">Отмена</button>
                </div>
            </div>
        </div>

        <div class="schedule-wrapper">
            <table class="schedule-table" id="scheduleTable">
                <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>

        <div class="controls-bottom">
            <div class="controls-bottom-left">
                <button class="btn-add" onclick="openModal()">+ Сотрудник</button>
                <button class="btn-add" onclick="openAbsenceModal()">+ Больничный/Отпуск</button>
            </div>
            <div class="controls-bottom-right">
                <button class="btn-export" onclick="exportToExcel()">📊 Экспорт в Excel</button>
                <button class="sidebar-toggle-btn sidebar-toggle-inline" id="toggleBtn" onclick="openSidebar()" title="Открыть справочники">📚</button>
            </div>
        </div>


        <div id="message" class="message"></div>
    </div>

    <!-- Подключение библиотеки ExcelJS для полной поддержки стилей -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script>
    // Проверяем загрузку библиотеки ExcelJS
    window.addEventListener('DOMContentLoaded', function() {
        // Даем время на загрузку скрипта
        setTimeout(function() {
            if (typeof ExcelJS !== 'undefined') {
                console.log('✅ ExcelJS библиотека успешно загружена и готова к использованию');
                // Обновляем статус кнопки экспорта
                const exportBtn = document.querySelector('.btn-export');
                if (exportBtn) {
                    exportBtn.style.opacity = '1';
                    exportBtn.title = 'Экспорт в Excel';
                }
            } else {
                console.warn('⚠️ ExcelJS библиотека не загружена. Функция экспорта будет недоступна.');
                const exportBtn = document.querySelector('.btn-export');
                if (exportBtn) {
                    exportBtn.style.opacity = '0.5';
                    exportBtn.title = 'Библиотека ExcelJS не загружена. Обновите страницу.';
                }
            }
        }, 500);
    });
    </script>
    <script>
    // --- Auto Resize Logic (V3) ---
    function getTextWidth(text, font) {
        const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
        const context = canvas.getContext("2d");
        context.font = font;
        const metrics = context.measureText(text);
        return metrics.width;
    }

    function resizeElement(el) {
        if (!el) return;

        let text = '';
        let style = window.getComputedStyle(el);
        let font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;

        // Base padding (horizontal) + borders
        // header-input has padding: 6px 10px -> 20px total
        // border: 2px total
        // Total static: 22px

        let extra = 25; 

        if (el.tagName === 'SELECT') {
            if (el.selectedIndex >= 0) {
                text = el.options[el.selectedIndex].text;
            } else {
                text = '-- Выберите аптеку --';
            }
            extra = 45; // More for arrow
        } else if (el.tagName === 'INPUT') {
            text = el.value || el.placeholder;
            extra = 25; 
        }

        const width = Math.ceil(getTextWidth(text, font) + extra);
        el.style.width = width + 'px';
    }

    function updateHeaderInputs() {
        resizeElement(document.getElementById('pharmacyNumber'));
        resizeElement(document.getElementById('pharmacyAddress'));
    }

    // Listeners
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderInputs();

        const ph = document.getElementById('pharmacyNumber');
        if(ph) {
            ph.addEventListener('change', updateHeaderInputs);
            // Also listen for mouse interaction just in case
            ph.addEventListener('blur', updateHeaderInputs);
        }
    });
    // --- End Auto Resize ---

</script>
    <script>
        // ================= FIREBASE INITIALIZATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyCnltG-ciUwtpZhFaAhTzLI_cjtVZURgEo",
            authDomain: "grafiki-aptek.firebaseapp.com",
            projectId: "grafiki-aptek",
            storageBucket: "grafiki-aptek.firebasestorage.app",
            messagingSenderId: "372041187072",
            appId: "1:372041187072:web:14b4326e85d3f347523de5",
            measurementId: "G-2KTEGH1MFK",
            databaseURL: "https://grafiki-aptek-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase wrapper functions to replace localStorage
        let firebaseListeners = {}; // Track active listeners

        // Set data to Firebase (replaces localStorage.setItem)
        async function firebaseSetItem(key, value) {
            try {
                const ref = database.ref('appData/' + key);
                await ref.set(value);
                console.log('✅ Firebase: сохранено', key);
                return true;
            } catch (error) {
                console.error('❌ Firebase setItem error:', error);
                // Fallback to localStorage if Firebase fails
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    console.log('⚠️ Fallback to localStorage:', key);
                } catch (e) {
                    console.error('❌ localStorage также не работает:', e);
                }
                return false;
            }
        }

        // Get data from Firebase (replaces localStorage.getItem)
        async function firebaseGetItem(key) {
            try {
                const ref = database.ref('appData/' + key);
                const snapshot = await ref.once('value');
                const result = snapshot.exists() ? snapshot.val() : null;
                if (result) {
                    console.log('✅ Firebase: загружено', key);
                }
                return result;
            } catch (error) {
                console.error('❌ Firebase getItem error:', error);
                // Fallback to localStorage if Firebase fails
                try {
                    const item = localStorage.getItem(key);
                    if (item) {
                        console.log('⚠️ Fallback to localStorage:', key);
                        return JSON.parse(item);
                    }
                } catch (e) {
                    console.error('❌ localStorage также не работает:', e);
                }
                return null;
            }
        }

        // Remove data from Firebase (replaces localStorage.removeItem)
        async function firebaseRemoveItem(key) {
            try {
                const ref = database.ref('appData/' + key);
                await ref.remove();
                return true;
            } catch (error) {
                console.error('Firebase removeItem error:', error);
                // Fallback to localStorage if Firebase fails
                localStorage.removeItem(key);
                return false;
            }
        }

        // Listen to Firebase changes (real-time sync)
        function firebaseOnValue(key, callback) {
            try {
                const ref = database.ref('appData/' + key);
                const listener = ref.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        callback(snapshot.val());
                    } else {
                        callback(null);
                    }
                });
                
                // Store listener for cleanup
                if (!firebaseListeners[key]) {
                    firebaseListeners[key] = [];
                }
                firebaseListeners[key].push(listener);
                
                return listener;
            } catch (error) {
                console.error('Firebase onValue error:', error);
                return null;
            }
        }

        // Stop listening to Firebase changes
        function firebaseOffValue(key, listener) {
            try {
                const ref = database.ref('appData/' + key);
                if (listener) {
                    ref.off('value', listener);
                } else {
                    // Remove all listeners for this key
                    if (firebaseListeners[key]) {
                        firebaseListeners[key].forEach(l => ref.off('value', l));
                        firebaseListeners[key] = [];
                    }
                }
            } catch (error) {
                console.error('Firebase offValue error:', error);
            }
        }

        // Setup real-time listeners for synchronization
        function setupFirebaseListeners() {
            // Listen to schedule data changes
            const scheduleKey = getScheduleKey(currentYear, currentMonth, currentPharmacyId);
            firebaseOnValue(scheduleKey, (data) => {
                if (data && data.employees) {
                    const loadedEmployees = Array.isArray(data.employees) ? data.employees : [];
                    // Убеждаемся, что поле isSubcontractor явно установлено для всех сотрудников
                    employees = loadedEmployees.map(emp => {
                        // КРИТИЧНО: Проверяем наличие поля isSubcontractor
                        let isSubcontractorValue = false;
                        if ('isSubcontractor' in emp) {
                            // Поддерживаем разные форматы: число (1/0), булево (true/false), строка ('true'/'false')
                            isSubcontractorValue = emp.isSubcontractor === 1 || 
                                                  emp.isSubcontractor === true || 
                                                  emp.isSubcontractor === 'true' || 
                                                  emp.isSubcontractor === '1';
                        } else {
                            // Поля нет - возможно Firebase удалил его, проверяем по другим признакам
                            console.warn('⚠️ Поле isSubcontractor отсутствует для сотрудника:', emp.name);
                            // Если у сотрудника нет графика, возможно это подработчик
                            if (!emp.schedule && !emp.scheduleStartDay) {
                                isSubcontractorValue = true;
                                console.log('  → Определен как подработчик по отсутствию графика');
                            }
                        }
                        
                        return {
                            id: emp.id,
                            position: emp.position || '',
                            name: emp.name || '',
                            startHour: emp.startHour !== undefined ? emp.startHour : null,
                            endHour: emp.endHour !== undefined ? emp.endHour : null,
                            schedule: emp.schedule !== undefined ? emp.schedule : null,
                            scheduleStartDay: emp.scheduleStartDay !== undefined ? emp.scheduleStartDay : null,
                            isSubcontractor: isSubcontractorValue, // Явно устанавливаем булево значение
                            dayOverrides: emp.dayOverrides || {}
                        };
                    });
                    console.log('🔄 Firebase listener: обновлено сотрудников:', employees.length);
                    const subcontractorsCount = employees.filter(emp => emp.isSubcontractor === true || emp.isSubcontractor === 1).length;
                    if (subcontractorsCount > 0) {
                        console.log('  - Подработчиков:', subcontractorsCount);
                        employees.forEach(emp => {
                            if (emp.isSubcontractor === true || emp.isSubcontractor === 1) {
                                console.log('    ✓', emp.name, '(значение:', emp.isSubcontractor, ')');
                            }
                        });
                    } else {
                        console.warn('⚠️ Firebase listener: подработчиков не найдено!');
                    }
                    if (typeof renderSchedule === 'function') renderSchedule();
                }
            });

            // Listen to reference data changes
            let lastReferenceDataHash = null;
            firebaseOnValue('scheduleReferenceData', (data) => {
                if (data) {
                    const refData = typeof data === 'string' ? JSON.parse(data) : data;
                    const currentHash = JSON.stringify(refData);
                    
                    // Проверяем, действительно ли данные изменились
                    if (currentHash === lastReferenceDataHash) {
                        return; // Данные не изменились, пропускаем обновление
                    }
                    
                    pharmacyReference = refData.pharmacyReference || [];
                    employeeReference = refData.employeeReference || [];
                    lastReferenceDataHash = currentHash;
                    
                    if (typeof updateGraphicPharmacySelect === 'function') updateGraphicPharmacySelect();
                    if (typeof updateRefPharmacySelect === 'function') updateRefPharmacySelect();
                    if (typeof updateGraphicEmployeeSelect === 'function') updateGraphicEmployeeSelect();
                }
            });

            // Listen to absence data changes
            // Используем debounce и проверку изменений, чтобы избежать мигания
            let absenceDataUpdateTimeout = null;
            let lastAbsenceDataString = JSON.stringify(absenceData || {});
            let isFirstAbsenceDataLoad = true;
            
            firebaseOnValue('absenceData', (data) => {
                if (data) {
                    const newAbsenceData = typeof data === 'string' ? JSON.parse(data) : data;
                    const newAbsenceDataString = JSON.stringify(newAbsenceData);
                    
                    // Проверяем, действительно ли данные изменились
                    if (newAbsenceDataString === lastAbsenceDataString) {
                        return; // Данные не изменились, пропускаем обновление
                    }
                    
                    // При первой загрузке обновляем сразу (без debounce)
                    if (isFirstAbsenceDataLoad) {
                        absenceData = newAbsenceData;
                        lastAbsenceDataString = newAbsenceDataString;
                        isFirstAbsenceDataLoad = false;
                        return;
                    }
                    
                    // Очищаем предыдущий таймер
                    if (absenceDataUpdateTimeout) {
                        clearTimeout(absenceDataUpdateTimeout);
                    }
                    
                    // Используем debounce для предотвращения частых обновлений при редактировании
                    absenceDataUpdateTimeout = setTimeout(() => {
                        absenceData = newAbsenceData;
                        lastAbsenceDataString = newAbsenceDataString;
                        
                        // Обновляем только если таблица уже отрисована
                        // Не вызываем renderSchedule(), чтобы избежать мигания
                        // Данные об отсутствиях будут использоваться при следующей перерисовке
                    }, 500); // Задержка 500мс для debounce (увеличена для более плавной работы)
                } else {
                    // Если данных нет, обновляем сразу (без debounce)
                    if (absenceDataUpdateTimeout) {
                        clearTimeout(absenceDataUpdateTimeout);
                        absenceDataUpdateTimeout = null;
                    }
                    absenceData = {};
                    lastAbsenceDataString = JSON.stringify({});
                    isFirstAbsenceDataLoad = false;
                }
            });

            // Listen to days off changes
            const daysOffKey = 'daysOff_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            firebaseOnValue(daysOffKey, (data) => {
                if (data) {
                    daysOff = Array.isArray(data) ? data : [];
                } else {
                    daysOff = [];
                }
            });

            console.log('✅ Firebase listeners установлены');
        }

        // ================= END FIREBASE INITIALIZATION =================

        const daysOfWeek = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'];
        let employees = [];
        // Восстанавливаем сохранённый месяц и год (или используем текущие)
        // Инициализируем значениями по умолчанию сразу
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentPharmacyId = '--';

        // Инициализация: загружаем из Firebase или используем текущую дату
        async function initializeVariables() {
            const savedMonth = await firebaseGetItem('savedCurrentMonth');
            const savedYear = await firebaseGetItem('savedCurrentYear');
            const savedPharmacy = await firebaseGetItem('savedCurrentPharmacyId');

            if (savedMonth !== null) currentMonth = parseInt(savedMonth);
            if (savedYear !== null) currentYear = parseInt(savedYear);
            if (savedPharmacy !== null) currentPharmacyId = savedPharmacy;
        }

        // Инициализация будет вызвана в DOMContentLoaded

        // Инициализация выходных дней из Firebase
        let daysOff = [];
        async function initializeDaysOff() {
            const key = 'daysOff_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            const saved = await firebaseGetItem(key);
            if (saved) {
                daysOff = Array.isArray(saved) ? saved : [];
            } else {
                daysOff = [];
            }
        }

        // Сохранение выходных дней в Firebase
        async function saveDaysOffToStorage() {
            if (!currentPharmacyId || currentPharmacyId === '--') return;
            const key = 'daysOff_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            if (daysOff.length > 0) {
                await firebaseSetItem(key, daysOff);
            } else {
                await firebaseRemoveItem(key);
            }
        }

        
function getScheduleKey(year, month, pharmacyId) {
    return 'scheduleData_' + (pharmacyId || 'default') + '_' + year + '_' + month;
}

async function loadScheduleFor(year, month, pharmacyId) {
    const key = getScheduleKey(year, month, pharmacyId);
    const savedScheduleData = await firebaseGetItem(key);
    if (savedScheduleData) {
        try {
            const data = typeof savedScheduleData === 'string' ? JSON.parse(savedScheduleData) : savedScheduleData;
            const rawEmployees = Array.isArray(data.employees) ? data.employees : [];
            
            // Логирование сырых данных из Firebase
            console.log('🔍 Загружены сырые данные из Firebase:');
            console.log('  - Всего сотрудников в данных:', rawEmployees.length);
            rawEmployees.forEach((emp, idx) => {
                console.log(`  - Сотрудник ${idx + 1} (сырой):`, {
                    name: emp.name,
                    isSubcontractor: emp.isSubcontractor,
                    type: typeof emp.isSubcontractor,
                    hasField: 'isSubcontractor' in emp,
                    allKeys: Object.keys(emp)
                });
            });
            
            // Убеждаемся, что поле isSubcontractor явно установлено для всех сотрудников при загрузке
            employees = rawEmployees.map(emp => {
                // КРИТИЧНО: Проверяем наличие поля isSubcontractor в сырых данных
                let isSubcontractorValue = false;
                if ('isSubcontractor' in emp) {
                    // Поле есть - используем его значение
                    isSubcontractorValue = emp.isSubcontractor === true || emp.isSubcontractor === 'true' || emp.isSubcontractor === 1;
                } else {
                    // Поля нет - возможно Firebase удалил его, проверяем по другим признакам
                    console.warn('⚠️ Поле isSubcontractor отсутствует для сотрудника:', emp.name);
                    // Если у сотрудника нет графика, возможно это подработчик
                    if (!emp.schedule && !emp.scheduleStartDay) {
                        isSubcontractorValue = true;
                        console.log('  → Определен как подработчик по отсутствию графика');
                    }
                }
                
                // Явно создаем объект со всеми полями
                const processedEmp = {
                    id: emp.id,
                    position: emp.position || '',
                    name: emp.name || '',
                    startHour: emp.startHour !== undefined ? emp.startHour : null,
                    endHour: emp.endHour !== undefined ? emp.endHour : null,
                    schedule: emp.schedule !== undefined ? emp.schedule : null,
                    scheduleStartDay: emp.scheduleStartDay !== undefined ? emp.scheduleStartDay : null,
                    isSubcontractor: isSubcontractorValue, // Явно устанавливаем булево значение
                    dayOverrides: emp.dayOverrides || {}
                };
                return processedEmp;
            });
            
            // Отладка: проверяем подработчиков после загрузки
            const subcontractorsCount = employees.filter(emp => emp.isSubcontractor === true || emp.isSubcontractor === 1).length;
            if (subcontractorsCount > 0) {
                console.log('📥 Загружено подработчиков:', subcontractorsCount, 'из', employees.length, 'сотрудников');
                employees.forEach(emp => {
                    if (emp.isSubcontractor === true || emp.isSubcontractor === 1) {
                        console.log('  - Подработчик:', emp.name, 'isSubcontractor:', emp.isSubcontractor, '(тип:', typeof emp.isSubcontractor, ')');
                    }
                });
            } else if (employees.length > 0) {
                console.log('⚠️ Загружено сотрудников:', employees.length, 'но подработчиков не найдено');
                employees.forEach(emp => {
                    console.log('  - Сотрудник:', emp.name, 'isSubcontractor:', emp.isSubcontractor, '(тип:', typeof emp.isSubcontractor, ')');
                });
            }
        } catch (e) { 
            console.error('Ошибка загрузки графика:', e);
            employees = []; 
        }
    } else { employees = []; }
}

function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(month, year) {
            return new Date(year, month, 1).getDay();
        }

        function getMonthName(month) {
            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                          'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            return months[month];
        }

        function updateMonthDisplay() {
            const monthName = getMonthName(currentMonth).toUpperCase();
            const el = document.getElementById('monthYearText');
            if (el) el.textContent = `${monthName} ${currentYear}`;
        }

        function cleanUpDayOverrides(employee) {
        if (!employee.dayOverrides) return;

        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        const cleanOverrides = {};

        // Оставляем только те дни, которые есть в текущем месяце
        for (let day = 1; day <= daysInMonth; day++) {
            if (employee.dayOverrides[day] !== undefined) {
                cleanOverrides[day] = employee.dayOverrides[day];
            }
        }

        // Удаляем все остальные дни (из других месяцев)
        employee.dayOverrides = cleanOverrides;
    }

    async function changeMonth() {
    const month = parseInt(document.getElementById('monthSelect').value, 10);
    const year = parseInt(document.getElementById('yearInput').value, 10);
    await saveData();
    currentMonth = month;
    currentYear = year;
    await firebaseSetItem('savedCurrentMonth', currentMonth.toString());
    await firebaseSetItem('savedCurrentYear', currentYear.toString());
    await loadScheduleFor(currentYear, currentMonth, currentPharmacyId);
    await loadOffDaysStorage();
    if (typeof updateMonthDisplay === 'function') updateMonthDisplay();
    if (typeof renderSchedule === 'function') renderSchedule();
    if (typeof showMessage === 'function') showMessage(getMonthName(currentMonth) + ' ' + currentYear + ' загружен!');
}

        let editingCellData = null;
        let calendarEditingId = null;
        let calendarShiftDays = {};

        function getDayOfWeek(day) {
            const date = new Date(currentYear, currentMonth, day);
            let dayNum = date.getDay();
            return (dayNum === 0) ? 6 : dayNum - 1;
        }

        function isWeekend(day) {
            const dow = getDayOfWeek(day);
            return dow === 5 || dow === 6;
        }

        function parseSchedule(scheduleStr) {
            if (!scheduleStr) return null;
            const parts = scheduleStr.split('/');
            if (parts.length === 2) {
                return {
                    workDays: parseInt(parts[0]),
                    offDays: parseInt(parts[1])
                };
            }
            return null;
        }

function isStandardWorkDay(employee, day) {
    if (!employee.schedule) return null;
    const schedule = parseSchedule(employee.schedule);
    if (!schedule) return null;

    let startDay = employee.scheduleStartDay || 1;
    // Fix for days before startDay
    if (day < startDay) {
        if (schedule.workDays === 5 && schedule.offDays === 2) {
             return isWeekend(day) ? false : null;
        }
        return null;
    }

    if (schedule.workDays === 5 && schedule.offDays === 2) {
        return !isWeekend(day);
    }

    const dayInCycle = (day - startDay) % (schedule.workDays + schedule.offDays);
    return dayInCycle < schedule.workDays;
}

function isEmployeeWorkDay(employee, day) {
    // Check overrides first
    if (employee.dayOverrides && employee.dayOverrides[day] !== undefined) {
        if (employee.dayOverrides[day] === "") return false; // Forced OFF
        return true; // Forced ON
    }
    // Fallback to standard
    return isStandardWorkDay(employee, day);
}

        function calculateTotalHours(employee) {
            let total = 0;
            for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                const overrides = employee.dayOverrides || {};
                const dayValue = overrides[day];
                
                if (dayValue !== undefined) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        const hours = end - start - 1;
                        total += hours < 0 ? (hours + 24) : hours;
                    }
                } else {
                    const isWork = isEmployeeWorkDay(employee, day);
                    if (isWork === true) {
                        const hours = employee.endHour - employee.startHour - 1;
                        total += hours < 0 ? (hours + 24) : hours;
                    }
                }
            }
            return total;
        }

        function calculateTotalShifts(employee) {
            let total = 0;
            for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                const dayValue = getDisplayValue(employee, day);
                if (dayValue) {
                    total++;
                }
            }
            return total;
        }

        function updateDefaultHours() {
            const schedule = document.getElementById('modalSchedule').value;
            if (schedule === '5/2') {
                document.getElementById('modalStartHour').value = '9';
                document.getElementById('modalEndHour').value = '18';
            } else if (schedule === '2/2') {
                document.getElementById('modalStartHour').value = '9';
                document.getElementById('modalEndHour').value = '21';
            }
        }

        function openCalendarModal(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            calendarEditingId = employeeId;
            calendarShiftDays = {};

            // ЗАГРУЖАЕМ СОХРАНЕННЫЕ ДАННЫЕ
            if (employee.dayOverrides) {
                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    if (employee.dayOverrides[day]) {
                        // Если есть override (любое значение), то день работы
                        calendarShiftDays[day] = true;
                    } else {
                        // Иначе проверяем стандартный график
                        const isWork = isEmployeeWorkDay(employee, day);
                        if (isWork === true) {
                            calendarShiftDays[day] = true;
                        }
                    }
                }
            } else {
                // Если нет dayOverrides, загружаем по стандартному графику
                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    const isWork = isEmployeeWorkDay(employee, day);
                    if (isWork === true) {
                        calendarShiftDays[day] = true;
                    }
                }
            }

            document.getElementById('calendarEmployeeName').textContent = employee.name;
            renderCalendar();
            document.getElementById('calendarModal').style.display = 'block';
        }
        function toggleCalendarDay(day) {
            if (calendarShiftDays[day]) {
                delete calendarShiftDays[day];
            } else {
                calendarShiftDays[day] = true;
            }
            renderCalendar();
        }

function saveCalendarChanges() {
    const employee = employees.find(e => e.id === calendarEditingId);
    if (!employee) return;

    if (!employee.dayOverrides) {
        employee.dayOverrides = {};
    }

    const daysInMonth = getDaysInMonth(currentMonth, currentYear);

    for (let day = 1; day <= daysInMonth; day++) {
        const isStandard = isStandardWorkDay(employee, day);
        const isSelected = calendarShiftDays[day] === true;

        if (isSelected) {
            if (!isStandard) {
                // Add shift to standard off day
                employee.dayOverrides[day] = employee.startHour + "-" + employee.endHour;
            } else {
                // Standard work day selected -> remove override if it exists
                if (employee.dayOverrides[day] !== undefined) delete employee.dayOverrides[day];
            }
        } else {
            if (isStandard) {
                // Standard work day NOT selected -> force OFF
                employee.dayOverrides[day] = "";
            } else {
                // Standard off day NOT selected -> remove override if it exists
                if (employee.dayOverrides[day] !== undefined) delete employee.dayOverrides[day];
            }
        }
    }

    closeCalendarModal();
    saveData().then(() => {
    renderSchedule();
    showMessage("График обновлен");
    });
}

        function saveCalendarModal() {
            const employee = employees.find(e => e.id === calendarEditingId);
            if (!employee) return;

            // Сохраняем dayOverrides на основе текущего выбора в calendarShiftDays
            for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                const isWorkDay = calendarShiftDays[day] === true;

                if (isWorkDay) {
                    if (!employee.dayOverrides) {
                        employee.dayOverrides = {};
                    }
                    employee.dayOverrides[day] = 'W';
                } else {
                    if (employee.dayOverrides) {
                        delete employee.dayOverrides[day];
                    }
                }
            }

            saveDataToLocalStorage();
            closeCalendarModal();
            renderScheduleTable();
            showMessage('График сохранен успешно!', 'success');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').style.display = 'none';
            calendarEditingId = null;
            calendarShiftDays = {};
        }

        function openCellEditModal(employeeId, day) {
            // Проверяем наличие отпуска/больничного на эту дату
            const employeeName = employees.find(e => e.id === employeeId)?.name;
            if (employeeName && absenceData[employeeName]) {
                const month = currentMonth;
                const year = currentYear;
                const checkDate = new Date(year, month, day);

                for (let i = 0; i < absenceData[employeeName].length; i++) {
                    const absence = absenceData[employeeName][i];
                    const startDate = new Date(absence.startDate);
                    const endDate = new Date(absence.endDate);

                    if (checkDate >= startDate && checkDate <= endDate) {
                        // Отпуск найден - показываем модальное окно для удаления
                        const symbol = absence.type === 'vacation' ? 'отпуск' : 'больничный';
                        showDeleteAbsenceDialog(employeeName, i, symbol);
                        return;
                    }
                }
            }

            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            editingCellData = {
                employeeId: employeeId,
                day: day
            };

            const overrides = employee.dayOverrides || {};
            let startHour = '';
            let endHour = '';

            if (overrides[day]) {
                const parts = overrides[day].split('-');
                startHour = parts[0] || '';
                endHour = parts[1] || '';
            } else {
                const isWork = isEmployeeWorkDay(employee, day);
                if (isWork === true) {
                    startHour = employee.startHour;
                    endHour = employee.endHour;
                }
            }

            document.getElementById('cellEditDay').textContent = day;
            document.getElementById('cellEditStart').value = startHour;
            document.getElementById('cellEditEnd').value = endHour;
            document.getElementById('cellEditModal').style.display = 'block';
            document.getElementById('cellEditStart').focus();
        }

        function saveCellEdit() {
            if (!editingCellData) return;

            const employee = employees.find(e => e.id === editingCellData.employeeId);
            if (!employee) return;

            if (!employee.dayOverrides) {
                employee.dayOverrides = {};
            }

            const startVal = document.getElementById('cellEditStart').value.trim();
            const endVal = document.getElementById('cellEditEnd').value.trim();

            if (startVal && endVal) {
                employee.dayOverrides[editingCellData.day] = `${startVal}-${endVal}`;
            } else {
                delete employee.dayOverrides[editingCellData.day];
            }

            closeCellEdit();
            saveData().then(() => {
            renderSchedule();
            });
        }

        function closeCellEdit() {
            document.getElementById('cellEditModal').style.display = 'none';
            editingCellData = null;
        }

function deleteShift(employeeId, day) {
    const employee = employees.find(e => e.id === employeeId);
    if (!employee) return;
    if (!employee.dayOverrides) {
        employee.dayOverrides = {};
    }
    // FIX: Set to empty string instead of delete to force override
    employee.dayOverrides[day] = ""; 
    saveData().then(() => {
    renderSchedule();
    showMessage("Смена удалена");
    });
}

        function addShift(employeeId, day) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            if (!employee.dayOverrides) {
                employee.dayOverrides = {};
            }

            if (employee.startHour && employee.endHour) {
                employee.dayOverrides[day] = `${employee.startHour}-${employee.endHour}`;
                saveData().then(() => {
                renderSchedule();
                showMessage('Смена добавлена!');
                });
            } else {
                openCellEditModal(employeeId, day);
            }
        }

        function toggleFields() {
            // Получаем isSubcontractor из скрытого поля
            const isSubcontractorInput = document.getElementById('modalIsSubcontractorHidden');
            const isSubcontractor = isSubcontractorInput ? isSubcontractorInput.value === 'true' : false;
            const position = document.getElementById('modalPosition').value;
            const schedule = document.getElementById('modalSchedule').value;

            const scheduleContainer = document.getElementById('scheduleContainer');
            const startDayContainer = document.getElementById('startDayContainer');

            // Если подработчик - скрывать оба поля
            if (isSubcontractor) {
                scheduleContainer.style.display = 'none';
                startDayContainer.style.display = 'none';
            } 
            // Если график 2/2 - ВСЕГДА показывать "С какого дня месяца" (независимо от должности!)
            else if (schedule === '2/2') {
                scheduleContainer.style.display = 'block';
                startDayContainer.style.display = 'block';
            }
            // Если должность ЗАУ и график 5/2 - скрывать только "С какого дня месяца"
            else if (position === 'ЗАУ') {
                scheduleContainer.style.display = 'block';
                startDayContainer.style.display = 'none';
            } 
            // Остальные должности с графиком 5/2 - показывать оба
            else {
                scheduleContainer.style.display = 'block';
                startDayContainer.style.display = 'block';
            }
        }

        // Делаем openModal доступной глобально
        window.openModal = function(employeeId = null) {
            editingEmployeeId = employeeId;
            const modal = document.getElementById('addEmployeeModal');
            const modalTitle = document.getElementById('modalTitle');
            const btnSave = document.getElementById('btnSaveEmployee');
            const btnDelete = document.getElementById('btnDeleteEmployee');

            document.getElementById('modalPosition').value = '';
            document.getElementById('modalSchedule').value = '';
            document.getElementById('modalStartHour').value = '';
            document.getElementById('modalEndHour').value = '';
            document.getElementById('modalStartDay').value = '';
            const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
            if (isSubcontractorHidden) {
                isSubcontractorHidden.value = 'false';
            }
            document.getElementById('modalRealName').value = '';

            if (employeeId) {
                const employee = employees.find(e => e.id === employeeId);
                if (employee) {
                    modalTitle.textContent = 'Редактировать сотрудника';
                    
                    // Сначала устанавливаем имя в скрытое поле
                    document.getElementById('modalRealName').value = employee.name;
                    
                    // Ищем сотрудника в справочнике по имени и должности
                    const refEmployee = employeeReference.find(e => 
                        e.name === employee.name && 
                        e.position === employee.position
                    );
                    
                    const modalNameSelect = document.getElementById('modalName');
                    
                    // Обновляем список сотрудников в select
                    if (typeof updateGraphicEmployeeSelect === 'function') {
                        updateGraphicEmployeeSelect();
                    }
                    
                    // Используем setTimeout чтобы убедиться, что select обновлен
                    setTimeout(() => {
                        if (refEmployee) {
                            // Если нашли в справочнике, устанавливаем ID из справочника
                            modalNameSelect.value = refEmployee.id;
                            
                            // Если значение не установилось, ищем опцию вручную
                            if (modalNameSelect.value !== refEmployee.id) {
                                for (let i = 0; i < modalNameSelect.options.length; i++) {
                                    if (modalNameSelect.options[i].value === refEmployee.id) {
                                        modalNameSelect.selectedIndex = i;
                                        break;
                                    }
                                }
                            }
                            
                            // Сохраняем имя перед вызовом onEmployeeSelect
                            const savedName = employee.name;
                            // Вызываем onEmployeeSelect для заполнения остальных полей из справочника
                            if (typeof onEmployeeSelect === 'function') {
                                onEmployeeSelect();
                            }
                            // Восстанавливаем имя сотрудника (на случай если onEmployeeSelect его очистил)
                            document.getElementById('modalRealName').value = savedName;
                            
                            // Принудительно устанавливаем значение еще раз
                            modalNameSelect.value = refEmployee.id;
                        } else {
                            // Если не нашли в справочнике, добавляем опцию с именем сотрудника
                            // Проверяем, нет ли уже такой опции
                            let optionExists = false;
                            let optionIndex = -1;
                            for (let i = 0; i < modalNameSelect.options.length; i++) {
                                if (modalNameSelect.options[i].textContent === employee.name || 
                                    modalNameSelect.options[i].value === employee.name) {
                                    optionIndex = i;
                                    optionExists = true;
                                    break;
                                }
                            }
                            
                            if (!optionExists) {
                                // Создаем опцию с именем сотрудника и добавляем в начало списка
                                const option = document.createElement('option');
                                option.value = employee.name;
                                option.textContent = employee.name;
                                // Вставляем после первого option (-- Выберите сотрудника --)
                                if (modalNameSelect.options.length > 0) {
                                    modalNameSelect.insertBefore(option, modalNameSelect.options[1]);
                                    optionIndex = 1;
                                } else {
                                    modalNameSelect.appendChild(option);
                                    optionIndex = 0;
                                }
                            }
                            
                            // Устанавливаем выбранную опцию
                            if (optionIndex >= 0) {
                                modalNameSelect.selectedIndex = optionIndex;
                                modalNameSelect.value = employee.name;
                            }
                            
                            // Убеждаемся, что имя установлено
                            document.getElementById('modalRealName').value = employee.name;
                        }
                    }, 100);
                    
                    // Заполняем поля из данных сотрудника из графика (они могут отличаться от справочника)
                    document.getElementById('modalPosition').value = employee.position;
                    document.getElementById('modalSchedule').value = employee.schedule || '';
                    document.getElementById('modalStartHour').value = employee.startHour || '';
                    document.getElementById('modalEndHour').value = employee.endHour || '';
                    document.getElementById('modalStartDay').value = employee.scheduleStartDay || '';
                    const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
                    if (isSubcontractorHidden) {
                        isSubcontractorHidden.value = (employee.isSubcontractor || false) ? 'true' : 'false';
                    }
                    
                    btnSave.textContent = 'Сохранить';
                    btnDelete.style.display = 'block';
                }
            } else {
                // Обновляем список сотрудников в select для добавления нового
                if (typeof updateGraphicEmployeeSelect === 'function') {
                    updateGraphicEmployeeSelect();
                }
                document.getElementById('modalName').value = '';
                document.getElementById('modalRealName').value = '';
                document.getElementById('modalPosition').value = '';
                document.getElementById('modalSchedule').value = '';
                document.getElementById('modalStartHour').value = '';
                document.getElementById('modalEndHour').value = '';
                document.getElementById('modalStartDay').value = '';
                const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
                if (isSubcontractorHidden) {
                    isSubcontractorHidden.value = 'false';
                }
                modalTitle.textContent = 'Добавить сотрудника';
                btnSave.textContent = 'Добавить';
                btnDelete.style.display = 'none';
            }

            toggleFields();
            modal.style.display = 'block';
        }

        window.closeModal = function() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            editingEmployeeId = null;
        }

        window.addEmployeeFromModal = function() {
            const realName = document.getElementById('modalRealName').value.trim();
            const position = document.getElementById('modalPosition').value.trim();
            const schedule = document.getElementById('modalSchedule').value.trim();
            const startHourVal = document.getElementById('modalStartHour').value.trim();
            const endHourVal = document.getElementById('modalEndHour').value.trim();
            const startDayVal = document.getElementById('modalStartDay').value.trim();
            const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
            const isSubcontractor = isSubcontractorHidden ? (isSubcontractorHidden.value === 'true') : false;

            if (!realName) {
                alert('Пожалуйста, выберите сотрудника из справочника!');
                return;
            }

            if (!position) {
                alert('Должность не заполнена!');
                return;
            }

            let startHour = '';
            let endHour = '';
            let finalSchedule = '';
            let startDay = '';

            // Для подработчика - часы заполняются, но БЕЗ автоматического графика
            if (isSubcontractor) {
                // Часы можно вводить вручную
                if (startHourVal) startHour = parseInt(startHourVal);
                if (endHourVal) endHour = parseInt(endHourVal);
                // Но график и дата НЕ устанавливаются (только ручная вставка смен!)
                finalSchedule = undefined;
                startDay = undefined;
            } else {
                // Для обычных сотрудников - устанавливаем расписание
                if (schedule === '5/2') {
                    startHour = 9;
                    endHour = 18;
                    finalSchedule = '5/2';
                    startDay = 1;
                } else if (schedule === '2/2') {
                    startHour = 9;
                    endHour = 21;
                    finalSchedule = '2/2';
                    startDay = 1;
                }

                if (startHourVal) startHour = parseInt(startHourVal);
                if (endHourVal) endHour = parseInt(endHourVal);
                if (startDayVal) startDay = parseInt(startDayVal);
            }

            if (editingEmployeeId) {
                const employee = employees.find(e => e.id === editingEmployeeId);
                if (employee) {
                    employee.position = position;
                    employee.name = realName;

                    if (isSubcontractor) {
                        // Для подработчика - обновляем только часы, не трогаем график
                        if (startHourVal) employee.startHour = parseInt(startHourVal);
                        if (endHourVal) employee.endHour = parseInt(endHourVal);
                        employee.schedule = undefined;
                        employee.scheduleStartDay = undefined;
                    } else {
                        // Для обычных сотрудников обновляем всё
                        if (startHour) employee.startHour = startHour;
                        if (endHour) employee.endHour = endHour;
                        if (finalSchedule) employee.schedule = finalSchedule;
                        if (startDay) employee.scheduleStartDay = startDay;
                    }

                    employee.isSubcontractor = isSubcontractor === true ? true : false;
                    
                    // Отладка при обновлении
                    console.log('✏️ Обновлен сотрудник:', {
                        name: employee.name,
                        isSubcontractor: employee.isSubcontractor,
                        type: typeof employee.isSubcontractor
                    });
                    
                    showMessage('Сотрудник обновлён!');
                }
            } else {
                const id = Date.now();
                const newEmployee = {
                    id: id,
                    position: position,
                    name: realName,
                    startHour: startHour || undefined,
                    endHour: endHour || undefined,
                    schedule: finalSchedule,
                    scheduleStartDay: startDay,
                    isSubcontractor: isSubcontractor === true ? true : false,
                    dayOverrides: {}
                };
                
                // Отладка при добавлении
                console.log('➕ Добавлен новый сотрудник:', {
                    name: newEmployee.name,
                    isSubcontractor: newEmployee.isSubcontractor,
                    type: typeof newEmployee.isSubcontractor
                });
                
                employees.push(newEmployee);
                
                // КРИТИЧНО: Проверяем, что сотрудник действительно добавлен в массив
                const addedEmployee = employees.find(e => e.id === newEmployee.id);
                if (addedEmployee) {
                    console.log('✅ Сотрудник добавлен в массив employees:', {
                        id: addedEmployee.id,
                        name: addedEmployee.name,
                        isSubcontractor: addedEmployee.isSubcontractor,
                        type: typeof addedEmployee.isSubcontractor,
                        inArray: employees.includes(addedEmployee)
                    });
                } else {
                    console.error('❌ ОШИБКА: Сотрудник не найден в массиве после добавления!');
                }
                
                showMessage('Сотрудник добавлен!');
            }

            closeModal();
            
            // КРИТИЧНО: Сохраняем данные СРАЗУ после добавления
            console.log('💾 Начинаем сохранение данных...');
            console.log('  - Всего сотрудников перед сохранением:', employees.length);
            const subcontractorsBeforeSave = employees.filter(emp => emp.isSubcontractor === true || emp.isSubcontractor === 1).length;
            console.log('  - Подработчиков перед сохранением:', subcontractorsBeforeSave);
            
            saveData().then(() => {
                console.log('✅ Данные сохранены, начинаем рендеринг...');
                renderSchedule();
                
                // Дополнительная проверка после сохранения
                setTimeout(async () => {
                    const scheduleKey = getScheduleKey(currentYear, currentMonth, currentPharmacyId);
                    const verifyData = await firebaseGetItem(scheduleKey);
                    if (verifyData && verifyData.employees) {
                        const savedSubcontractors = verifyData.employees.filter(emp => emp.isSubcontractor === 1 || emp.isSubcontractor === true).length;
                        console.log('🔍 Проверка через 1 секунду: подработчиков в Firebase:', savedSubcontractors);
                        if (savedSubcontractors !== subcontractorsBeforeSave) {
                            console.error('❌ КРИТИЧЕСКАЯ ОШИБКА: Подработчики не сохранились!');
                            console.error('  - Было перед сохранением:', subcontractorsBeforeSave);
                            console.error('  - Сохранено в Firebase:', savedSubcontractors);
                        }
                    }
                }, 1000);
            }).catch(err => {
                console.error('❌ Ошибка сохранения:', err);
                renderSchedule(); // Рендерим даже при ошибке сохранения
            });
        }

        function buildTableHeader() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            const row1 = document.createElement('tr');
            row1.style.borderTop = '2px solid #000';
            
            const cell1 = document.createElement('td');
            cell1.className = 'col-position';
            cell1.textContent = 'Должность';
            cell1.rowSpan = 2;
            cell1.style.verticalAlign = 'middle';
            cell1.style.borderLeft = '2px solid #000';
            cell1.style.borderTop = '2px solid #000';
            row1.appendChild(cell1);
            
            const cell2 = document.createElement('td');
            cell2.className = 'col-name';
            cell2.textContent = 'Ф.И.О. сотрудника';
            cell2.rowSpan = 2;
            cell2.style.verticalAlign = 'middle';
            cell2.style.borderTop = '2px solid #000';
            row1.appendChild(cell2);
            
            const cell3 = document.createElement('td');
            cell3.className = 'col-schedule';
            cell3.textContent = 'График';
            cell3.rowSpan = 2;
            cell3.style.verticalAlign = 'middle';
            cell3.style.borderTop = '2px solid #000';
            row1.appendChild(cell3);

            for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                const cell = document.createElement('td');
                cell.className = `day-header ${(isWeekend(day) || offDays[day]) ? 'weekend' : ''}`;
                cell.style.cursor = 'pointer';
                cell.style.borderTop = '2px solid #000';
                const div = document.createElement('div');
                div.className = 'day-number';
                div.textContent = day;
                cell.appendChild(div);
                cell.onclick = (function(d) { 
                    return function() { 
                        toggleDayColumn(d); 
                    }; 
                })(day);
                row1.appendChild(cell);
            }

            const totalCell1 = document.createElement('td');
            totalCell1.className = 'col-total';
            totalCell1.textContent = 'Отработано за месяц, час';
            totalCell1.style.fontSize = '8px';
            totalCell1.rowSpan = 2;
            totalCell1.style.verticalAlign = 'middle';
            totalCell1.style.borderTop = '2px solid #000';
            totalCell1.style.borderRight = '2px solid #000';
            row1.appendChild(totalCell1);

            tbody.appendChild(row1);

            const row2 = document.createElement('tr');
            row2.style.borderBottom = '2px solid #000';
            
            // Ячейки Должность, ФИО и График не создаем - они объединены в первой строке

            for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                const dayOfWeek = getDayOfWeek(day);
                const cell = document.createElement('td');
                cell.className = `day-header ${(isWeekend(day) || offDays[day]) ? 'weekend' : ''}`;
                cell.style.cursor = 'pointer';
                cell.style.borderBottom = '2px solid #000';
                const div = document.createElement('div');
                div.className = 'day-name';
                div.textContent = daysOfWeek[dayOfWeek];
                cell.appendChild(div);
                row2.appendChild(cell);
            }

            // Ячейка итога не создаем - она объединена в первой строке

            tbody.appendChild(row2);
        }

function getDisplayValue(employee, day) {
    const overrides = employee.dayOverrides || {};
    const dayValue = overrides[day];

    if (dayValue !== undefined) {
        return dayValue === "" ? null : dayValue;
    }

    const isWork = isStandardWorkDay(employee, day);
    if (isWork === true) {
        if (employee.startHour !== undefined && employee.endHour !== undefined) {
            return employee.startHour + "-" + employee.endHour;
        }
    }
    return null;
}

        function debugEmployeeSchedule(employee, monthName) {
        console.log(`=== Отладка графика для ${employee.name} (${monthName}) ===`);
        console.log(`График: ${employee.schedule}, StartDay: ${employee.scheduleStartDay || 1}`);
        console.log(`StartHour: ${employee.startHour}, EndHour: ${employee.endHour}`);

        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        const daysOfWeekNames = ['пн', 'вт', 'ср', 'чт', 'пт', 'сб', 'вс'];
        for (let day = 1; day <= daysInMonth; day++) {
            const isWork = isEmployeeWorkDay(employee, day);
            const isWeekendDay = isWeekend(day);
            console.log(`День ${day} (${daysOfWeekNames[getDayOfWeek(day)]}): рабочий=${isWork}, выходной=${isWeekendDay}, переопределение=${employee.dayOverrides ? employee.dayOverrides[day] : 'нет'}`);
        }
        console.log(`=== Конец отладки ===`);
    }

        let offDays = {};

        function toggleDayColumn(day) {
            if (!offDays[day]) {
                offDays[day] = true;
            } else {
                delete offDays[day];
            }
            saveOffDaysStorage();
            renderSchedule();
                saveDaysOffToStorage();
        }

        function renderSchedule() {
        // Очищаем старые переопределения для текущего месяца
        employees.forEach(cleanUpDayOverrides);

        // Отладка первого сотрудника
        if (employees.length > 0) {
            debugEmployeeSchedule(employees[0], getMonthName(currentMonth));
        }

        // Сортировка сотрудников: сначала ЗАУ, потом остальные, последние - подработчики
        const sortedEmployees = [...employees].sort((a, b) => {
            // Определяем приоритет для сотрудника
            const getPriority = (emp) => {
                if (emp.isSubcontractor) return 3; // Подработчики - самый низкий приоритет (проверяем ПЕРВЫМ!)
                if (emp.position === 'ЗАУ') return 1; // ЗАУ - самый высокий приоритет
                return 2; // Остальные сотрудники - средний приоритет
            };

            const priorityA = getPriority(a);
            const priorityB = getPriority(b);

            // Сортируем по приоритету
            if (priorityA !== priorityB) {
                return priorityA - priorityB;
            }

            // Если приоритеты равны, сортируем по имени
            return a.name.localeCompare(b.name, 'ru');
        });

            buildTableHeader();
            const tbody = document.getElementById('scheduleBody');

            sortedEmployees.forEach((employee) => {
                const startWorkRow = document.createElement('tr');
                startWorkRow.className = 'input-row';

                const startPos = document.createElement('td');
                startPos.className = 'col-position employee-position-cell';
                startPos.style.whiteSpace = 'normal';
                startPos.style.height = 'auto';
                startPos.rowSpan = 4;
                startPos.style.verticalAlign = 'middle';
                
                const startPosDiv = document.createElement('div');
                startPosDiv.className = 'employee-position';
                startPosDiv.textContent = employee.position;
                startPos.appendChild(startPosDiv);
                
                if (employee.isSubcontractor) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'employee-status';
                    statusDiv.textContent = 'подработчик';
                    startPos.appendChild(statusDiv);
                }
                
                startPos.onclick = () => openModal(employee.id);
                startPos.title = 'Нажмите для редактирования';
                startWorkRow.appendChild(startPos);

                const startNameCell = document.createElement('td');
                startNameCell.className = 'col-name';
                startNameCell.textContent = employee.name;
                startNameCell.onclick = () => openModal(employee.id);
                startNameCell.title = 'Нажмите для редактирования';
                startNameCell.style.verticalAlign = 'middle';
                startNameCell.rowSpan = 4;
                startWorkRow.appendChild(startNameCell);

                const startLabel = document.createElement('td');
                startLabel.className = 'col-shift-type';
                startLabel.textContent = 'Начало работы';
                startLabel.style.fontSize = '9px';
                startWorkRow.appendChild(startLabel);

                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    const cell = document.createElement('td');
                    const dayValue = getDisplayValue(employee, day);
                    let value = '';

                    if (dayValue) {
                        value = dayValue.split('-')[0] || '';
                    }
                    
                    const isWork = isEmployeeWorkDay(employee, day);
                    if (isWeekend(day) || offDays[day]) {
                        cell.className = `data-cell weekend`;
                    } else {
                        cell.className = `data-cell`;
                    }

                    if (value) {
                        const span = document.createElement('div');
                        span.className = 'shift-value';
                        span.textContent = value;
                        cell.appendChild(span);
                    }

                    cell.onclick = () => openCellEditModal(employee.id, day);
                    startWorkRow.appendChild(cell);
                }

                const emptyCell0 = document.createElement('td');
                emptyCell0.className = 'col-total';
                emptyCell0.textContent = ''; // Пустая в строке "Начало работы"
                startWorkRow.appendChild(emptyCell0);

                tbody.appendChild(startWorkRow);

                const endRow = document.createElement('tr');
                endRow.className = 'label-row';

                // Ячейки должности и ФИО не создаем - они объединены в первой строке

                const endLabel3 = document.createElement('td');
                endLabel3.className = 'col-shift-type';
                endLabel3.textContent = 'Окончание работы';
                endLabel3.style.fontSize = '9px';
                endRow.appendChild(endLabel3);

                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    const cell = document.createElement('td');
                    const dayValue = getDisplayValue(employee, day);
                    let value = '';

                    if (dayValue) {
                        value = dayValue.split('-')[1] || '';
                    }

                    const isWork = isEmployeeWorkDay(employee, day);
                    if (isWeekend(day) || offDays[day]) {
                        cell.className = `data-cell weekend`;
                    } else {
                        cell.className = `data-cell`;
                    }

                    if (value) {
                        const span = document.createElement('div');
                        span.className = 'shift-value';
                        span.textContent = value;
                        cell.appendChild(span);
                    }

                    cell.onclick = () => openCellEditModal(employee.id, day);
                    endRow.appendChild(cell);
                }

                const emptyCell1 = document.createElement('td');
                emptyCell1.className = 'col-total';
                emptyCell1.textContent = ''; // Пустая в строке "Окончание работы"
                endRow.appendChild(emptyCell1);

                tbody.appendChild(endRow);

                const breakRow = document.createElement('tr');
                breakRow.className = 'label-row';

                // Ячейки должности и ФИО не создаем - они объединены в первой строке

                const breakLabel3 = document.createElement('td');
                breakLabel3.className = 'col-shift-type';
                breakLabel3.textContent = 'Перерыв на обед';
                breakLabel3.style.fontSize = '9px';
                breakRow.appendChild(breakLabel3);

                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    const cell = document.createElement('td');
                    const dayValue = getDisplayValue(employee, day);
                    
                    let value = '';
                    if (dayValue) {
                        value = '1';
                    }

                    const isWork = isEmployeeWorkDay(employee, day);
                    if (isWeekend(day) || offDays[day]) {
                        cell.className = `data-cell weekend`;
                    } else {
                        cell.className = `data-cell`;
                    }

                    if (value) {
                        const span = document.createElement('div');
                        span.className = 'auto-value';
                        span.textContent = value;
                        cell.appendChild(span);
                    }

                    cell.onclick = () => openCellEditModal(employee.id, day);
                    breakRow.appendChild(cell);
                }

                const emptyCell2 = document.createElement('td');
                emptyCell2.className = 'col-total';
                const totalShifts = calculateTotalShifts(employee);
                emptyCell2.textContent = totalShifts > 0 ? totalShifts : ''; // Количество смен в строке "Перерыв на обед"
                breakRow.appendChild(emptyCell2);

                tbody.appendChild(breakRow);

                const hoursRow = document.createElement('tr');
                hoursRow.className = 'label-row employee-block-end';

                // Ячейки должности и ФИО не создаем - они объединены в первой строке

                const hoursLabel3 = document.createElement('td');
                hoursLabel3.className = 'col-shift-type';
                hoursLabel3.textContent = 'Количество часов';
                hoursLabel3.style.fontSize = '9px';
                hoursRow.appendChild(hoursLabel3);

                for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
                    const cell = document.createElement('td');
                    const dayValue = getDisplayValue(employee, day);
                    let hours = 0;

                    if (dayValue) {
                        const match = dayValue.match(/(\d+)-(\d+)/);
                        if (match) {
                            const start = parseInt(match[1]);
                            const end = parseInt(match[2]);
                            hours = end - start - 1;
                            hours = hours < 0 ? (hours + 24) : hours;
                        }
                    }

                    cell.className = 'hours-cell';
                    if (isWeekend(day) || offDays[day]) {
                        cell.classList.add('weekend');
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'hours-cell-content';
                    
                    if (hours > 0) {
                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'hours-value';
                        valueSpan.textContent = hours.toString();
                        contentDiv.appendChild(valueSpan);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = '✕';
                        deleteBtn.type = 'button';
                        deleteBtn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            deleteShift(employee.id, day);
                        };
                        contentDiv.appendChild(deleteBtn);
                    } else {
                        const addBtn = document.createElement('button');
                        addBtn.className = 'add-btn';
                        addBtn.textContent = '+';
                        addBtn.type = 'button';
                        addBtn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            addShift(employee.id, day);
                        };
                        contentDiv.appendChild(addBtn);
                    }

                    cell.appendChild(contentDiv);
                    hoursRow.appendChild(cell);
                }

                const totalCell = document.createElement('td');
                totalCell.className = 'col-total';
                const totalHours = calculateTotalHours(employee);
                totalCell.textContent = totalHours > 0 ? totalHours : ''; // Количество часов в строке "Количество часов"
                hoursRow.appendChild(totalCell);

                tbody.appendChild(hoursRow);
            });
        
            highlightDaysWithNobody(); // Подсвечиваем дни когда никто не работает
        }

        // Debounce для сохранения данных
        let saveDataTimeout = null;
        let isSaving = false;
        let pendingSave = false;
        
        // Функция для немедленного сохранения (для критических операций)
        async function saveDataImmediate() {
            // Очищаем debounce таймер, если он есть
            if (saveDataTimeout) {
                clearTimeout(saveDataTimeout);
                saveDataTimeout = null;
            }
            await performSaveData();
        }
        
        // Отдельная функция для сохранения справочников с debounce
        let saveReferenceTimeout = null;
        let lastReferenceHash = null;
        
        async function saveReferenceData() {
            const refData = {
                pharmacyReference: pharmacyReference || [],
                employeeReference: employeeReference || []
            };
            
            const currentHash = JSON.stringify(refData);
            // Если данные не изменились, не сохраняем
            if (currentHash === lastReferenceHash) {
                return;
            }
            
            // Очищаем предыдущий таймер
            if (saveReferenceTimeout) {
                clearTimeout(saveReferenceTimeout);
            }
            
            // Используем debounce - сохраняем через 500мс после последнего изменения
            saveReferenceTimeout = setTimeout(async () => {
                try {
                    await firebaseSetItem('scheduleReferenceData', refData);
                    lastReferenceHash = currentHash;
                } catch (error) {
                    console.error('Ошибка сохранения справочников:', error);
                }
            }, 500);
        }
        
        async function saveData() {
            // Если уже идет сохранение, помечаем что нужно сохранить еще раз после завершения
            if (isSaving) {
                pendingSave = true;
                return;
            }
            
            // Очищаем предыдущий таймер
            if (saveDataTimeout) {
                clearTimeout(saveDataTimeout);
            }
            
            // Используем debounce - сохраняем через 1 секунду после последнего изменения
            saveDataTimeout = setTimeout(async () => {
                await performSaveData();
            }, 1000);
        }
        
        async function performSaveData() {
            if (isSaving) {
                pendingSave = true;
                return;
            }
            
            isSaving = true;
            pendingSave = false;
            
            try {
                const pharmacySelect = document.getElementById('pharmacyNumber');
                const pharmacyAddressInput = document.getElementById('pharmacyAddress');
                const idToSave = currentPharmacyId || '--';
                const scheduleKey = getScheduleKey(currentYear, currentMonth, idToSave);
                
                // Убеждаемся, что поле isSubcontractor явно установлено для всех сотрудников перед сохранением
                const employeesToSave = employees.map(emp => {
                    // КРИТИЧНО: Firebase Realtime Database может удалять поля со значением false
                    // Используем число 1 для true и 0 для false, чтобы гарантировать сохранение
                    const employeeToSave = {
                        id: emp.id,
                        position: emp.position || '',
                        name: emp.name || '',
                        startHour: emp.startHour !== undefined ? emp.startHour : null,
                        endHour: emp.endHour !== undefined ? emp.endHour : null,
                        schedule: emp.schedule !== undefined ? emp.schedule : null,
                        scheduleStartDay: emp.scheduleStartDay !== undefined ? emp.scheduleStartDay : null,
                        isSubcontractor: emp.isSubcontractor === true ? 1 : 0, // Сохраняем как число для надежности
                        dayOverrides: emp.dayOverrides || {}
                    };
                    // Дополнительная гарантия
                    if (employeeToSave.isSubcontractor === undefined || employeeToSave.isSubcontractor === null) {
                        employeeToSave.isSubcontractor = 0;
                    }
                    return employeeToSave;
                });
                
                const scheduleData = {
                    pharmacyId: idToSave,
                    pharmacyNumber: idToSave,
                    pharmacyAddress: pharmacyAddressInput ? pharmacyAddressInput.value : '',
                    employees: employeesToSave
                };
                
                // Сохраняем хеш данных перед сохранением
                lastSavedDataHash = JSON.stringify(scheduleData);
                isLocalUpdate = true; // Помечаем, что это наше обновление
                
                // Сохраняем в Firebase (без проверки после сохранения для ускорения)
                await firebaseSetItem(scheduleKey, scheduleData);
                
                // Сохраняем настройки (они небольшие, можно сохранять всегда)
                await firebaseSetItem('savedCurrentMonth', currentMonth.toString());
                await firebaseSetItem('savedCurrentYear', currentYear.toString());
                await firebaseSetItem('savedCurrentPharmacyId', idToSave);
                
                // Справочники сохраняются отдельно при их изменении, здесь не нужно
            } catch (error) {
                console.error('Ошибка сохранения данных:', error);
            } finally {
                isSaving = false;
                // Если было запрошено сохранение во время текущего сохранения, выполняем его
                if (pendingSave) {
                    setTimeout(() => performSaveData(), 100);
                }
            }
        }

        async function loadData() {
    const savedRefData = await firebaseGetItem('scheduleReferenceData');
    if (savedRefData) {
        try {
            const refData = typeof savedRefData === 'string' ? JSON.parse(savedRefData) : savedRefData;
            pharmacyReference = refData.pharmacyReference || [];
            employeeReference = refData.employeeReference || [];
        } catch (e) { pharmacyReference = []; employeeReference = []; }
    }
    if (typeof updateGraphicPharmacySelect === 'function') updateGraphicPharmacySelect();
    if (typeof updateRefPharmacySelect === 'function') updateRefPharmacySelect();
    if (typeof updateGraphicEmployeeSelect === 'function') updateGraphicEmployeeSelect();

    currentPharmacyId = await firebaseGetItem('savedCurrentPharmacyId');
    const sel = document.getElementById('pharmacyNumber');
    if (currentPharmacyId && currentPharmacyId !== '--') {
         const exists = pharmacyReference.some(p => p.id == currentPharmacyId);
         if (!exists) currentPharmacyId = '--';
    }
    if (!currentPharmacyId) currentPharmacyId = '--';

    if (sel) {
        sel.value = currentPharmacyId;
        if (currentPharmacyId !== '--') {
            const ph = pharmacyReference.find(p => p.id == currentPharmacyId);
            if (ph && document.getElementById('pharmacyAddress')) {
                document.getElementById('pharmacyAddress').value = ph.address;
            }
        } else {
             if (document.getElementById('pharmacyAddress')) document.getElementById('pharmacyAddress').value = '';
        }
    }

    const titleEl = document.getElementById('currentMonthDisplay');
    const dateText = getMonthName(currentMonth).toUpperCase() + ' ' + currentYear;
    if (sel && sel.selectedIndex >= 0) {
        const pharmacyText = sel.options[sel.selectedIndex].text;
        if (pharmacyText && !pharmacyText.includes('-- Выберите аптеку --')) {
            const pharmacyNum = pharmacyText.replace(/^Аптека №/, '');
            if (titleEl) titleEl.innerHTML = 'ГРАФИК СОТРУДНИКОВ АПТЕКИ №' + pharmacyNum + ' НА <span id="monthYearText">' + dateText + '</span> Г.';
        } else {
            if (titleEl) titleEl.innerHTML = '<span id="monthYearText">' + dateText + '</span>';
        }
    } else {
        if (titleEl) titleEl.innerHTML = '<span id="monthYearText">' + dateText + '</span>';
    }

    loadScheduleFor(currentYear, currentMonth, currentPharmacyId);
    if (typeof renderSchedule === 'function') renderSchedule();
}

        // Делаем функцию глобально доступной
        window.exportToExcel = async function exportToExcel() {
            try {
                console.log('=== НАЧАЛО ЭКСПОРТА В EXCEL ===');
                console.log('Проверка библиотеки XLSX:', typeof XLSX);
                console.log('XLSX.utils:', typeof XLSX !== 'undefined' ? typeof XLSX.utils : 'не определен');
                console.log('XLSX объект:', typeof XLSX !== 'undefined' ? XLSX : 'не определен');
                
                // Проверяем наличие библиотеки ExcelJS
                if (typeof ExcelJS === 'undefined') {
                    alert('Библиотека ExcelJS не загружена.\n\n' +
                          'Возможные причины:\n' +
                          '1. Нет подключения к интернету\n' +
                          '2. Браузер блокирует загрузку внешних скриптов\n' +
                          '3. Проблемы с CDN\n\n' +
                          'Попробуйте:\n' +
                          '1. Обновить страницу (F5)\n' +
                          '2. Проверить подключение к интернету\n' +
                          '3. Открыть страницу через веб-сервер (не file://)\n' +
                          '4. Открыть консоль браузера (F12) для подробностей');
                    return;
                }
                console.log('Библиотека ExcelJS загружена и готова');

                // Загружаем данные об отсутствиях, если они еще не загружены
                if (!absenceData || Object.keys(absenceData).length === 0) {
                    try {
                        const absenceDataValue = await firebaseGetItem('absenceData') || {};
                        absenceData = typeof absenceDataValue === 'string' ? JSON.parse(absenceDataValue) : absenceDataValue;
                    } catch (e) {
                        console.warn('Не удалось загрузить данные об отсутствиях:', e);
                        absenceData = {};
                    }
                }

                // Функция для проверки отсутствия сотрудника на конкретный день
                function getAbsenceForDay(employeeName, day) {
                    if (!absenceData || !absenceData[employeeName]) return null;
                    const checkDate = new Date(currentYear, currentMonth, day);
                    for (let absence of absenceData[employeeName]) {
                        const startDate = new Date(absence.startDate);
                        const endDate = new Date(absence.endDate);
                        if (checkDate >= startDate && checkDate <= endDate) {
                            return {
                                symbol: absence.type === 'vacation' ? 'О' : 'Б',
                                color: absence.type === 'vacation' ? '#fff3cd' : '#f8d7da'
                            };
                        }
                    }
                    return null;
                }

                // Проверяем наличие данных
                if (!employees || employees.length === 0) {
                    alert('Нет данных для экспорта. Пожалуйста, добавьте сотрудников в график.');
                    console.warn('Нет сотрудников для экспорта');
                    return;
                }
                console.log('Найдено сотрудников:', employees.length);

            // Создаем новую книгу Excel с помощью ExcelJS
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('График');
            
            // Настраиваем параметры печати: альбомная ориентация и автоматическое масштабирование на 1 страницу
            worksheet.pageSetup = {
                orientation: 'landscape', // Альбомная ориентация
                paperSize: 9, // A4 (9 = A4)
                fitToPage: true, // Включить подгонку к странице
                fitToWidth: 1, // Подогнать по ширине на 1 страницу
                fitToHeight: 1, // Подогнать по высоте на 1 страницу
                horizontalCentered: false,
                verticalCentered: false,
                margins: {
                    left: 0.08, // 2mm в дюймах (примерно)
                    right: 0.08,
                    top: 0.08,
                    bottom: 0.08,
                    header: 0,
                    footer: 0
                }
            };

                // Получаем номер аптеки из селекта
                const pharmacySelect = document.getElementById('pharmacyNumber');
                let pharmacyNumberText = '-- Не выбрано --';
                let pharmacyAddress = '';
                let pharmacyId = null;
                
                if (pharmacySelect && pharmacySelect.selectedIndex >= 0) {
                    pharmacyId = pharmacySelect.value;
                    const optionText = pharmacySelect.options[pharmacySelect.selectedIndex].text;
                    // Извлекаем номер аптеки из текста "Аптека №123" или "Аптека №123-45"
                    const match = optionText.match(/Аптека\s*№\s*(.+)/);
                    pharmacyNumberText = match ? match[1].trim() : optionText.replace(/^Аптека\s*№\s*/, '').trim();
                    
                    // Получаем адрес из справочника аптек
                    if (pharmacyId && pharmacyId !== '--' && typeof pharmacyReference !== 'undefined' && pharmacyReference) {
                        const ph = pharmacyReference.find(p => p.id === pharmacyId);
                        if (ph && ph.address) {
                            pharmacyAddress = ph.address;
                        }
                    }
                }
                
                // Пробуем получить адрес из поля, если оно существует
                const addressInput = document.getElementById('pharmacyAddress');
                if (addressInput && addressInput.value) {
                    pharmacyAddress = addressInput.value;
                }

                const daysInMonth = getDaysInMonth(currentMonth, currentYear);
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                const monthName = monthNames[currentMonth] || 'Месяц';
                const monthNameUpper = monthName.toUpperCase();
                const weekDays = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];

                // Заголовок (новая структура)
                // Вычисляем столбцы: для декабря с 31 днем
                // Столбец 1 = A (Должность), 2 = B (ФИО), 3 = C (График)
                // Столбцы 4-34 = D-AH (дни 1-31), столбец 35 = AI (Отработано)
                const lastTableCol = 3 + daysInMonth; // Столбец с последним днем месяца (AH для 31 дня = 34)
                const lastCol = 3 + daysInMonth + 1; // Последний столбец таблицы (Отработано = AI для 31 дня = 35)
                
                // Строка 1: "Утвержден:" в объединенных ячейках V-AH (столбцы 22-34 для 31 дня)
                const row1 = worksheet.getRow(1);
                const colV = 22; // V = столбец 22
                const colAH = lastTableCol; // AH = последний столбец с днем месяца (34 для 31 дня)
                worksheet.mergeCells(1, colV, 1, colAH);
                row1.getCell(colV).value = 'Утвержден:';
                applyCellStyle(row1.getCell(colV), { horizontal: 'center', vertical: 'middle', bold: true, fontColor: 'FFFF0000', noBorder: true });
                
                // Строка 2: пустая
                const row2 = worksheet.getRow(2);
                
                // Строка 3: "Бочарова А.В." в объединенных ячейках Z-AD (столбцы 26-30) с линией под ними
                const row3 = worksheet.getRow(3);
                const colZ = 26;
                const colAD = 30;
                worksheet.mergeCells(3, colZ, 3, colAD);
                row3.getCell(colZ).value = 'Бочарова А.В.';
                applyCellStyle(row3.getCell(colZ), { horizontal: 'center', vertical: 'middle', noBorder: true });
                // Тонкая черная линия под ячейкой (только нижняя граница)
                row3.getCell(colZ).border = {
                    bottom: { style: 'thin', color: { argb: 'FF000000' } }
                };
                
                // Строка 4: пустая
                const row4 = worksheet.getRow(4);
                
                // Строка 5: "Директор региона Владимир" в объединенных ячейках Z-AD (столбцы 26-30)
                const row5 = worksheet.getRow(5);
                worksheet.mergeCells(5, colZ, 5, colAD);
                row5.getCell(colZ).value = 'Директор региона Владимир';
                applyCellStyle(row5.getCell(colZ), { horizontal: 'center', vertical: 'middle', noBorder: true });
                
                // Строка 6: пустая
                const row6 = worksheet.getRow(6);
                
                // Строка 7: A7="Аптека №", C7=номер аптеки, D7="Адрес:", E7=адрес, Y7-AI7 объединены
                const row7 = worksheet.getRow(7);
                row7.getCell(1).value = 'Аптека №';
                applyCellStyle(row7.getCell(1), { horizontal: 'left', vertical: 'middle', noBorder: true });
                row7.getCell(3).value = pharmacyNumberText;
                applyCellStyle(row7.getCell(3), { horizontal: 'left', vertical: 'middle', noBorder: true });
                row7.getCell(4).value = 'Адрес:';
                applyCellStyle(row7.getCell(4), { horizontal: 'left', vertical: 'middle', noBorder: true });
                row7.getCell(5).value = pharmacyAddress;
                applyCellStyle(row7.getCell(5), { horizontal: 'left', vertical: 'middle', noBorder: true });
                // Объединяем ячейки E-AI (столбцы 5-35) в строке 7
                const colE = 5;
                const colAI = lastCol; // AI = последний столбец таблицы (35 для 31 дня)
                worksheet.mergeCells(7, colE, 7, colAI);
                applyCellStyle(row7.getCell(colE), { horizontal: 'left', vertical: 'middle', noBorder: true });
                
                // Строка 8: пустая
                const row8 = worksheet.getRow(8);
                
                // Строка 9: заголовок "ГРАФИК СОТРУДНИКОВ..." в объединенных ячейках A-AH (от столбца 1 до последнего дня месяца)
                const titleRow = worksheet.getRow(9);
                worksheet.mergeCells(9, 1, 9, colAH); // A (1) до AH (последний день месяца)
                titleRow.getCell(1).value = `ГРАФИК СОТРУДНИКОВ А/П НА ${monthNameUpper} ${currentYear} г.`;
                applyCellStyle(titleRow.getCell(1), { horizontal: 'center', vertical: 'middle', bold: true, noBorder: true });
                
                // Строка 10: пустая
                const row10 = worksheet.getRow(10);
                
                // Строка 11: даты (дни месяца: 1, 2, 3, ...)
                const headerRow1 = worksheet.getRow(11); // Строка 11 - даты
                headerRow1.getCell(1).value = ''; // Пустая для Должность
                headerRow1.getCell(2).value = ''; // Пустая для ФИО
                headerRow1.getCell(3).value = ''; // Пустая для "График"
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = headerRow1.getCell(3 + day);
                    cell.value = day; // Число дня месяца
                    const date = new Date(currentYear, currentMonth, day);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    applyCellStyle(cell, { 
                        horizontal: 'center', 
                        vertical: 'middle',
                        bold: true,
                        bgColor: isWeekend ? 'FFFFE4CC' : null
                    });
                }
                headerRow1.getCell(3 + daysInMonth + 1).value = ''; // Пустая для Отработано

                // Строка 12: основные заголовки (Должность, ФИО, дни недели, Отработано)
                const headerRow2 = worksheet.getRow(12); // Строка 12 - основные заголовки
                let currentRow = 13; // Следующая строка после заголовков (строка 13)
                headerRow2.getCell(1).value = 'Должность';
                headerRow2.getCell(2).value = 'Ф.И.О. сотрудника';
                headerRow2.getCell(3).value = 'График';
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const cell = headerRow2.getCell(3 + day);
                    cell.value = weekDays[date.getDay()]; // День недели (Пн, Вт, Ср...)
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    applyCellStyle(cell, { 
                        horizontal: 'center', 
                        vertical: 'middle',
                        bold: true,
                        bgColor: isWeekend ? 'FFFFE4CC' : null
                    });
                }
                headerRow2.getCell(3 + daysInMonth + 1).value = 'Отработано за месяц. час.';

                // Функция для применения стилей к ячейке
                function applyCellStyle(cell, options = {}) {
                    cell.alignment = {
                        vertical: options.vertical || 'middle',
                        horizontal: options.horizontal || 'center',
                        wrapText: options.wrapText || false
                    };
                    // Если указано noBorder: true, не применяем границы
                    if (!options.noBorder) {
                        const borderStyle = options.borderStyle || 'thin';
                        const borderColor = options.borderColor || 'FF000000';
                        cell.border = {
                            top: { style: borderStyle, color: { argb: borderColor } },
                            left: { style: borderStyle, color: { argb: borderColor } },
                            bottom: { style: borderStyle, color: { argb: borderColor } },
                            right: { style: borderStyle, color: { argb: borderColor } }
                        };
                    }
                    if (options.bgColor) {
                        const colorArg = options.bgColor.startsWith('FF') ? options.bgColor : 'FF' + options.bgColor.replace('#', '');
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: colorArg }
                        };
                    }
                    // Устанавливаем шрифт Arial Cyr размер 10 по умолчанию
                    if (!cell.font) cell.font = {};
                    cell.font.name = 'Arial Cyr';
                    cell.font.size = options.fontSize || 10;
                    if (options.bold !== undefined) {
                        cell.font.bold = options.bold;
                    }
                    if (options.fontColor) {
                        cell.font.color = { argb: options.fontColor.startsWith('FF') ? options.fontColor : 'FF' + options.fontColor.replace('#', '') };
                    }
                }

                // Устанавливаем ширину столбцов
                worksheet.getColumn(1).width = 15; // Должность
                // Столбец ФИО будет установлен адаптивно после заполнения данных
                worksheet.getColumn(3).width = 18; // График
                for (let day = 1; day <= daysInMonth; day++) {
                    worksheet.getColumn(3 + day).width = 6;
                }
                // Уменьшаем ширину столбца "Отработано" в 2 раза (было 20, стало 10)
                worksheet.getColumn(3 + daysInMonth + 1).width = 10; // Отработано

                // Заголовки НЕ объединяем - строки 11 и 12 должны быть отдельными
                // Устанавливаем высоту строки 12 (основные заголовки) = 72
                headerRow2.height = 72;

                // Применяем стили к заголовкам
                // Строка 11: пустые ячейки для Должность/ФИО, даты уже стилизованы в цикле
                applyCellStyle(headerRow1.getCell(1), { horizontal: 'center', bold: true, vertical: 'middle' });
                applyCellStyle(headerRow1.getCell(2), { horizontal: 'center', bold: true, vertical: 'middle' });
                applyCellStyle(headerRow1.getCell(3), { horizontal: 'center', bold: true, vertical: 'middle' });
                applyCellStyle(headerRow1.getCell(3 + daysInMonth + 1), { horizontal: 'center', bold: true, vertical: 'middle' });
                
                // Строка 12: основные заголовки (Должность, ФИО, дни недели, Отработано)
                applyCellStyle(headerRow2.getCell(1), { horizontal: 'center', bold: true, vertical: 'middle' });
                applyCellStyle(headerRow2.getCell(2), { horizontal: 'center', bold: true, vertical: 'middle' });
                applyCellStyle(headerRow2.getCell(3), { horizontal: 'center', bold: true, vertical: 'middle' });
                // Ячейка AI12 (столбец "Отработано за месяц. час." в строке 12) с переносом текста
                const totalHoursHeaderCell = headerRow2.getCell(3 + daysInMonth + 1);
                applyCellStyle(totalHoursHeaderCell, { horizontal: 'center', bold: true, fontSize: 8, vertical: 'middle', wrapText: true });
                // Жирные границы для ячейки AI12 (все границы жирные, включая левую)
                totalHoursHeaderCell.border = {
                    top: { style: 'medium', color: { argb: 'FF000000' } },
                    left: { style: 'medium', color: { argb: 'FF000000' } },
                    bottom: { style: 'medium', color: { argb: 'FF000000' } },
                    right: { style: 'medium', color: { argb: 'FF000000' } }
                };
                
                // Жирная левая граница для ячейки "Отработано" в строке 11
                const totalHoursHeaderCellRow11 = headerRow1.getCell(3 + daysInMonth + 1);
                if (totalHoursHeaderCellRow11.border) {
                    totalHoursHeaderCellRow11.border.left = { style: 'medium', color: { argb: 'FF000000' } };
                } else {
                    totalHoursHeaderCellRow11.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'medium', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                }
                
                // Жирная верхняя граница для всей строки 12
                for (let col = 1; col <= 3 + daysInMonth + 1; col++) {
                    const cell = headerRow2.getCell(col);
                    if (cell.border) {
                        cell.border.top = { style: 'medium', color: { argb: 'FF000000' } };
                    } else {
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };
                    }
                }

                // Функция для форматирования ФИО в формат "Фамилия И.О."
                function formatNameShort(fullName) {
                    if (!fullName) return '';
                    const parts = fullName.trim().split(/\s+/);
                    if (parts.length === 0) return '';
                    if (parts.length === 1) return parts[0];
                    
                    const lastName = parts[0];
                    const initials = parts.slice(1).map(part => {
                        if (part.length > 0) {
                            return part[0] + '.';
                        }
                        return '';
                    }).join('');
                    
                    return `${lastName} ${initials}`.trim();
                }

                // Данные для каждого сотрудника
                employees.forEach((employee, empIndex) => {
                    const position = employee.position || '';
                    const name = formatNameShort(employee.name || '');
                    const employeeTotalHours = calculateTotalHours(employee);
                    const totalShifts = calculateTotalShifts(employee);
                    const employeeStartRow = currentRow;
                    
                    // Запоминаем номера строк для блока сотрудника (4 строки) для жирных границ
                    const empBlockStartRow = currentRow; // Начало работы
                    const empBlockEndRow = currentRow + 3; // Количество часов (последняя строка блока)

                    // Строка "Начало работы"
                    const startRow = worksheet.getRow(currentRow++);
                    startRow.getCell(1).value = position; // Должность только в первой строке
                    startRow.getCell(2).value = name; // ФИО только в первой строке
                    startRow.getCell(3).value = 'Начало работы';
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayValue = getDisplayValue(employee, day);
                        let startTime = null; // null вместо пустой строки для чисел
                        let bgColor = null;
                        
                        const absence = getAbsenceForDay(name, day);
                        if (absence) {
                            // Для отсутствий оставляем текст (символ)
                            startTime = absence.symbol;
                            bgColor = absence.color.replace('#', 'FF');
                        } else if (dayValue) {
                            const match = dayValue.match(/(\d+)-(\d+)/);
                            if (match) {
                                startTime = parseInt(match[1]); // Число, а не строка
                            }
                        }
                        const cell = startRow.getCell(3 + day);
                        if (absence) {
                            cell.value = startTime; // Текст для отсутствий
                        } else {
                            cell.value = startTime !== null ? startTime : null; // Число или null
                            if (startTime !== null) {
                                cell.numFmt = '0'; // Числовой формат
                            }
                        }
                        const date = new Date(currentYear, currentMonth, day);
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        if (!bgColor && isWeekend) {
                            bgColor = 'FFFFE4CC'; // Светло-оранжевый для выходных
                        }
                        applyCellStyle(cell, { 
                            bgColor: bgColor, 
                            bold: !!absence,
                            horizontal: 'center',
                            vertical: 'middle'
                        });
                        
                    }
                    startRow.getCell(3 + daysInMonth + 1).value = ''; // Пустая в строке "Начало работы"
                    // Применяем стили к ячейкам строки (только один раз после цикла)
                    applyCellStyle(startRow.getCell(1), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(startRow.getCell(2), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(startRow.getCell(3), { horizontal: 'left', vertical: 'middle' });
                    applyCellStyle(startRow.getCell(3 + daysInMonth + 1), { horizontal: 'center', vertical: 'middle' });

                    // Строка "Окончание работы"
                    const endRow = worksheet.getRow(currentRow++);
                    // Если подработчик, добавляем "подработка" в ячейку должности
                    if (employee.isSubcontractor) {
                        const podrabotkaCell = endRow.getCell(1);
                        podrabotkaCell.value = 'подработка';
                        // Убираем жирный шрифт и делаем красным
                        applyCellStyle(podrabotkaCell, { horizontal: 'left', vertical: 'middle', bold: false, fontColor: 'FFFF0000' });
                    }
                    endRow.getCell(3).value = 'Окончание работы';
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayValue = getDisplayValue(employee, day);
                        let endTime = null; // null вместо пустой строки для чисел
                        let bgColor = null;
                        
                        const absence = getAbsenceForDay(name, day);
                        if (absence) {
                            // Для отсутствий отображаем символ
                            endTime = absence.symbol;
                            bgColor = absence.color === '#fff3cd' ? 'FFFFF3CD' : 'FFF8D7DA';
                        } else if (dayValue) {
                            const match = dayValue.match(/(\d+)-(\d+)/);
                            if (match) {
                                endTime = parseInt(match[2]); // Число, а не строка
                            }
                        }
                        const cell = endRow.getCell(3 + day);
                        if (absence) {
                            cell.value = endTime; // Текст для отсутствий
                        } else {
                            cell.value = endTime !== null ? endTime : null; // Число или null
                            if (endTime !== null) {
                                cell.numFmt = '0'; // Числовой формат
                            }
                        }
                        const date = new Date(currentYear, currentMonth, day);
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        if (!bgColor && isWeekend) {
                            bgColor = 'FFFFE4CC'; // Светло-оранжевый для выходных
                        }
                        applyCellStyle(cell, { bgColor: bgColor, horizontal: 'center', vertical: 'middle' });
                    }
                    endRow.getCell(3 + daysInMonth + 1).value = '';
                    // Применяем стили к ячейкам строки (только один раз после цикла)
                    // Восстанавливаем границы для всех ячеек строки
                    // Если не подработчик, применяем обычный стиль к ячейке должности
                    if (!employee.isSubcontractor) {
                        applyCellStyle(endRow.getCell(1), { horizontal: 'left', vertical: 'middle', bold: true });
                    }
                    applyCellStyle(endRow.getCell(2), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(endRow.getCell(3), { horizontal: 'left', vertical: 'middle' });
                    applyCellStyle(endRow.getCell(3 + daysInMonth + 1), { horizontal: 'center', vertical: 'middle' });

                    // Строка "Перерыв на обед"
                    const breakRow = worksheet.getRow(currentRow++);
                    // Должность и ФИО только в первой строке, здесь не заполняем
                    breakRow.getCell(3).value = 'Перерыв на обед';
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayValue = getDisplayValue(employee, day);
                        let breakHour = null; // null вместо пустой строки для чисел
                        let bgColor = null;
                        
                        const absence = getAbsenceForDay(name, day);
                        if (absence) {
                            // Для отсутствий отображаем символ
                            breakHour = absence.symbol;
                            bgColor = absence.color === '#fff3cd' ? 'FFFFF3CD' : 'FFF8D7DA';
                        } else if (dayValue) {
                            breakHour = 1; // Число, а не строка
                        }
                        const cell = breakRow.getCell(3 + day);
                        if (absence) {
                            cell.value = breakHour; // Текст для отсутствий
                        } else {
                            cell.value = breakHour !== null ? breakHour : null; // null вместо пустой строки для чисел
                            // Устанавливаем числовой формат для ячейки с числом
                            if (breakHour !== null) {
                                cell.numFmt = '0'; // Числовой формат без десятичных знаков
                            }
                        }
                        const date = new Date(currentYear, currentMonth, day);
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        if (!bgColor && isWeekend) {
                            bgColor = 'FFFFE4CC'; // Светло-оранжевый для выходных
                        }
                        applyCellStyle(cell, { bgColor: bgColor, horizontal: 'center', vertical: 'middle' });
                        
                    }
                    // Количество смен НЕ отображаем в Excel
                    const totalShiftsCell = breakRow.getCell(3 + daysInMonth + 1);
                    totalShiftsCell.value = null; // Пустая ячейка
                    // Применяем стили к ячейкам строки (только один раз после цикла)
                    // Восстанавливаем границы для всех ячеек строки
                    applyCellStyle(breakRow.getCell(1), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(breakRow.getCell(2), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(breakRow.getCell(3), { horizontal: 'left', vertical: 'middle' });
                    applyCellStyle(breakRow.getCell(3 + daysInMonth + 1), { horizontal: 'center', vertical: 'middle' });

                    // Строка "Количество часов"
                    const hoursRow = worksheet.getRow(currentRow++);
                    // Должность и ФИО только в первой строке, здесь не заполняем
                    hoursRow.getCell(3).value = 'Количество часов';
                    
                    // Получаем буквенные обозначения столбцов (A=1, B=2, ..., Z=26, AA=27, AB=28, ...)
                    function getColumnLetter(colNum) {
                        let result = '';
                        let num = colNum;
                        while (num > 0) {
                            num--;
                            result = String.fromCharCode(65 + (num % 26)) + result;
                            num = Math.floor(num / 26);
                        }
                        return result;
                    }
                    
                    // Номера строк для формул
                    const startRowNum = startRow.number; // Строка "Начало работы"
                    const endRowNum = endRow.number; // Строка "Окончание работы"
                    const breakRowNum = breakRow.number; // Строка "Перерыв на обед"
                    const hoursRowNum = hoursRow.number; // Строка "Количество часов"
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayCol = 3 + day; // Столбец для дня (D=4, E=5, ...)
                        const dayColLetter = getColumnLetter(dayCol);
                        
                        let bgColor = null;
                        const absence = getAbsenceForDay(name, day);
                        if (absence) {
                            bgColor = absence.color === '#fff3cd' ? 'FFFFF3CD' : 'FFF8D7DA';
                        }
                        
                        const cell = hoursRow.getCell(dayCol);
                        
                        // Если есть больничный или отпуск, НЕ создаем формулу, оставляем пустым
                        if (absence) {
                            // Для больничных/отпусков не создаем формулу, оставляем пустым
                            cell.value = null;
                        } else {
                            // Формула: =D14-D13-D15 (окончание - начало - перерыв)
                            // Где D13 - начало работы, D14 - окончание, D15 - перерыв, D16 - количество часов
                            const formula = `${dayColLetter}${endRowNum}-${dayColLetter}${startRowNum}-${dayColLetter}${breakRowNum}`;
                            cell.value = { formula: formula };
                            cell.numFmt = '0'; // Числовой формат
                        }
                        
                        const date = new Date(currentYear, currentMonth, day);
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        if (!bgColor && isWeekend) {
                            bgColor = 'FFFFE4CC'; // Светло-оранжевый для выходных
                        }
                        applyCellStyle(cell, { bgColor: bgColor, horizontal: 'center', vertical: 'middle' });
                    }
                    
                    // В столбце "Отработано за месяц. час." добавляем формулу SUM для суммирования всех формул в строке "Количество часов"
                    const hoursCol = 3 + daysInMonth + 1; // Столбец "Отработано за месяц. час."
                    const firstDayCol = 4; // Первый столбец с днем месяца (D = столбец 4)
                    const lastDayCol = 3 + daysInMonth; // Последний столбец с днем месяца
                    
                    const firstColLetter = getColumnLetter(firstDayCol);
                    const lastColLetter = getColumnLetter(lastDayCol);
                    const rowNum = hoursRow.number;
                    // Формула SUM для суммирования всех формул в строке "Количество часов"
                    const formula = `SUM(${firstColLetter}${rowNum}:${lastColLetter}${rowNum})`;
                    const formulaCell = hoursRow.getCell(hoursCol);
                    
                    // Применяем стили к ячейкам строки ПЕРЕД установкой формулы
                    applyCellStyle(hoursRow.getCell(1), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(hoursRow.getCell(2), { horizontal: 'left', vertical: 'middle', bold: true });
                    applyCellStyle(hoursRow.getCell(3), { horizontal: 'left', vertical: 'middle' });
                    
                    // Устанавливаем формулу через value = { formula: '...' } (правильный синтаксис ExcelJS)
                    formulaCell.value = { formula: formula };
                    
                    // Применяем стиль к ячейке с формулой ПОСЛЕ установки формулы
                    applyCellStyle(formulaCell, { horizontal: 'center', vertical: 'middle' });

                    // Должность и ФИО НЕ объединяем - они должны быть в каждой строке отдельно
                    // Столбец "Отработано за месяц. час." НЕ объединяем - каждая строка имеет свою ячейку
                    // Пустые строки между сотрудниками убраны - следующий сотрудник идет сразу после
                    
                    // Жирная левая граница для столбца "Отработано за месяц. час." (все 4 строки блока)
                    const totalCol = 3 + daysInMonth + 1; // Столбец "Отработано за месяц. час."
                    for (let borderRowNum = empBlockStartRow; borderRowNum <= empBlockEndRow; borderRowNum++) {
                        const borderRow = worksheet.getRow(borderRowNum);
                        const totalCell = borderRow.getCell(totalCol);
                        if (totalCell.border) {
                            totalCell.border.left = { style: 'medium', color: { argb: 'FF000000' } };
                        } else {
                            totalCell.border = {
                                top: { style: 'thin', color: { argb: 'FF000000' } },
                                left: { style: 'medium', color: { argb: 'FF000000' } },
                                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                                right: { style: 'thin', color: { argb: 'FF000000' } }
                            };
                        }
                    }
                    
                    // Жирные границы по контуру для блока сотрудника (4 строки)
                    // Верхняя граница первой строки (Начало работы)
                    for (let col = 1; col <= 3 + daysInMonth + 1; col++) {
                        const cell = worksheet.getRow(empBlockStartRow).getCell(col);
                        if (cell.border) {
                            cell.border.top = { style: 'medium', color: { argb: 'FF000000' } };
                        } else {
                            cell.border = {
                                top: { style: 'medium', color: { argb: 'FF000000' } },
                                left: { style: 'thin', color: { argb: 'FF000000' } },
                                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                                right: { style: 'thin', color: { argb: 'FF000000' } }
                            };
                        }
                    }
                    
                    // Нижняя граница последней строки (Количество часов)
                    for (let col = 1; col <= 3 + daysInMonth + 1; col++) {
                        const cell = worksheet.getRow(empBlockEndRow).getCell(col);
                        if (cell.border) {
                            cell.border.bottom = { style: 'medium', color: { argb: 'FF000000' } };
                        } else {
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FF000000' } },
                                left: { style: 'thin', color: { argb: 'FF000000' } },
                                bottom: { style: 'medium', color: { argb: 'FF000000' } },
                                right: { style: 'thin', color: { argb: 'FF000000' } }
                            };
                        }
                    }
                    
                    // Левая и правая границы для всех 4 строк блока сотрудника
                    for (let rowNum = empBlockStartRow; rowNum <= empBlockEndRow; rowNum++) {
                        const row = worksheet.getRow(rowNum);
                        // Левая граница (столбец A)
                        const leftCell = row.getCell(1);
                        if (leftCell.border) {
                            leftCell.border.left = { style: 'medium', color: { argb: 'FF000000' } };
                        } else {
                            leftCell.border = {
                                top: { style: 'thin', color: { argb: 'FF000000' } },
                                left: { style: 'medium', color: { argb: 'FF000000' } },
                                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                                right: { style: 'thin', color: { argb: 'FF000000' } }
                            };
                        }
                        
                        // Правая граница (столбец AI - последний столбец таблицы)
                        const rightCell = row.getCell(3 + daysInMonth + 1);
                        if (rightCell.border) {
                            rightCell.border.right = { style: 'medium', color: { argb: 'FF000000' } };
                        } else {
                            rightCell.border = {
                                top: { style: 'thin', color: { argb: 'FF000000' } },
                                left: { style: 'thin', color: { argb: 'FF000000' } },
                                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                                right: { style: 'medium', color: { argb: 'FF000000' } }
                            };
                        }
                    }
                });
                
                // Последняя строка таблицы (последний сотрудник, строка "Количество часов")
                const lastTableRow = currentRow - 1; // Последняя строка с данными
                const lastRow = worksheet.getRow(lastTableRow);
                
                // Жирная нижняя граница для всей последней строки таблицы
                for (let col = 1; col <= 3 + daysInMonth + 1; col++) {
                    const cell = lastRow.getCell(col);
                    if (cell.border) {
                        cell.border.bottom = { style: 'medium', color: { argb: 'FF000000' } };
                    } else {
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'medium', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };
                    }
                }
                
                // Жирные боковые границы и правая граница столбца C для всех строк таблицы (начиная со строки 12)
                for (let rowNum = 12; rowNum <= lastTableRow; rowNum++) {
                    const row = worksheet.getRow(rowNum);
                    
                    // Левая граница столбца A (столбец 1)
                    const leftCell = row.getCell(1);
                    if (leftCell.border) {
                        leftCell.border.left = { style: 'medium', color: { argb: 'FF000000' } };
                    } else {
                        leftCell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'medium', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };
                    }
                    
                    // Правая граница столбца AI (последний столбец таблицы)
                    const rightCell = row.getCell(3 + daysInMonth + 1);
                    if (rightCell.border) {
                        rightCell.border.right = { style: 'medium', color: { argb: 'FF000000' } };
                    } else {
                        rightCell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'medium', color: { argb: 'FF000000' } }
                        };
                    }
                    
                    // Правая граница столбца C (столбец 3)
                    const colCCell = row.getCell(3);
                    if (colCCell.border) {
                        colCCell.border.right = { style: 'medium', color: { argb: 'FF000000' } };
                    } else {
                        colCCell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'medium', color: { argb: 'FF000000' } }
                        };
                    }
                }

                // Вычисляем адаптивную ширину для столбца ФИО (столбец 2)
                let maxFioWidth = 10; // Минимальная ширина
                for (let rowNum = 13; rowNum < currentRow; rowNum++) {
                    const row = worksheet.getRow(rowNum);
                    const fioCell = row.getCell(2);
                    if (fioCell.value && typeof fioCell.value === 'string') {
                        // Примерная ширина: 1 символ ≈ 1.2 единицы ширины Excel
                        const textWidth = fioCell.value.length * 1.2;
                        if (textWidth > maxFioWidth) {
                            maxFioWidth = textWidth;
                        }
                    }
                }
                // Устанавливаем адаптивную ширину для столбца ФИО
                worksheet.getColumn(2).width = Math.max(maxFioWidth, 10); // Минимум 10
                
                // Добавляем три пустые строки перед разделом "Ознакомлены/Согласовано"
                const emptyRow1 = worksheet.getRow(currentRow++);
                const emptyRow2 = worksheet.getRow(currentRow++);
                const emptyRow3 = worksheet.getRow(currentRow++);
                
                // Добавляем раздел "Ознакомлены/Согласовано"
                const ackTitleRow = worksheet.getRow(currentRow++);
                ackTitleRow.getCell(1).value = 'Ознакомлены/Согласовано:';
                applyCellStyle(ackTitleRow.getCell(1), { horizontal: 'left', vertical: 'middle', bold: true, noBorder: true });
                
                // Добавляем две пустые строки после "Ознакомлены/Согласовано:"
                const ackEmptyRow1 = worksheet.getRow(currentRow++);
                const ackEmptyRow2 = worksheet.getRow(currentRow++);
                
                // Сначала добавляем Менеджера по персоналу Востокова Ю.В.
                const managerRow = worksheet.getRow(currentRow++);
                managerRow.getCell(1).value = 'Менеджер по персоналу';
                managerRow.getCell(2).value = 'Востокова Ю.В.';
                managerRow.getCell(3).value = ''; // Без текста "(подпись)"
                
                // Применяем стили без границ, затем добавляем только нижнюю границу
                applyCellStyle(managerRow.getCell(1), { horizontal: 'left', vertical: 'middle', noBorder: true, wrapText: true });
                applyCellStyle(managerRow.getCell(2), { horizontal: 'left', vertical: 'middle', noBorder: true });
                applyCellStyle(managerRow.getCell(3), { horizontal: 'center', vertical: 'middle', noBorder: true });
                
                // Добавляем нижнюю границу для всех трех ячеек
                managerRow.getCell(1).border = {
                    bottom: { style: 'thin', color: { argb: 'FF000000' } }
                };
                managerRow.getCell(2).border = {
                    bottom: { style: 'thin', color: { argb: 'FF000000' } }
                };
                managerRow.getCell(3).border = {
                    bottom: { style: 'thin', color: { argb: 'FF000000' } }
                };
                
                // Пустая строка после менеджера
                const emptyRowAfterManager = worksheet.getRow(currentRow++);
                emptyRowAfterManager.getCell(1).value = '';
                emptyRowAfterManager.getCell(2).value = '';
                emptyRowAfterManager.getCell(3).value = '';
                
                // Затем добавляем сотрудников аптеки
                employees.slice(0, 7).forEach((emp, empIndex) => {
                    // Столбец A: должность
                    const position = emp.position || '(должность)';
                    // Столбец B: ФИО в формате "Фамилия И.О."
                    const formattedName = formatNameShort(emp.name || '');
                    
                    // Строка: должность, ФИО, пусто - все с нижней границей
                    const row = worksheet.getRow(currentRow++);
                    row.getCell(1).value = position;
                    row.getCell(2).value = formattedName;
                    row.getCell(3).value = ''; // Без текста "(подпись)"
                    
                    // Применяем стили без границ, затем добавляем только нижнюю границу
                    applyCellStyle(row.getCell(1), { horizontal: 'left', vertical: 'middle', noBorder: true });
                    applyCellStyle(row.getCell(2), { horizontal: 'left', vertical: 'middle', noBorder: true });
                    applyCellStyle(row.getCell(3), { horizontal: 'center', vertical: 'middle', noBorder: true });
                    
                    // Добавляем нижнюю границу для всех трех ячеек
                    row.getCell(1).border = {
                        bottom: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                    row.getCell(2).border = {
                        bottom: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                    row.getCell(3).border = {
                        bottom: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                    
                    // Добавляем пустую строку между сотрудниками (кроме последнего)
                    if (empIndex < employees.slice(0, 7).length - 1) {
                        const emptyRow = worksheet.getRow(currentRow++);
                        emptyRow.getCell(1).value = '';
                        emptyRow.getCell(2).value = '';
                        emptyRow.getCell(3).value = '';
                    }
                });
                
                // Добавляем две пустые строки после списка сотрудников
                const bottomEmptyRow1 = worksheet.getRow(currentRow++);
                const bottomEmptyRow2 = worksheet.getRow(currentRow++);

                // Формируем имя файла
                let fileName = 'График_сотрудников';
                if (pharmacyNumberText && pharmacyNumberText !== '-- Не выбрано --') {
                    fileName = `График_${pharmacyNumberText}_${monthNameUpper}_${currentYear}`;
                }
                
                console.log('Создание файла:', fileName);
                
                // Сохраняем файл
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${fileName}.xlsx`;
                link.click();
                window.URL.revokeObjectURL(url);
                
                console.log('Файл создан успешно');
                
                if (typeof showMessage === 'function') {
            showMessage('Экспортировано в Excel!');
                } else {
                    alert('Экспортировано в Excel!');
                }
            } catch (error) {
                console.error('Ошибка при экспорте в Excel:', error);
                console.error('Стек ошибки:', error.stack);
                alert('Произошла ошибка при экспорте: ' + error.message + '\n\nПроверьте консоль браузера (F12) для подробностей.');
            }
        };

        async function printSchedule() {
            // Загружаем данные об отсутствиях, если они еще не загружены
            if (!absenceData || Object.keys(absenceData).length === 0) {
                try {
                    const absenceDataValue = await firebaseGetItem('absenceData') || {};
                    absenceData = typeof absenceDataValue === 'string' ? JSON.parse(absenceDataValue) : absenceDataValue;
                } catch (e) {
                    console.warn('Не удалось загрузить данные об отсутствиях:', e);
                    absenceData = {};
                }
            }
            
            // Получаем данные для печати
            const pharmacySelect = document.getElementById('pharmacyNumber');
            const pharmacyAddressInput = document.getElementById('pharmacyAddress');
            
            let pharmacyNumberText = '-- Не выбрано --';
            let pharmacyAddress = '';
            let pharmacyId = null;
            
            if (pharmacySelect && pharmacySelect.selectedIndex >= 0) {
                pharmacyId = pharmacySelect.value;
                const optionText = pharmacySelect.options[pharmacySelect.selectedIndex].text;
                const match = optionText.match(/Аптека\s*№\s*(.+)/);
                pharmacyNumberText = match ? match[1].trim() : optionText.replace(/^Аптека\s*№\s*/, '').trim();
                
                // Берем адрес из справочника аптек
                if (pharmacyId && pharmacyId !== '--' && typeof pharmacyReference !== 'undefined' && pharmacyReference) {
                    const ph = pharmacyReference.find(p => p.id === pharmacyId);
                    if (ph && ph.address) {
                        pharmacyAddress = ph.address;
                    }
                }
            }
            
            if (!pharmacyAddress && pharmacyAddressInput) {
                pharmacyAddress = pharmacyAddressInput.value || '';
            }
            
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const monthName = monthNames[currentMonth] || 'Месяц';
            const monthNameUpper = monthName.toUpperCase();
            const weekDays = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];
            
            // Функция для проверки отсутствия сотрудника на конкретный день
            function getAbsenceForDay(employeeName, day) {
                if (!absenceData || !absenceData[employeeName]) return null;
                const checkDate = new Date(currentYear, currentMonth, day);
                for (let absence of absenceData[employeeName]) {
                    const startDate = new Date(absence.startDate);
                    const endDate = new Date(absence.endDate);
                    if (checkDate >= startDate && checkDate <= endDate) {
                        return {
                            symbol: absence.type === 'vacation' ? 'О' : 'Б',
                            color: absence.type === 'vacation' ? '#fff3cd' : '#f8d7da'
                        };
                    }
                }
                return null;
            }
            
            // Функция для форматирования ФИО в формат "Фамилия И.О."
            function formatNameShort(fullName) {
                if (!fullName) return '';
                const parts = fullName.trim().split(/\s+/);
                if (parts.length === 0) return '';
                if (parts.length === 1) return parts[0];
                
                const lastName = parts[0];
                const initials = parts.slice(1).map(part => {
                    if (part.length > 0) {
                        return part[0] + '.';
                    }
                    return '';
                }).join('');
                
                return `${lastName} ${initials}`.trim();
            }
            
            // Проверяем, есть ли хотя бы один сотрудник, работающий в каждый день
            // Если в день никто не работает - столбец должен быть розовым
            const daysWithNoWorkers = {};
            for (let day = 1; day <= daysInMonth; day++) {
                let hasWorker = false;
                // Проверяем всех сотрудников из глобального массива employees
                if (employees && employees.length > 0) {
                    for (let emp of employees) {
                        if (!emp || !emp.name) continue;
                        const dayValue = getDisplayValue(emp, day);
                        const absence = getAbsenceForDay(emp.name, day);
                        // Если есть смена (dayValue) или отсутствие - значит сотрудник "занят" в этот день
                        if (dayValue || absence) {
                            hasWorker = true;
                            break;
                        }
                    }
                }
                daysWithNoWorkers[day] = !hasWorker; // true если никто не работает
            }
            
            // Генерируем заголовки дней (строка 11 - даты)
            // ВАЖНО: генерируем ровно daysInMonth ячеек
            let dayHeadersRow11 = '';
            for (let day = 1; day <= daysInMonth; day++) {
                let bgColor = '';
                // Подсвечиваем только если в день никто не работает
                if (daysWithNoWorkers[day]) {
                    bgColor = 'background-color: #ffe4cc;';
                }
                dayHeadersRow11 += `<td style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; ${bgColor}">${day}</td>`;
            }
            
            // Генерируем заголовки дней недели (строка 12)
            // ВАЖНО: генерируем ровно daysInMonth ячеек
            let weekDayHeadersRow12 = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const weekDay = weekDays[new Date(currentYear, currentMonth, day).getDay()];
                let bgColor = '';
                // Подсвечиваем только если в день никто не работает
                if (daysWithNoWorkers[day]) {
                    bgColor = 'background-color: #ffe4cc;';
                }
                weekDayHeadersRow12 += `<td style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; ${bgColor}">${weekDay}</td>`;
            }
            
            // Генерируем строки таблицы для каждого сотрудника
            let tableRows = '';
            employees.forEach((employee) => {
                const position = employee.position || '';
                const name = formatNameShort(employee.name || ''); // Форматируем ФИО
                const employeeTotalHours = calculateTotalHours(employee);
                const totalShifts = calculateTotalShifts(employee);
                
                // Строка "Начало работы" - здесь заполняем должность и ФИО
                // Жирные границы: верхняя, левая, правая (для контура блока)
                // Адаптивная ширина для столбцов Должность, ФИО, График (без width в inline стилях)
                let startRow = `<td style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; font-weight: bold; text-align: left; white-space: nowrap;">${position}</td>`;
                startRow += `<td style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; font-weight: bold; text-align: left; white-space: nowrap;">${name}</td>`;
                startRow += `<td style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;">Начало работы</td>`;
                // ВАЖНО: генерируем ровно daysInMonth ячеек для дней
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDisplayValue(employee, day);
                    let bgColor = '';
                    let startTime = '';
                    
                    // Проверяем отсутствие (отпуск/больничный) - имеет приоритет
                    const absence = getAbsenceForDay(employee.name || '', day);
                    if (absence) {
                        bgColor = `background-color: ${absence.color};`;
                        startTime = absence.symbol;
                    } else if (daysWithNoWorkers[day]) {
                        // Если в день никто не работает - розовое выделение ВСЕГО СТОЛБЦА (ВСЕГДА)
                        bgColor = 'background-color: #ffe4cc;';
                        // Показываем время, если есть
                        if (dayValue) {
                            const match = dayValue.match(/(\d+)-(\d+)/);
                            if (match) {
                                startTime = match[1];
                            }
                        }
                    } else if (dayValue) {
                        // Если есть смена - показываем время, без выделения
                        const match = dayValue.match(/(\d+)-(\d+)/);
                        if (match) {
                            startTime = match[1];
                        }
                    }
                    // ВАЖНО: добавляем ячейку для КАЖДОГО дня, независимо от условий
                    startRow += `<td style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: ${absence ? 'bold' : 'normal'}; ${bgColor}">${startTime || ''}</td>`;
                }
                // Пустая ячейка для итогового столбца с жирными границами, уменьшенная в 2 раза с переносом текста
                startRow += `<td style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-size: 7px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;"></td></tr>`;
                
                // Строка "Окончание работы" - пустые ячейки для должности и ФИО, но если подработчик - показываем "подработка" красным
                let endRow = `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;">${employee.isSubcontractor ? '<span style="color: red;">подработка</span>' : ''}</td>`;
                endRow += `<td style="border: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;"></td>`;
                endRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;">Окончание работы</td>`;
                // ВАЖНО: генерируем ровно daysInMonth ячеек для дней
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDisplayValue(employee, day);
                    let bgColor = '';
                    let endTime = '';
                    
                    // Проверяем отсутствие (отпуск/больничный) - имеет приоритет
                    const absence = getAbsenceForDay(employee.name || '', day);
                    if (absence) {
                        bgColor = `background-color: ${absence.color};`;
                        endTime = absence.symbol; // Показываем символ в строке окончания
                    } else if (daysWithNoWorkers[day]) {
                        // Если в день никто не работает - розовое выделение ВСЕГО СТОЛБЦА (ВСЕГДА)
                        bgColor = 'background-color: #ffe4cc;';
                        // Показываем время, если есть
                        if (dayValue) {
                            const match = dayValue.match(/(\d+)-(\d+)/);
                            if (match) {
                                endTime = match[2];
                            }
                        }
                    } else if (dayValue) {
                        // Если есть смена - показываем время, без выделения
                        const match = dayValue.match(/(\d+)-(\d+)/);
                        if (match) {
                            endTime = match[2];
                        }
                    }
                    // ВАЖНО: добавляем ячейку для КАЖДОГО дня, независимо от условий
                    endRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; ${bgColor}">${endTime || ''}</td>`;
                }
                // Пустая ячейка для итогового столбца с жирной левой границей, уменьшенная в 2 раза с переносом текста
                endRow += `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-size: 7px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;"></td></tr>`;
                
                // Строка "Перерыв на обед" - пустые ячейки для должности и ФИО
                let breakRow = `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;"></td>`;
                breakRow += `<td style="border: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;"></td>`;
                breakRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; white-space: nowrap;">Перерыв на обед</td>`;
                // ВАЖНО: генерируем ровно daysInMonth ячеек для дней
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDisplayValue(employee, day);
                    let bgColor = '';
                    let breakHour = '';
                    
                    // Проверяем отсутствие (отпуск/больничный) - имеет приоритет
                    const absence = getAbsenceForDay(employee.name || '', day);
                    if (absence) {
                        bgColor = `background-color: ${absence.color};`;
                        breakHour = absence.symbol; // Показываем символ в строке перерыва
                    } else if (daysWithNoWorkers[day]) {
                        // Если в день никто не работает - розовое выделение ВСЕГО СТОЛБЦА (ВСЕГДА)
                        bgColor = 'background-color: #ffe4cc;';
                        // Показываем перерыв, если есть смена
                        if (dayValue) {
                            breakHour = '1';
                        }
                    } else if (dayValue) {
                        // Если есть смена - показываем перерыв, без выделения
                        breakHour = '1';
                    }
                    // ВАЖНО: добавляем ячейку для КАЖДОГО дня, независимо от условий
                    breakRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; ${bgColor}">${breakHour || ''}</td>`;
                }
                // Пустая ячейка для итогового столбца (количество смен не показываем) с жирной левой границей, уменьшенная в 2 раза с переносом текста
                breakRow += `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-size: 7px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;"></td></tr>`;
                
                // Строка "Количество часов" - пустые ячейки для должности и ФИО
                // Жирные границы: нижняя, левая, правая (для контура блока)
                // Адаптивная ширина для столбцов Должность, ФИО, График (без width в inline стилях)
                let hoursRow = `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 2px solid #000; padding: 2px; text-align: left; white-space: nowrap;"></td>`;
                hoursRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 2px solid #000; padding: 2px; text-align: left; white-space: nowrap;"></td>`;
                hoursRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 2px solid #000; padding: 2px; text-align: left; white-space: nowrap;">Количество часов</td>`;
                // ВАЖНО: генерируем ровно daysInMonth ячеек для дней
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDisplayValue(employee, day);
                    let bgColor = '';
                    let hours = '';
                    
                    // Проверяем отсутствие (отпуск/больничный) - имеет приоритет
                    const absence = getAbsenceForDay(employee.name || '', day);
                    if (absence) {
                        bgColor = `background-color: ${absence.color};`;
                        hours = ''; // В строке часов не показываем символ и не считаем часы
                    } else if (daysWithNoWorkers[day]) {
                        // Если в день никто не работает - розовое выделение ВСЕГО СТОЛБЦА (ВСЕГДА)
                        bgColor = 'background-color: #ffe4cc;';
                        // Считаем часы, если есть смена
                        if (dayValue) {
                            const match = dayValue.match(/(\d+)-(\d+)/);
                            if (match) {
                                const start = parseInt(match[1]);
                                const end = parseInt(match[2]);
                                let dayHours = end - start - 1;
                                if (dayHours < 0) dayHours += 24;
                                if (dayHours > 0) {
                                    hours = dayHours.toString();
                                }
                            }
                        }
                    } else if (dayValue) {
                        // Если есть смена - считаем часы, без выделения
                        const match = dayValue.match(/(\d+)-(\d+)/);
                        if (match) {
                            const start = parseInt(match[1]);
                            const end = parseInt(match[2]);
                            let dayHours = end - start - 1;
                            if (dayHours < 0) dayHours += 24;
                            if (dayHours > 0) {
                                hours = dayHours.toString();
                            }
                        }
                    }
                    // ВАЖНО: добавляем ячейку для КАЖДОГО дня, независимо от условий
                    hoursRow += `<td style="border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 2px solid #000; padding: 2px; text-align: center; ${bgColor}">${hours || ''}</td>`;
                }
                // Итоговая сумма часов с жирными границами, уменьшенная в 2 раза с переносом текста
                hoursRow += `<td style="border-top: 1px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 2px solid #000; padding: 2px; text-align: center; font-size: 7px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${employeeTotalHours > 0 ? employeeTotalHours : ''}</td></tr>`;
                
                tableRows += `<tr>${startRow}`;
                tableRows += `<tr>${endRow}`;
                tableRows += `<tr>${breakRow}`;
                tableRows += `<tr>${hoursRow}`;
            });
            
            // Создаем HTML для печати
            const printWindow = window.open('', '', 'height=600,width=1200');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>График сотрудников</title>
                    <style>
                        @media print {
                            @page {
                                size: A4 landscape;
                                margin: 0mm;
                                page-break-inside: avoid;
                            }
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            html {
                                height: 210mm;
                                width: 297mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                                width: 297mm;
                                height: 210mm;
                                overflow: hidden;
                                page-break-inside: avoid;
                            }
                            #printContainer {
                                width: 100%;
                                height: 100%;
                                page-break-inside: avoid;
                                page-break-after: avoid;
                            }
                            table {
                                font-size: 5px !important;
                                width: 100% !important;
                                border-collapse: collapse !important;
                                page-break-inside: avoid !important;
                            }
                            thead {
                                display: table-header-group;
                            }
                            tbody {
                                display: table-row-group;
                            }
                            tr {
                                page-break-inside: avoid !important;
                            }
                            td, th {
                                padding: 1px 1px !important;
                                font-size: 5px !important;
                                line-height: 1.0 !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 0;
                            color: #000;
                            font-size: 8px;
                            margin: 0;
                            width: 297mm;
                            height: 210mm;
                            overflow: hidden;
                        }
                        html {
                            width: 297mm;
                            height: 210mm;
                            margin: 0;
                            padding: 0;
                        }
                        .header-top {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 2px;
                        }
                        .header-left {
                            font-size: 8px;
                        }
                        .header-right {
                            text-align: right;
                            font-size: 8px;
                        }
                        .title {
                            text-align: center;
                            font-weight: bold;
                            font-size: 10px;
                            margin: 2px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 7px;
                            table-layout: auto; /* Адаптивная ширина столбцов */
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 1px;
                            text-align: center;
                        }
                        th {
                            background-color: #ffffff;
                            font-weight: normal;
                        }
                        /* Адаптивная ширина для столбцов Должность, ФИО, График - по количеству текста */
                        .schedule-table th:first-child,
                        .schedule-table td:first-child {
                            text-align: left !important;
                            white-space: nowrap !important;
                            width: 1px !important;
                        }
                        .schedule-table th:nth-child(2),
                        .schedule-table td:nth-child(2) {
                            text-align: left !important;
                            white-space: nowrap !important;
                            width: 1px !important;
                        }
                        .schedule-table th:nth-child(3),
                        .schedule-table td:nth-child(3) {
                            text-align: left !important;
                            white-space: nowrap !important;
                            width: 1px !important;
                        }
                        /* Столбец "Отработано за месяц. час." - уменьшен в 2 раза и с переносом текста */
                        .schedule-table th:last-child,
                        .schedule-table td:last-child {
                            font-size: 7px !important;
                            white-space: normal !important;
                            word-wrap: break-word !important;
                            overflow-wrap: break-word !important;
                            text-align: center !important;
                            width: 2.5% !important;
                            max-width: 2.5% !important;
                        }
                        .footer {
                            margin-top: 5px;
                            font-size: 9px;
                        }
                        .signature-line {
                            border-top: 1px solid #000;
                            width: 180px;
                            margin: 0 auto;
                            margin-top: 3px;
                            margin-bottom: 3px;
                        }
                    </style>
                </head>
                <body id="printBody">
                    <div id="printContainer" style="width: 100%; font-family: 'Arial Cyr', Arial, sans-serif; font-size: 8px;">
                        <!-- Строка 1: "Утвержден:" справа -->
                        <div style="text-align: right; margin-bottom: 1px;">
                            <span style="color: red; font-weight: bold; font-size: 8px;">Утвержден:</span>
                        </div>
                        
                        <!-- Строка 2: пустая -->
                        <div style="height: 1px;"></div>
                        
                        <!-- Строка 3: "Бочарова А.В." с линией - прижато к правому краю -->
                        <div style="text-align: right; margin-bottom: 1px;">
                            <div style="display: inline-block; border-bottom: 1px solid #000; padding: 0 15px; font-size: 8px;">
                                Бочарова А.В.
                            </div>
                        </div>
                        
                        <!-- Строка 4: пустая -->
                        <div style="height: 1px;"></div>
                        
                        <!-- Строка 5: "Директор региона Владимир" - прижато к правому краю -->
                        <div style="text-align: right; margin-bottom: 1px; font-size: 8px;">
                            Директор региона Владимир
                        </div>
                        
                        <!-- Строка 6: пустая -->
                        <div style="height: 1px;"></div>
                        
                        <!-- Строка 7: "Аптека №", номер, "Адрес:", адрес -->
                        <div style="margin-bottom: 1px; font-size: 8px;">
                            <span>Аптека №</span> <span>${pharmacyNumberText}</span> <span>Адрес:</span> <span>${pharmacyAddress}</span>
                        </div>
                        
                        <!-- Строка 8: пустая -->
                        <div style="height: 1px;"></div>
                        
                        <!-- Строка 9: "ГРАФИК СОТРУДНИКОВ..." заголовок -->
                        <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 1px;">
                            ГРАФИК СОТРУДНИКОВ А/П НА ${monthNameUpper} ${currentYear} г.
                        </div>
                        
                        <!-- Строка 10: пустая -->
                        <div style="height: 1px;"></div>
                        
                        <table class="schedule-table" style="border-collapse: collapse; width: 100%; font-size: 8px; table-layout: auto;">
                            <colgroup>
                                <col>
                                <col>
                                <col>
                                ${Array(daysInMonth).fill(0).map(() => '<col>').join('')}
                                <col style="width: 2.5%;">
                            </colgroup>
                            <thead>
                                <!-- Строка 11: пустые ячейки для Должность/ФИО, затем даты -->
                                <tr>
                                    <th style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold;"></th>
                                    <th style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold;"></th>
                                    <th style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold;"></th>
                                    ${dayHeadersRow11}
                                    <th style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold;"></th>
                                </tr>
                                <!-- Строка 12: основные заголовки -->
                                <tr>
                                    <th style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; font-weight: bold; white-space: nowrap;">Должность</th>
                                    <th style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; font-weight: bold; white-space: nowrap;">Ф.И.О. сотрудника</th>
                                    <th style="border-top: 2px solid #000; border-left: 1px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: left; font-weight: bold; white-space: nowrap;">График</th>
                                    ${weekDayHeadersRow12}
                                    <th style="border-top: 2px solid #000; border-left: 2px solid #000; border-right: 2px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; font-size: 7px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">Отработано за месяц. час.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                        
                        <!-- Три пустые строки перед "Ознакомлены/Согласовано" -->
                        <div style="height: 2px;"></div>
                        
                        <!-- Ознакомлены/Согласовано -->
                        <div style="margin-top: 2px; width: 25%; font-size: 7px;">
                            <div style="font-weight: bold; margin-bottom: 1px; font-size: 7px;">Ознакомлены/Согласовано:</div>
                            
                            <!-- Две пустые строки после заголовка -->
                            <div style="height: 1px;"></div>
                            
                            <!-- Менеджер по персоналу -->
                            <div style="display: flex; margin-bottom: 1px;">
                                <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px; font-size: 7px;">Менеджер по персоналу</div>
                                <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px; font-size: 7px;">Востокова Ю.В.</div>
                                <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px;"></div>
                            </div>
                            
                            <!-- Пустая строка после менеджера -->
                            <div style="height: 1px;"></div>
                            
                            <!-- Сотрудники аптеки -->
                            ${employees.slice(0, 7).map((emp) => {
                                const formattedName = formatNameShort(emp.name || '');
                                const position = emp.position || '(должность)';
                                return `
                                    <div style="display: flex; margin-bottom: 1px;">
                                        <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px; font-size: 7px;">${position}</div>
                                        <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px; font-size: 7px;">${formattedName}</div>
                                        <div style="flex: 1; border-bottom: 1px solid #000; padding: 1px;"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Устанавливаем альбомную ориентацию и автоматическое масштабирование
            printWindow.focus();
            
            // Ждем полной загрузки документа
            if (printWindow.document.readyState === 'complete') {
                setupAutoScaleAndPrint();
            } else {
                printWindow.onload = setupAutoScaleAndPrint;
            }
            
            function setupAutoScaleAndPrint() {
                try {
                    // Устанавливаем альбомную ориентацию через CSS
                    const orientationStyle = printWindow.document.createElement('style');
                    orientationStyle.id = 'printOrientationStyle';
                    orientationStyle.textContent = `
                        @media print {
                            @page {
                                size: A4 landscape !important;
                                margin: 0mm !important;
                            }
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                        }
                    `;
                    printWindow.document.head.appendChild(orientationStyle);
                    
                    // Вычисляем автоматический масштаб
                    const container = printWindow.document.getElementById('printContainer');
                    const table = printWindow.document.querySelector('.schedule-table');
                    
                    if (container && table) {
                        // Принудительно пересчитываем размеры
                        printWindow.document.body.style.overflow = 'hidden';
                        container.style.position = 'relative';
                        container.style.display = 'block';
                        
                        // Ждем пересчета размеров
                        setTimeout(() => {
                            // Размеры A4 landscape: 297mm x 210mm
                            const pageWidthMM = 297;
                            const pageHeightMM = 210;
                            const marginTopMM = 0;
                            const marginBottomMM = 0;
                            const marginLeftRightMM = 0;
                            const availableWidthMM = pageWidthMM - (marginLeftRightMM * 2);
                            const availableHeightMM = pageHeightMM - marginTopMM - marginBottomMM;
                            
                            // Получаем размеры контейнера
                            const containerRect = container.getBoundingClientRect();
                            const containerWidth = containerRect.width || container.scrollWidth || container.offsetWidth;
                            const containerHeight = containerRect.height || container.scrollHeight || container.offsetHeight;
                            
                            // Конвертируем мм в пиксели (при 96 DPI: 1mm = 3.7795px)
                            const mmToPx = 3.7795;
                            const availableWidthPx = availableWidthMM * mmToPx;
                            const availableHeightPx = availableHeightMM * mmToPx;
                            
                            // Вычисляем масштаб - строго по высоте, чтобы поместилось на одну страницу
                            const scaleX = containerWidth > 0 ? availableWidthPx / containerWidth : 1;
                            const scaleY = containerHeight > 0 ? availableHeightPx / containerHeight : 1;
                            // Приоритет высоте - чтобы не было разрыва страницы
                            let scale = Math.min(scaleX, scaleY, 1);
                            
                            // Проверка корректности масштаба
                            if (!isFinite(scale) || scale <= 0 || scale > 1) {
                                scale = 1;
                            }
                            
                            // Дополнительная проверка - если масштаб слишком большой, уменьшаем
                            if (scale > 1) {
                                scale = 1;
                            }
                            
                            // Добавляем стиль для печати с масштабом
                            const scaleStyle = printWindow.document.createElement('style');
                            scaleStyle.id = 'printScaleStyle';
                            scaleStyle.textContent = `
                                @media print {
                                    html, body {
                                        width: 297mm !important;
                                        height: 210mm !important;
                                        margin: 0 !important;
                                        padding: 0 !important;
                                        overflow: hidden !important;
                                    }
                                    #printContainer {
                                        transform: scale(${scale}) !important;
                                        transform-origin: top left !important;
                                        width: ${100 / scale}% !important;
                                        max-height: ${100 / scale}% !important;
                                        page-break-inside: avoid !important;
                                    }
                                }
                            `;
                            printWindow.document.head.appendChild(scaleStyle);
                            
                            // Применяем масштаб для предпросмотра
                            container.style.transform = `scale(${scale})`;
                            container.style.transformOrigin = 'top left';
                            container.style.width = `${100 / scale}%`;
                            container.style.maxHeight = `${100 / scale}%`;
                            container.style.overflow = 'hidden';
                            
                            // Печатаем
                            setTimeout(() => {
                                printWindow.focus();
                                printWindow.print();
                            }, 300);
                        }, 200);
                    } else {
                        // Если контейнер не найден, просто печатаем
                        setTimeout(() => {
                            printWindow.focus();
                            printWindow.print();
                        }, 300);
                    }
                } catch (error) {
                    console.error('Ошибка при настройке печати:', error);
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                    }, 300);
                }
            }
        }

        async function clearData() {
    if (!confirm('Очистить график для выбранной аптеки и месяца?')) return;
    const key = getScheduleKey(currentYear, currentMonth, currentPharmacyId);
    await firebaseRemoveItem(key);
    employees = [];
    if (typeof renderSchedule === 'function') renderSchedule();
    if (typeof showMessage === 'function') showMessage('График очищен для выбранной аптеки.');
}

        function showMessage(text) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message success';
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 2000);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Инициализация переменных
            await initializeVariables();
            
            // Установляем текущий месяц и год в select элементы
            document.getElementById('monthSelect').value = currentMonth.toString();
            document.getElementById('yearInput').value = currentYear.toString();
            updateMonthDisplay();
            
            buildTableHeader();
            
            // Загружаем все данные
            await loadData();
            await initializeDaysOff();
            await loadOffDaysData();
            await loadOffDaysStorage();
            await loadAbsenceData();
            await loadScheduleFor(currentYear, currentMonth, currentPharmacyId);
            
            // Обновляем селекты
            updateGraphicEmployeeSelect();
            updateGraphicPharmacySelect();
            
            // Подключаем кнопку экспорта альтернативным способом
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
                console.log('✅ Кнопка экспорта найдена, добавляю обработчик события');
                // Проверяем доступность функции
                console.log('Проверка функции exportToExcel:', typeof window.exportToExcel, typeof exportToExcel);
                
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🖱️ Кнопка экспорта нажата через addEventListener');
                    console.log('Проверка доступности функций:', {
                        'window.exportToExcel': typeof window.exportToExcel,
                        'exportToExcel': typeof exportToExcel,
                        'XLSX': typeof XLSX
                    });
                    
                    if (typeof window.exportToExcel === 'function') {
                        console.log('Вызов window.exportToExcel()');
                        window.exportToExcel();
                    } else if (typeof exportToExcel === 'function') {
                        console.log('Вызов exportToExcel()');
                        exportToExcel();
                    } else {
                        alert('Функция exportToExcel не найдена.\n\nПроверьте консоль браузера (F12) для подробностей.');
                        console.error('❌ Функция exportToExcel не определена');
                        console.log('Доступные функции в window:', Object.keys(window).filter(k => k.includes('export')));
                    }
                });
                
                // Также оставляем onclick для совместимости
                exportBtn.setAttribute('onclick', 'event.preventDefault(); if(typeof window.exportToExcel === "function") { window.exportToExcel(); } else if(typeof exportToExcel === "function") { exportToExcel(); } else { alert("Функция не найдена"); }');
            } else {
                console.warn('⚠️ Кнопка экспорта не найдена в DOM');
            }

            // Setup real-time listeners after initialization
            setupFirebaseListeners();
            
            // Рендерим график (всегда, даже если нет сотрудников - покажет пустую таблицу)
            // Небольшая задержка для гарантии готовности всех элементов DOM
            setTimeout(() => {
                if (typeof renderSchedule === 'function') {
                renderSchedule();
                } else {
                    console.error('renderSchedule function not found!');
            }
            }, 50);

            document.getElementById('btnSaveEmployee').onclick = addEmployeeFromModal;
            document.getElementById('btnDeleteEmployee').onclick = function() {
                if (!editingEmployeeId) {
                    showMessage('Ошибка: не выбран сотрудник');
                    return;
                }

                const employee = employees.find(e => e.id === editingEmployeeId);
                if (!employee) {
                    showMessage('Ошибка: сотрудник не найден');
                    return;
                }

                if (confirm(`Удалить сотрудника "${employee.name}"?`)) {
                    employees = employees.filter(e => e.id !== editingEmployeeId);
                    closeModal();
                    saveData().then(() => {
                    renderSchedule();
                        showMessage('Сотрудник удален');
                    });
                    showMessage('Сотрудник удалён!');
                }
            };

            window.onclick = function(event) {
                const addModal = document.getElementById('addEmployeeModal');
                const cellModal = document.getElementById('cellEditModal');
                const calModal = document.getElementById('calendarModal');
                
                if (event.target === addModal) {
                    closeModal();
                }
                if (event.target === cellModal) {
                    closeCellEdit();
                }
                if (event.target === calModal) {
                    closeCalendarModal();
                }
            }
        });
    
        window.addEventListener('load', loadData);
    
        let pharmacyReference = []; 
        let employeeReference = []; 

        // КРИТИЧНО: Функция для скрытия/показа поля "С какого дня"
        async function onScheduleChange() {
            await initializeDaysOff();
            await loadOffDaysStorage();
            const schedule = document.getElementById('modalSchedule').value;
            const startDayGroup = document.getElementById('startDayGroup');

            if (schedule === '2/2') {
                // Показываем поле для графика 2/2
                startDayGroup.style.display = 'block';
            } else {
                // Скрываем для других графиков (включая 5/2)
                startDayGroup.style.display = 'none';
            }
        }

        function openPharmaReferenceModal() {
            cancelEditPharmacy(); // Сбрасываем режим редактирования при открытии
            renderPharmacyList();
            document.getElementById('pharmacyReferenceModal').style.display = 'block';
        }

        function closePharmaReferenceModal() {
            document.getElementById('pharmacyReferenceModal').style.display = 'none';
        }

        let editingPharmacyId = null;
        let editingEmployeeId = null;

        function addPharmacyToReference() {
            const number = document.getElementById('newPharmacyNumber').value.trim();
            const address = document.getElementById('newPharmacyAddress').value.trim();
            if (!number || !address) { alert('Заполните все поля'); return; }
            
            if (editingPharmacyId) {
                // Редактирование существующей аптеки
                const existing = pharmacyReference.find(p => p.id === editingPharmacyId);
                if (!existing) {
                    editingPharmacyId = null;
                    return;
                }
                // Проверяем, не занят ли номер другой аптекой
                if (pharmacyReference.some(p => p.number === number && p.id !== editingPharmacyId)) {
                    alert('Аптека с таким номером уже существует'); 
                    return;
                }
                existing.number = number;
                existing.address = address;
                saveReferenceData(); // Используем отдельную функцию для справочников
                alert('Аптека обновлена!');
                cancelEditPharmacy(); // Сбрасываем режим редактирования
            } else {
                // Добавление новой аптеки
                if (pharmacyReference.some(p => p.number === number)) { 
                    alert('Аптека с таким номером уже существует'); 
                    return; 
                }
            pharmacyReference.push({id: 'ph_' + Date.now(), number, address});
            document.getElementById('newPharmacyNumber').value = '';
            document.getElementById('newPharmacyAddress').value = '';
                saveReferenceData(); // Используем отдельную функцию для справочников
                alert('Аптека добавлена!');
            }

            renderPharmacyList();
            updateGraphicPharmacySelect();
            updateRefPharmacySelect();
        }

        window.editPharmacyFromReference = function(id) {
            const pharmacy = pharmacyReference.find(p => p.id === id);
            if (!pharmacy) return;
            
            editingPharmacyId = id;
            document.getElementById('newPharmacyNumber').value = pharmacy.number;
            document.getElementById('newPharmacyAddress').value = pharmacy.address;
            
            const btn = document.querySelector('#pharmacyReferenceModal .btn-add-improved');
            if (btn) btn.textContent = 'Сохранить изменения';
            
            const cancelBtn = document.getElementById('cancelEditPharmacyBtn');
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            
            const title = document.querySelector('#pharmacyReferenceModal .section-title-improved');
            if (title) title.textContent = 'Редактировать аптеку';
            
            // Прокрутка к форме
            const form = document.querySelector('#pharmacyReferenceModal .add-section-improved');
            if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        window.cancelEditPharmacy = function() {
            editingPharmacyId = null;
            document.getElementById('newPharmacyNumber').value = '';
            document.getElementById('newPharmacyAddress').value = '';
            const btn = document.querySelector('#pharmacyReferenceModal .btn-add-improved');
            if (btn) btn.textContent = 'Добавить аптеку';
            
            const cancelBtn = document.getElementById('cancelEditPharmacyBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            const title = document.querySelector('#pharmacyReferenceModal .section-title-improved');
            if (title) title.textContent = 'Добавить новую аптеку';
        }

        function deletePharmacyFromReference(id) {
            if (!confirm('Удалить?')) return;
            pharmacyReference = pharmacyReference.filter(p => p.id !== id);
            renderPharmacyList();
            updateGraphicPharmacySelect();
            updateRefPharmacySelect();
            saveReferenceData(); // Используем отдельную функцию для справочников
        }

        
        function renderPharmacyList() {
            const list = document.getElementById('pharmacyList');
            const searchInput = document.getElementById('pharmacySearchInput');
            const term = searchInput ? searchInput.value.toLowerCase() : '';

            let displayed = pharmacyReference.filter(p => 
                p.number.toString().toLowerCase().includes(term) || 
                p.address.toLowerCase().includes(term)
            );

            displayed.sort((a, b) => {
                return a.number.toString().localeCompare(b.number.toString(), undefined, {numeric: true, sensitivity: 'base'});
            });

            if (!displayed.length) {
                list.innerHTML = `
                    <div class="empty-list-improved">
                        <div class="empty-list-icon">🏪</div>
                        <p class="empty-list-text">Нет данных для отображения</p>
                    </div>
                `;
                return;
            }
            list.innerHTML = displayed.map(p => `
                <div class="list-item-improved">
                    <div class="list-item-content">
                        <div class="list-item-title">🏪 Аптека №${p.number}</div>
                        <div class="list-item-subtitle">${p.address}</div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="editPharmacyFromReference('${p.id}')" class="btn-edit-improved" style="margin-right: 8px;">Редактировать</button>
                        <button onclick="deletePharmacyFromReference('${p.id}')" class="btn-delete-improved">Удалить</button>
                    </div>
                </div>
            `).join('');
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            const searchInput = document.getElementById('employeeSearchInput');
            const term = searchInput ? searchInput.value.toLowerCase() : '';

            let displayed = employeeReference.filter(e => 
                e.name.toLowerCase().includes(term) || 
                e.position.toLowerCase().includes(term) ||
                e.pharmacy.toLowerCase().includes(term)
            );

            if (!displayed.length) {
                list.innerHTML = `
                    <div class="empty-list-improved">
                        <div class="empty-list-icon">👥</div>
                        <p class="empty-list-text">Нет данных для отображения</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = displayed.map(e => {
                const pharmacy = pharmacyReference.find(p => p.id === e.pharmacy);
                const pharmacyName = pharmacy ? `Аптека №${pharmacy.number}` : e.pharmacy;

                return `
                    <div class="list-item-improved">
                        <div class="list-item-content">
                            <div class="list-item-title">👤 ${e.name}</div>
                            <div class="list-item-subtitle">
                                ${e.position} • ${pharmacyName} • График ${e.schedule} • ${e.startHour}:00 - ${e.endHour}:00
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button onclick="editEmployeeFromReference('${e.id}')" class="btn-edit-improved" style="margin-right: 8px;">Редактировать</button>
                            <button onclick="deleteEmployeeFromReference('${e.id}')" class="btn-delete-improved">Удалить</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGraphicPharmacySelect() {
            const sel = document.getElementById('pharmacyNumber');
            if (!sel) return;
            const curr = sel.value;

            const sorted = [...pharmacyReference].sort((a, b) => {
                return a.number.toString().localeCompare(b.number.toString(), undefined, {numeric: true, sensitivity: 'base'});
            });

            sel.innerHTML = '<option value="">-- Выберите аптеку --</option>' +
                sorted.map(p => `<option value="${p.id}">Аптека №${p.number}</option>`).join('');
            if (curr && pharmacyReference.find(p => p.id === curr)) sel.value = curr;
        }

        function updateRefPharmacySelect() {
            const sel = document.getElementById('newEmployeePharmacy');
            if (!sel) return;

            const sorted = [...pharmacyReference].sort((a, b) => {
                return a.number.toString().localeCompare(b.number.toString(), undefined, {numeric: true, sensitivity: 'base'});
            });

            sel.innerHTML = '<option value="">-- Выберите аптеку --</option>' +
                sorted.map(p => `<option value="${p.id}">Аптека №${p.number}</option>`).join('');
        }

        function onGraphicPharmacySelect() {
    saveData(); // Можно оставить без await, так как это не критично
    const select = document.getElementById('pharmacyNumber');
    if (!select) return;
    const newId = select.value;
    const pharmacyText = (select.selectedIndex >= 0 && select.options[select.selectedIndex]) 
        ? select.options[select.selectedIndex].text 
        : '';
    const addressInput = document.getElementById('pharmacyAddress');
    if (addressInput) {
        if (newId !== '--' && pharmacyReference) {
            const ph = pharmacyReference.find(p => p.id === newId);
            addressInput.value = ph ? ph.address : ''; updateHeaderInputs();
        } else {
            addressInput.value = ''; updateHeaderInputs();
        }
    }
    const dateText = getMonthName(currentMonth).toUpperCase() + ' ' + currentYear;
    const titleEl = document.getElementById('currentMonthDisplay');
    
    // Сохраняем onclick и style перед обновлением
    const savedOnclick = titleEl ? titleEl.getAttribute('onclick') : null;
    const savedStyle = titleEl ? titleEl.getAttribute('style') : null;
    
    if (pharmacyText && !pharmacyText.includes('-- Выберите аптеку --')) {
        const pharmacyNum = pharmacyText.replace(/^Аптека №/, '');
        if (titleEl) {
            titleEl.innerHTML = 'ГРАФИК СОТРУДНИКОВ АПТЕКИ №' + pharmacyNum + ' НА <span id="monthYearText">' + dateText + '</span> Г.';
            // Восстанавливаем onclick и style
            if (savedOnclick) titleEl.setAttribute('onclick', savedOnclick);
            if (savedStyle) titleEl.setAttribute('style', savedStyle);
        }
    } else {
        if (titleEl) {
            titleEl.innerHTML = '<span id="monthYearText">' + dateText + '</span>';
            // Восстанавливаем onclick и style
            if (savedOnclick) titleEl.setAttribute('onclick', savedOnclick);
            if (savedStyle) titleEl.setAttribute('style', savedStyle);
        }
    }
    currentPharmacyId = newId;
    firebaseSetItem('savedCurrentPharmacyId', currentPharmacyId);
    loadScheduleFor(currentYear, currentMonth, currentPharmacyId);
    if (typeof renderSchedule === 'function') renderSchedule();
}

        function onRefPharmacySelect() {
            const id = document.getElementById('newEmployeePharmacy').value;
            const ph = pharmacyReference.find(p => p.id === id);
            document.getElementById('refPharmacyAddressDisplay').value = ph ? ph.address : '';
        }

        function openEmployeeReferenceModal() {
            cancelEditEmployee(); // Сбрасываем режим редактирования при открытии
            renderEmployeeList();
            updateRefPharmacySelect();
            document.getElementById('employeeReferenceModal').style.display = 'block';
        }

        function closeEmployeeReferenceModal() {
            document.getElementById('employeeReferenceModal').style.display = 'none';
        }

        function addEmployeeToReference() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const position = document.getElementById('newEmployeePosition').value;
            const pharmacy = document.getElementById('newEmployeePharmacy').value;
            const schedule = document.getElementById('newEmployeeSchedule').value;
            const startHour = document.getElementById('newEmployeeStartHour').value;
            const endHour = document.getElementById('newEmployeeEndHour').value;
            if (!name || !position || !pharmacy || !schedule || !startHour || !endHour) { 
                alert('Заполните все поля'); return; 
            }

            if (editingEmployeeId) {
                // Редактирование существующего сотрудника
                const existing = employeeReference.find(e => e.id === editingEmployeeId);
                if (!existing) {
                    editingEmployeeId = null;
                    return;
                }
                existing.name = name;
                existing.position = position;
                existing.pharmacy = pharmacy;
                existing.schedule = schedule;
                existing.startHour = parseInt(startHour);
                existing.endHour = parseInt(endHour);
                saveReferenceData(); // Используем отдельную функцию для справочников
                alert('Сотрудник обновлен!');
                cancelEditEmployee(); // Сбрасываем режим редактирования
            } else {
                // Добавление нового сотрудника
            employeeReference.push({
                id: 'emp_' + Date.now(),
                name, position, pharmacy, schedule,
                startHour: parseInt(startHour),
                endHour: parseInt(endHour)
            });
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeePosition').value = '';
            document.getElementById('newEmployeePharmacy').value = '';
            document.getElementById('newEmployeeSchedule').value = '';
            document.getElementById('newEmployeeStartHour').value = '';
            document.getElementById('newEmployeeEndHour').value = '';
                saveReferenceData(); // Используем отдельную функцию для справочников
                alert('Сотрудник добавлен!');
            }

            renderEmployeeList();
            updateGraphicEmployeeSelect();
        }

        window.editEmployeeFromReference = function(id) {
            const employee = employeeReference.find(e => e.id === id);
            if (!employee) return;
            
            editingEmployeeId = id;
            document.getElementById('newEmployeeName').value = employee.name;
            document.getElementById('newEmployeePosition').value = employee.position;
            document.getElementById('newEmployeePharmacy').value = employee.pharmacy;
            document.getElementById('newEmployeeSchedule').value = employee.schedule;
            document.getElementById('newEmployeeStartHour').value = employee.startHour;
            document.getElementById('newEmployeeEndHour').value = employee.endHour;
            
            // Обновляем адрес аптеки
            onRefPharmacySelect();
            
            const btn = document.querySelector('#employeeReferenceModal .btn-add-improved');
            if (btn) btn.textContent = 'Сохранить изменения';
            
            const cancelBtn = document.getElementById('cancelEditEmployeeBtn');
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            
            const title = document.querySelector('#employeeReferenceModal .section-title-improved');
            if (title) title.textContent = 'Редактировать сотрудника';
            
            // Прокрутка к форме
            const form = document.querySelector('#employeeReferenceModal .add-section-improved');
            if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        window.cancelEditEmployee = function() {
            editingEmployeeId = null;
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeePosition').value = '';
            document.getElementById('newEmployeePharmacy').value = '';
            document.getElementById('newEmployeeSchedule').value = '';
            document.getElementById('newEmployeeStartHour').value = '';
            document.getElementById('newEmployeeEndHour').value = '';
            const btn = document.querySelector('#employeeReferenceModal .btn-add-improved');
            if (btn) btn.textContent = 'Добавить сотрудника';
            
            const cancelBtn = document.getElementById('cancelEditEmployeeBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            const title = document.querySelector('#employeeReferenceModal .section-title-improved');
            if (title) title.textContent = 'Добавить нового сотрудника';
        }

        function deleteEmployeeFromReference(id) {
            if (!confirm('Удалить?')) return;
            employeeReference = employeeReference.filter(e => e.id !== id);
            renderEmployeeList();
            updateGraphicEmployeeSelect();
            saveReferenceData(); // Используем отдельную функцию для справочников
        }

        
        function renderPharmacyList() {
            const list = document.getElementById('pharmacyList');
            const searchInput = document.getElementById('pharmacySearchInput');
            const term = searchInput ? searchInput.value.toLowerCase() : '';

            let displayed = pharmacyReference.filter(p => 
                p.number.toString().toLowerCase().includes(term) || 
                p.address.toLowerCase().includes(term)
            );

            displayed.sort((a, b) => {
                return a.number.toString().localeCompare(b.number.toString(), undefined, {numeric: true, sensitivity: 'base'});
            });

            if (!displayed.length) {
                list.innerHTML = `
                    <div class="empty-list-improved">
                        <div class="empty-list-icon">🏪</div>
                        <p class="empty-list-text">Нет данных для отображения</p>
                    </div>
                `;
                return;
            }
            list.innerHTML = displayed.map(p => `
                <div class="list-item-improved">
                    <div class="list-item-content">
                        <div class="list-item-title">🏪 Аптека №${p.number}</div>
                        <div class="list-item-subtitle">${p.address}</div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="editPharmacyFromReference('${p.id}')" class="btn-edit-improved" style="margin-right: 8px;">Редактировать</button>
                        <button onclick="deletePharmacyFromReference('${p.id}')" class="btn-delete-improved">Удалить</button>
                    </div>
                </div>
            `).join('');
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            const searchInput = document.getElementById('employeeSearchInput');
            const term = searchInput ? searchInput.value.toLowerCase() : '';

            let displayed = employeeReference.filter(e => 
                e.name.toLowerCase().includes(term) || 
                e.position.toLowerCase().includes(term) ||
                e.pharmacy.toLowerCase().includes(term)
            );

            if (!displayed.length) {
                list.innerHTML = `
                    <div class="empty-list-improved">
                        <div class="empty-list-icon">👥</div>
                        <p class="empty-list-text">Нет данных для отображения</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = displayed.map(e => {
                const pharmacy = pharmacyReference.find(p => p.id === e.pharmacy);
                const pharmacyName = pharmacy ? `Аптека №${pharmacy.number}` : e.pharmacy;

                return `
                    <div class="list-item-improved">
                        <div class="list-item-content">
                            <div class="list-item-title">👤 ${e.name}</div>
                            <div class="list-item-subtitle">
                                ${e.position} • ${pharmacyName} • График ${e.schedule} • ${e.startHour}:00 - ${e.endHour}:00
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button onclick="editEmployeeFromReference('${e.id}')" class="btn-edit-improved" style="margin-right: 8px;">Редактировать</button>
                            <button onclick="deleteEmployeeFromReference('${e.id}')" class="btn-delete-improved">Удалить</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGraphicEmployeeSelect() {
            const sel = document.getElementById('modalName');
            if (!sel) return;
            const curr = sel.value;

            // Разделяем сотрудников на текущую аптеку и остальных
            const currentPharmacyEmployees = employeeReference.filter(e => e.pharmacy === currentPharmacyId && currentPharmacyId !== '--');
            const otherPharmacyEmployees = employeeReference.filter(e => !e.pharmacy || e.pharmacy !== currentPharmacyId || currentPharmacyId === '--');

            // Сортируем каждую группу по имени
            const sortedCurrent = [...currentPharmacyEmployees].sort((a, b) => a.name.localeCompare(b.name));
            const sortedOther = [...otherPharmacyEmployees].sort((a, b) => a.name.localeCompare(b.name));

            // Формируем HTML: сначала сотрудники текущей аптеки, потом разделитель, потом остальные
            let html = '<option value="">-- Выберите сотрудника --</option>';
            
            // Сотрудники текущей аптеки
            html += sortedCurrent.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            
            // Разделитель "Подработчики" (только если есть сотрудники из других аптек)
            if (sortedOther.length > 0) {
                html += '<option value="" disabled style="font-weight: bold; background-color: #f0f0f0;">────────── Подработчики ──────────</option>';
                html += sortedOther.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }

            sel.innerHTML = html;
            if (curr && employeeReference.find(e => e.id === curr)) sel.value = curr;
        }

        function onEmployeeSelect() {
            const id = document.getElementById('modalName').value;
            const emp = employeeReference.find(e => e.id === id);
            if (emp) {
                document.getElementById('modalRealName').value = emp.name;
                document.getElementById('modalPosition').value = emp.position;
                document.getElementById('modalSchedule').value = emp.schedule || '';
                document.getElementById('modalStartHour').value = emp.startHour || '';
                document.getElementById('modalEndHour').value = emp.endHour || '';

                // Автоматически определяем подработчика: если сотрудник из другой аптеки
                const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
                if (isSubcontractorHidden) {
                    const isFromOtherPharmacy = emp.pharmacy && emp.pharmacy !== currentPharmacyId && currentPharmacyId !== '--';
                    isSubcontractorHidden.value = isFromOtherPharmacy ? 'true' : 'false';
                }

                // Обновляем видимость поля "С какого дня"
                toggleFields();
            } else {
                document.getElementById('modalRealName').value = '';
                document.getElementById('modalPosition').value = '';
                const isSubcontractorHidden = document.getElementById('modalIsSubcontractorHidden');
                if (isSubcontractorHidden) {
                    isSubcontractorHidden.value = 'false';
                }
            }
        }

        // Месяцы для отображения
        
        function openMonthYearModal() {
            // Обновляем селект аптеки перед открытием модального окна
            if (typeof updateGraphicPharmacySelect === 'function') {
                updateGraphicPharmacySelect();
            }
            
            // Заполняем объединенный select месяц/год
            const monthYearSelect = document.getElementById('monthYearSelectModal');
            if (monthYearSelect) {
                monthYearSelect.innerHTML = '';
                const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                              'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                const today = new Date();
                const todayYear = today.getFullYear();
                
                // Создаем опции для текущего года и следующих 5 лет
                for (let year = todayYear - 2; year <= todayYear + 5; year++) {
                    for (let month = 0; month < 12; month++) {
                        const option = document.createElement('option');
                        option.value = month + '_' + year;
                        option.textContent = months[month] + ' ' + year;
                        monthYearSelect.appendChild(option);
                    }
                }
                
                // Устанавливаем текущее значение (используем глобальные переменные currentMonth и currentYear)
                const currentValue = currentMonth + '_' + currentYear;
                monthYearSelect.value = currentValue;
            }
            
            const pharmacySelect = document.getElementById('pharmacyNumber');
            if (pharmacySelect && currentPharmacyId) {
                pharmacySelect.value = currentPharmacyId;
                // Обновляем адрес при установке аптеки
                if (typeof onGraphicPharmacySelect === 'function') {
                    onGraphicPharmacySelect();
                }
            }
            
            // Обновляем размеры полей после небольшой задержки, чтобы модальное окно успело отобразиться
            setTimeout(() => {
                if (typeof updateHeaderInputs === 'function') {
                    updateHeaderInputs();
                }
            }, 100);
            
            document.getElementById('monthYearModal').style.display = 'block';
        }

        function closeMonthYearModal() {
            document.getElementById('monthYearModal').style.display = 'none';
        }

        function changePharmacy(direction) {
            const select = document.getElementById('pharmacyNumber');
            if (!select || select.options.length <= 1) return;
            
            const currentIndex = select.selectedIndex;
            let newIndex = currentIndex + direction;
            
            // Если текущая опция - первая (-- Выберите аптеку --), переходим к первой реальной аптеке
            if (currentIndex === 0) {
                newIndex = direction > 0 ? 1 : select.options.length - 1;
            } else {
                // Пропускаем первую опцию "-- Выберите аптеку --"
                if (newIndex === 0 && direction < 0) {
                    newIndex = select.options.length - 1;
                } else if (newIndex >= select.options.length) {
                    newIndex = 1; // Пропускаем первую опцию
                } else if (newIndex < 1) {
                    newIndex = select.options.length - 1;
                }
            }
            
            select.selectedIndex = newIndex;
            if (typeof onGraphicPharmacySelect === 'function') {
                onGraphicPharmacySelect();
            }
        }

        function changeMonthYear(direction) {
            const select = document.getElementById('monthYearSelectModal');
            if (!select || select.options.length === 0) return;
            
            const currentIndex = select.selectedIndex;
            let newIndex = currentIndex + direction;
            
            if (newIndex < 0) {
                newIndex = select.options.length - 1;
            } else if (newIndex >= select.options.length) {
                newIndex = 0;
            }
            
            select.selectedIndex = newIndex;
        }

        function applyMonthYear() {
            const monthYearSelect = document.getElementById('monthYearSelectModal');
            const selectedValue = monthYearSelect.value;
            const [monthValue, yearValue] = selectedValue.split('_').map(v => parseInt(v));

            const monthName = getMonthName(monthValue).toUpperCase();

            // Применяем выбор аптеки, если он был изменен
            if (typeof onGraphicPharmacySelect === 'function') {
                onGraphicPharmacySelect();
            }

            const pharmacySelect = document.getElementById('pharmacyNumber');
            const pharmacyText = (pharmacySelect && pharmacySelect.selectedIndex >= 0 && pharmacySelect.options[pharmacySelect.selectedIndex]) 
                ? pharmacySelect.options[pharmacySelect.selectedIndex].text 
                : '';

            let newTitleHTML = '';
            if (pharmacyText && pharmacyText !== '-- Выберите аптеку --') {
                const pharmacyNum = pharmacyText.replace(/^Аптека №/, '');
                newTitleHTML = 'ГРАФИК СОТРУДНИКОВ АПТЕКИ №' + pharmacyNum + ' НА <span id="monthYearText">' + monthName + ' ' + yearValue + '</span> Г.';
            } else {
                newTitleHTML = 'ГРАФИК СОТРУДНИКОВ АПТЕКИ НА <span id="monthYearText">' + monthName + ' ' + yearValue + '</span> Г.';
            }
            document.getElementById('currentMonthDisplay').innerHTML = newTitleHTML;

            const oldMonthSelect = document.getElementById('monthSelect');
            const oldYearInput = document.getElementById('yearInput');
            if (oldMonthSelect) oldMonthSelect.value = monthValue;
            if (oldYearInput) oldYearInput.value = yearValue;

            if (typeof changeMonth === 'function') {
                changeMonth();
            }

            closeMonthYearModal();
        }

        window.onclick = function(event) {
            const modal = document.getElementById('monthYearModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        

    // --- Auto Resize Logic (V3) ---
    function getTextWidth(text, font) {
        const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
        const context = canvas.getContext("2d");
        context.font = font;
        const metrics = context.measureText(text);
        return metrics.width;
    }

    function resizeElement(el) {
        if (!el) return;

        let text = '';
        let style = window.getComputedStyle(el);
        let font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;

        // Base padding (horizontal) + borders
        // header-input has padding: 6px 10px -> 20px total
        // border: 2px total
        // Total static: 22px

        let extra = 25; 

        if (el.tagName === 'SELECT') {
            if (el.selectedIndex >= 0) {
                text = el.options[el.selectedIndex].text;
            } else {
                text = '-- Выберите аптеку --';
            }
            extra = 45; // More for arrow
        } else if (el.tagName === 'INPUT') {
            text = el.value || el.placeholder;
            extra = 25; 
        }

        const width = Math.ceil(getTextWidth(text, font) + extra);
        el.style.width = width + 'px';
    }

    function updateHeaderInputs() {
        resizeElement(document.getElementById('pharmacyNumber'));
        resizeElement(document.getElementById('pharmacyAddress'));
    }

    // Listeners
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderInputs();

        const ph = document.getElementById('pharmacyNumber');
        if(ph) {
            ph.addEventListener('change', updateHeaderInputs);
            // Also listen for mouse interaction just in case
            ph.addEventListener('blur', updateHeaderInputs);
        }
    });
    // --- End Auto Resize ---

</script>

    <div id="pharmacyReferenceModal" class="modal">
        <div class="modal-content modal-content-improved" style="width: 700px;">
            <div class="modal-header-improved">
                <h2 class="modal-title-improved">📋 Справочник аптек</h2>
                <span class="close-improved" onclick="closePharmaReferenceModal()">&times;</span>
            </div>

            <div class="modal-body-improved">
                <div class="add-section-improved">
                    <h3 class="section-title-improved">Добавить новую аптеку</h3>
                    <div class="form-grid-improved">
                        <div class="form-group-improved">
                            <label class="form-label-improved">№ аптеки</label>
                            <input type="text" id="newPharmacyNumber" placeholder="Введите номер аптеки" class="input-improved">
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">Адрес</label>
                            <input type="text" id="newPharmacyAddress" placeholder="Введите адрес" class="input-improved">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="btn-add-improved" onclick="addPharmacyToReference()">Добавить аптеку</button>
                            <button id="cancelEditPharmacyBtn" class="btn-cancel-edit-improved" onclick="cancelEditPharmacy()" style="display: none;">Отмена</button>
                        </div>
                    </div>
                </div>

                <div class="search-section-improved">
                    <input type="text" id="pharmacySearchInput" placeholder="🔍 Поиск по номеру или адресу..." oninput="renderPharmacyList()" class="search-input-improved">
                </div>

                <div class="list-section-improved">
                    <div id="pharmacyList" class="list-container-improved"></div>
                </div>
            </div>

            <div class="modal-footer-improved">
                <button class="btn-cancel-improved" onclick="closePharmaReferenceModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="employeeReferenceModal" class="modal">
        <div class="modal-content modal-content-improved" style="width: 850px;">
            <div class="modal-header-improved">
                <h2 class="modal-title-improved">👥 Справочник сотрудников</h2>
                <span class="close-improved" onclick="closeEmployeeReferenceModal()">&times;</span>
            </div>

            <div class="modal-body-improved">
                <div class="add-section-improved">
                    <h3 class="section-title-improved">Добавить нового сотрудника</h3>
                    <div class="form-grid-improved form-grid-2col">
                        <div class="form-group-improved">
                            <label class="form-label-improved">ФИО</label>
                            <input type="text" id="newEmployeeName" placeholder="Введите ФИО" class="input-improved">
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">Должность</label>
                            <select id="newEmployeePosition" class="select-improved">
                                <option value="">Выберите должность</option>
                                <option value="ЗАУ">ЗАУ</option>
                                <option value="Фармацевт">Фармацевт</option>
                                <option value="Провизор">Провизор</option>
                                <option value="Консультант">Консультант</option>
                            </select>
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">Аптека</label>
                            <select id="newEmployeePharmacy" onchange="onRefPharmacySelect()" class="select-improved">
                                <option value="">Выберите аптеку</option>
                            </select>
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">График</label>
                            <select id="newEmployeeSchedule" class="select-improved">
                                <option value="">Выберите график</option>
                                <option value="5/2">5/2</option>
                                <option value="2/2">2/2</option>
                            </select>
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">Начало работы (час)</label>
                            <input type="number" id="newEmployeeStartHour" placeholder="8" class="input-improved" min="0" max="23">
                        </div>
                        <div class="form-group-improved">
                            <label class="form-label-improved">Конец работы (час)</label>
                            <input type="number" id="newEmployeeEndHour" placeholder="17" class="input-improved" min="0" max="23">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
                            <button class="btn-add-improved" onclick="addEmployeeToReference()">Добавить сотрудника</button>
                            <button id="cancelEditEmployeeBtn" class="btn-cancel-edit-improved" onclick="cancelEditEmployee()" style="display: none;">Отмена</button>
                        </div>
                    </div>
                </div>

                <div class="search-section-improved">
                    <input type="text" id="employeeSearchInput" placeholder="🔍 Поиск по ФИО, должности или аптеке..." oninput="renderEmployeeList()" class="search-input-improved">
                </div>

                <div class="list-section-improved">
                    <div id="employeeList" class="list-container-improved"></div>
                </div>
            </div>

            <div class="modal-footer-improved">
                <button class="btn-cancel-improved" onclick="closeEmployeeReferenceModal()">Закрыть</button>
            </div>
        </div>
    </div>


<!-- SIDEBAR СПРАВОЧНИКИ -->
<div class="sidebar-wrapper" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-header-title">📋 Справочники</span>
        <button class="sidebar-close" onclick="closeSidebar()">✕</button>
    </div>
    <div class="sidebar-content">
        <div class="ref-section">
            <button class="sidebar-btn sidebar-btn-pharma" onclick="openPharmaReferenceModal(); closeSidebar();">📋 Справочник аптек</button>
            <button class="sidebar-btn sidebar-btn-employee" onclick="openEmployeeReferenceModal(); closeSidebar();">👥 Справочник сотрудников</button>
        </div>
        <div class="ref-section" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px; color: #333;">🖨️ Печать</div>
            <button class="sidebar-btn sidebar-btn-print" onclick="openAckSheetModal(); closeSidebar();">📋 Лист ознакомления</button>
            <button class="sidebar-btn sidebar-btn-print" onclick="openPayrollJournalModal(); closeSidebar();">📊 Журнал выдачи РЛ</button>
            <button class="sidebar-btn sidebar-btn-print" onclick="window.open('https://snklukin-commits.github.io/upravleniepersonalom/sz.html', '_blank'); closeSidebar();">📝 Служебная записка</button>
            <button class="sidebar-btn sidebar-btn-print" onclick="window.open('https://snklukin-commits.github.io/upravleniepersonalom/zayavleniya.html', '_blank'); closeSidebar();">📄 Заявления</button>
        </div>
        <div class="ref-section" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px; color: #333;">Менеджмент</div>
            <button class="sidebar-btn sidebar-btn-print" onclick="openEmployeeManagerModal(); closeSidebar();">👤 Данные по сотрудникам</button>
        </div>
    </div>
</div>

<!-- EMPLOYEE MANAGER MODAL -->
<div id="employeeManagerModal" class="employee-manager-modal" onclick="closeEmployeeManagerModal(event)">
    <div class="employee-manager-content" onclick="event.stopPropagation()">
        <div class="employee-manager-header">
            <div class="employee-manager-title">МЕНЕДЖЕР РАБОТЫ СОТРУДНИКОВ</div>
            <button class="employee-manager-close" onclick="closeEmployeeManagerModal()">✕</button>
        </div>
        <div class="employee-manager-body">
            <div class="employee-manager-controls">
                <div class="employee-manager-select-wrapper">
                    <label>Выберите сотрудника:</label>
                    <select id="employeeManagerSelect">
                        <option value="">-- Выберите сотрудника --</option>
                    </select>
                </div>
                <div class="employee-manager-select-wrapper">
                    <label>Месяц:</label>
                    <select id="employeeManagerMonthSelect">
                        <option value="0">Январь</option>
                        <option value="1">Февраль</option>
                        <option value="2">Март</option>
                        <option value="3">Апрель</option>
                        <option value="4">Май</option>
                        <option value="5">Июнь</option>
                        <option value="6">Июль</option>
                        <option value="7">Август</option>
                        <option value="8">Сентябрь</option>
                        <option value="9">Октябрь</option>
                        <option value="10">Ноябрь</option>
                        <option value="11">Декабрь</option>
                    </select>
                </div>
                <div class="employee-manager-select-wrapper">
                    <label>Год:</label>
                    <input type="number" id="employeeManagerYearSelect" value="2025" min="2020" max="2030">
                </div>
            </div>
            
            <div id="employeeManagerInfo" class="employee-manager-info">
                <div class="employee-manager-info-card">
                    <h2>Основная информация</h2>
                    <div class="employee-manager-info-row">
                        <span class="employee-manager-info-label">ФИО:</span>
                        <span class="employee-manager-info-value" id="empManagerName">-</span>
                    </div>
                    <div class="employee-manager-info-row">
                        <span class="employee-manager-info-label">Должность:</span>
                        <span class="employee-manager-info-value" id="empManagerPosition">-</span>
                    </div>
                    <div class="employee-manager-info-row">
                        <span class="employee-manager-info-label">Основная аптека:</span>
                        <span class="employee-manager-info-value" id="empManagerPharmacy">-</span>
                    </div>
                    <div class="employee-manager-info-row">
                        <span class="employee-manager-info-label">Период:</span>
                        <span class="employee-manager-info-value" id="empManagerPeriod">-</span>
                    </div>
                </div>
                
                <div class="employee-manager-stats-grid">
                    <div class="employee-manager-stat-card">
                        <div class="employee-manager-stat-value" id="totalManagerShifts">0</div>
                        <div class="employee-manager-stat-label">Всего смен</div>
                    </div>
                    <div class="employee-manager-stat-card">
                        <div class="employee-manager-stat-value" id="mainManagerShifts">0</div>
                        <div class="employee-manager-stat-label">Смен на основной работе</div>
                        <div class="employee-manager-stat-label" style="font-size: 12px; margin-top: 5px; color: #666;" id="mainManagerHours">0 часов</div>
                    </div>
                    <div class="employee-manager-stat-card">
                        <div class="employee-manager-stat-value" id="subManagerShifts">0</div>
                        <div class="employee-manager-stat-label">Подработки</div>
                        <div class="employee-manager-stat-label" style="font-size: 12px; margin-top: 5px; color: #666;" id="subManagerHours">0 часов</div>
                    </div>
                </div>
                
                <div class="employee-manager-work-section">
                    <div id="mainManagerWorkContent"></div>
                </div>
                
                <div class="employee-manager-work-section">
                    <h3>💰 Компенсация в заработную плату</h3>
                    <div id="compensationManagerContent"></div>
                </div>
                
                <div class="employee-manager-work-section">
                    <h3>🏥 Больничные и отпуска</h3>
                    <div id="absenceManagerContent"></div>
                </div>
            </div>

            <div id="employeeManagerLoadingState" class="employee-manager-loading" style="display: none;">
                Загрузка данных...
            </div>
            
            <div id="employeeManagerEmptyState" class="employee-manager-empty-state">
                Выберите сотрудника для просмотра информации
            </div>
        </div>
    </div>
</div>

<!-- КНОПКА ОТКРЫТИЯ САЙДБАРА (перемещена в controls-bottom) -->

<script>
function openSidebar() {
    document.getElementById('sidebar').classList.add('active');
}

function closeSidebar() {
    document.getElementById('sidebar').classList.remove('active');
}

document.addEventListener('click', function(e) {
    var sidebar = document.getElementById('sidebar');
    var btn = document.getElementById('toggleBtn');
    if (!sidebar.contains(e.target) && !btn.contains(e.target)) {
        closeSidebar();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSidebar();
    }
});

        let absenceData = {};

        async function loadAbsenceData() {
            const saved = await firebaseGetItem('absenceData');
            absenceData = saved ? (typeof saved === 'string' ? JSON.parse(saved) : saved) : {};
        }

        async function loadOffDaysData() {
            const key = 'offDays_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            const saved = await firebaseGetItem(key);
            if (saved) {
                try {
                    offDays = typeof saved === 'string' ? JSON.parse(saved) : saved;
                } catch (e) {
                    offDays = {};
                }
            } else {
                offDays = {};
            }
        }

        async function saveOffDaysStorage() {
            const key = 'offDays_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            await firebaseSetItem(key, offDays);
        }

        async function loadOffDaysStorage() {
            const key = 'offDays_' + currentPharmacyId + '_' + currentYear + '_' + currentMonth;
            const saved = await firebaseGetItem(key);
            if (saved) {
                offDays = typeof saved === 'string' ? JSON.parse(saved) : saved;
            } else {
                offDays = {};
            }
        }

        async function saveAbsenceDataStorage() {
            await firebaseSetItem('absenceData', absenceData);
        }

        function openAbsenceModal() {
            document.getElementById('absenceModal').style.display = 'block';
            const sel = document.getElementById('absenceEmployee');
            const rows = document.querySelectorAll('#scheduleBody tr.input-row');
            sel.innerHTML = '<option value="">-- Выберите --</option>';
            rows.forEach(row => {
                if (row.cells[1]) {
                    const name = row.cells[1].textContent.trim();
                    if (name) {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sel.appendChild(opt);
                    }
                }
            });
        }

        function closeAbsenceModal() {
            document.getElementById('absenceModal').style.display = 'none';
        }

        function saveAbsence() {
            const name = document.getElementById('absenceEmployee').value;
            const type = document.getElementById('absenceType').value;
            const start = document.getElementById('absenceStartDate').value;
            const end = document.getElementById('absenceEndDate').value;

            if (!name || !type || !start || !end) {
                alert('Заполните все поля!');
                return;
            }

            if (new Date(start) > new Date(end)) {
                alert('Дата начала не может быть позже окончания!');
                return;
            }

            if (!absenceData[name]) absenceData[name] = [];
            absenceData[name].push({ type: type, startDate: start, endDate: end });
            saveAbsenceDataStorage();
            applyAbsences();
            alert('Добавлено!');
            closeAbsenceModal();
            document.getElementById('absenceForm').reset();
        }

                function deleteAbsence(name, index) {
            if (!absenceData[name]) return false;
            absenceData[name].splice(index, 1);
            if (absenceData[name].length === 0) delete absenceData[name];
            saveAbsenceDataStorage();
            applyAbsences();
            renderSchedule();
            return true;
        }

        function showDeleteAbsenceDialog(employeeName, absenceIndex, symbol) {
            // Создаём модальное окно для подтверждения удаления
            let overlay = document.getElementById('deleteAbsenceOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'deleteAbsenceOverlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
                document.body.appendChild(overlay);
            }

            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:white;padding:30px;border-radius:8px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);min-width:350px;';
            dialog.innerHTML = `
                <h3 style="margin:0 0 20px 0;color:#333;">Удалить ${symbol}?</h3>
                <p style="margin:0 0 30px 0;color:#666;font-size:14px;">На эту дату установлен ${symbol}. Вы уверены, что хотите его удалить?</p>
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button style="padding:10px 20px;background:#6c757d;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px;" onclick="document.getElementById('deleteAbsenceOverlay').style.display='none';">Отмена</button>
                    <button style="padding:10px 20px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px;" onclick="performDeleteAbsence('${employeeName}', ${absenceIndex});">Удалить</button>
                </div>
            `;

            overlay.innerHTML = '';
            overlay.appendChild(dialog);
            overlay.style.display = 'flex';
        }

        function performDeleteAbsence(employeeName, absenceIndex) {
            if (deleteAbsence(employeeName, absenceIndex)) {
                const overlay = document.getElementById('deleteAbsenceOverlay');
                if (overlay) overlay.style.display = 'none';
            }
        }

        function applyAbsences() {
            const rows = document.querySelectorAll('#scheduleBody tr.input-row');
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            
            // Сначала собираем множество дней с отсутствиями для каждого сотрудника
            const absenceDaysMap = {};
            rows.forEach(row => {
                if (!row.cells[1]) return;
                const name = row.cells[1].textContent.trim();
                if (absenceData[name]) {
                    absenceDaysMap[name] = new Set();
                    absenceData[name].forEach(absence => {
                        const month = currentMonth;
                        const year = currentYear;
                        const start = new Date(absence.startDate);
                        const end = new Date(absence.endDate);
                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            if (d.getMonth() === month && d.getFullYear() === year) {
                                absenceDaysMap[name].add(d.getDate());
                            }
                        }
                    });
                }
            });
            
            rows.forEach(row => {
                // В первой строке: cells[0]=position (rowspan), cells[1]=name (rowspan), cells[2]="Начало работы", cells[3+]=дни
                // В остальных строках: cells[0]="Окончание работы"/"Перерыв на обед"/"Количество часов", cells[1+]=дни
                if (!row.cells[1]) return;
                const name = row.cells[1].textContent.trim();
                
                // Очищаем стили для дней, где отсутствий больше нет
                if (!absenceDaysMap[name]) {
                    // Если у сотрудника нет отсутствий, очищаем все стили
                    let currentRow = row;
                    for (let i = 0; i < 4; i++) {
                        for (let day = 1; day <= daysInMonth; day++) {
                            const cellIndex = i === 0 ? day + 2 : day;
                            if (currentRow && currentRow.cells[cellIndex]) {
                                const cell = currentRow.cells[cellIndex];
                                if (cell.getAttribute('data-absence-type')) {
                                    if (i < 3) {
                                        cell.style.backgroundColor = '';
                                        cell.style.fontWeight = '';
                                        cell.style.textAlign = '';
                                        cell.style.color = '';
                                        if (i === 0) {
                                            cell.textContent = '';
                                        }
                                    }
                                    cell.removeAttribute('data-absence-type');
                                    cell.removeAttribute('data-absence-symbol');
                                }
                            }
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                    return;
                }

                // ⭐ ПРОВЕРКА: если сотрудник на подработке, не показываем отпуска/больничные
                const employee = employees.find(e => e.name === name);
                if (employee && employee.isSubcontractor) {
                    // Очищаем стили для подработчиков
                    let currentRow = row;
                    for (let i = 0; i < 4; i++) {
                        for (let day = 1; day <= daysInMonth; day++) {
                            const cellIndex = i === 0 ? day + 2 : day;
                            if (currentRow && currentRow.cells[cellIndex]) {
                                const cell = currentRow.cells[cellIndex];
                                if (cell.getAttribute('data-absence-type')) {
                                    if (i < 3) {
                                        cell.style.backgroundColor = '';
                                        cell.style.fontWeight = '';
                                        cell.style.textAlign = '';
                                        cell.style.color = '';
                                        if (i === 0) {
                                            cell.textContent = '';
                                        }
                                    }
                                    cell.removeAttribute('data-absence-type');
                                    cell.removeAttribute('data-absence-symbol');
                                }
                            }
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                    return; // Пропускаем применение отпусков/больничных для подработчиков
                }
                
                // Очищаем стили для дней, где отсутствий больше нет (но у сотрудника есть другие отсутствия)
                let currentRowForCleanup = row;
                for (let i = 0; i < 4; i++) {
                    for (let day = 1; day <= daysInMonth; day++) {
                        if (!absenceDaysMap[name].has(day)) {
                            const cellIndex = i === 0 ? day + 2 : day;
                            if (currentRowForCleanup && currentRowForCleanup.cells[cellIndex]) {
                                const cell = currentRowForCleanup.cells[cellIndex];
                                if (cell.getAttribute('data-absence-type')) {
                                    if (i < 3) {
                                        cell.style.backgroundColor = '';
                                        cell.style.fontWeight = '';
                                        cell.style.textAlign = '';
                                        cell.style.color = '';
                                        if (i === 0) {
                                            cell.textContent = '';
                                        }
                                    }
                                    cell.removeAttribute('data-absence-type');
                                    cell.removeAttribute('data-absence-symbol');
                                }
                            }
                        }
                    }
                    currentRowForCleanup = currentRowForCleanup.nextElementSibling;
                }

                absenceData[name].forEach(absence => {
                    const month = currentMonth;
                    const year = currentYear;
                    const start = new Date(absence.startDate);
                    const end = new Date(absence.endDate);
                    const symbol = absence.type === 'vacation' ? 'О' : 'Б';
                    const color = absence.type === 'vacation' ? '#fff3cd' : '#f8d7da';
                    // Градиентный паттерн для больничных/отпусков
                    const gradientColor = absence.type === 'vacation' ? 
                        'repeating-linear-gradient(45deg, #fff3cd 0px, #fff3cd 4px, rgba(255, 243, 205, 0.3) 4px, rgba(255, 243, 205, 0.3) 8px)' :
                        'repeating-linear-gradient(45deg, #f8d7da 0px, #f8d7da 4px, rgba(248, 215, 218, 0.3) 4px, rgba(248, 215, 218, 0.3) 8px)';

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (d.getMonth() === month && d.getFullYear() === year) {
                            const dayNum = d.getDate();
                            
                            // Применяем стиль только к первым 3 строкам (начало, конец, перерыв)
                            // 4-я строка (часы) НЕ окрашивается
                            // Букву ставим только в первой ячейке

                            let currentRow = row;
                            for (let i = 0; i < 4; i++) {
                                // Структура строк:
                                // Первая строка (i=0): cells[0]=position, cells[1]=name, cells[2]="Начало работы", cells[3]=день1, cells[4]=день2, ...
                                //   Для дня N: индекс = N + 2 (день 1 в cells[3], значит индекс = 1 + 2 = 3)
                                // Остальные строки (i>0): cells[0]="Окончание работы"/"Перерыв на обед"/"Количество часов", cells[1]=день1, cells[2]=день2, ...
                                //   Для дня N: индекс = N (день 1 в cells[1], значит индекс = 1)
                                const cellIndex = i === 0 ? dayNum + 2 : dayNum;
                                
                                if (currentRow && currentRow.cells[cellIndex]) {
                                    const cell = currentRow.cells[cellIndex];

                                    // Окрашиваем только первые 3 ячейки (НЕ окрашиваем 4-ю с часами)
                                    if (i < 3) {
                                        // Проверяем, нужно ли обновлять стиль (избегаем мигания)
                                        // Используем data-атрибут для отслеживания уже примененного стиля
                                        const currentAbsenceType = cell.getAttribute('data-absence-type');
                                        const currentAbsenceSymbol = cell.getAttribute('data-absence-symbol');
                                        const expectedSymbol = i === 0 ? symbol : '';
                                        const needsUpdate = currentAbsenceType !== absence.type || 
                                                           currentAbsenceSymbol !== expectedSymbol ||
                                                           cell.textContent !== expectedSymbol;
                                        
                                        if (needsUpdate) {
                                            // Только в первой строке ставим букву
                                            if (i === 0) {
                                                cell.textContent = symbol;
                                            } else {
                                                cell.textContent = '';  // Очищаем остальные 3 ячейки
                                            }
                                            
                                            // Применяем стили с !important, чтобы перекрыть выходные дни
                                            // Используем градиентный паттерн для штриховки
                                            cell.style.setProperty('background', gradientColor, 'important');
                                            cell.style.setProperty('background-image', gradientColor, 'important');
                                            cell.style.fontWeight = 'bold';
                                            cell.style.textAlign = 'center';
                                            cell.style.color = '#000';
                                            
                                            // Сохраняем информацию о примененном стиле
                                            cell.setAttribute('data-absence-type', absence.type);
                                            cell.setAttribute('data-absence-symbol', expectedSymbol);
                                        }
                                    } else {
                                        // Для 4-й строки (часы) очищаем атрибуты, если они были
                                        if (cell.getAttribute('data-absence-type')) {
                                            cell.removeAttribute('data-absence-type');
                                            cell.removeAttribute('data-absence-symbol');
                                        }
                                    }
                                }
                                currentRow = currentRow.nextElementSibling;
                            }
                        }
                    }
                });
            });
        }
        
        // Вспомогательная функция для преобразования hex в rgb для сравнения
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `rgb(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)})` : 
                hex;
        }
        window.onclick = function(event) {
            const modal = document.getElementById('absenceModal');
            if (event.target === modal) modal.style.display = 'none';
        }

        loadAbsenceData().then(() => {
            // Data loaded
        });
        
        // Используем debounce для applyAbsences, чтобы избежать мигания
        let applyAbsencesTimeout = null;
        function debouncedApplyAbsences() {
            if (applyAbsencesTimeout) {
                clearTimeout(applyAbsencesTimeout);
            }
            applyAbsencesTimeout = setTimeout(() => {
                applyAbsences();
                applyAbsencesTimeout = null;
            }, 150); // Задержка 150мс для debounce
        }
        
        const oldRender = window.renderSchedule;
        window.renderSchedule = function() {
            oldRender();
            debouncedApplyAbsences();
        };

    // --- Auto Resize Logic (V3) ---
    function getTextWidth(text, font) {
        const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
        const context = canvas.getContext("2d");
        context.font = font;
        const metrics = context.measureText(text);
        return metrics.width;
    }

    function resizeElement(el) {
        if (!el) return;

        let text = '';
        let style = window.getComputedStyle(el);
        let font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;

        // Base padding (horizontal) + borders
        // header-input has padding: 6px 10px -> 20px total
        // border: 2px total
        // Total static: 22px

        let extra = 25; 

        if (el.tagName === 'SELECT') {
            if (el.selectedIndex >= 0) {
                text = el.options[el.selectedIndex].text;
            } else {
                text = '-- Выберите аптеку --';
            }
            extra = 45; // More for arrow
        } else if (el.tagName === 'INPUT') {
            text = el.value || el.placeholder;
            extra = 25; 
        }

        const width = Math.ceil(getTextWidth(text, font) + extra);
        el.style.width = width + 'px';
    }

    function updateHeaderInputs() {
        resizeElement(document.getElementById('pharmacyNumber'));
        resizeElement(document.getElementById('pharmacyAddress'));
    }

    // Listeners
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderInputs();

        const ph = document.getElementById('pharmacyNumber');
        if(ph) {
            ph.addEventListener('change', updateHeaderInputs);
            // Also listen for mouse interaction just in case
            ph.addEventListener('blur', updateHeaderInputs);
        }
    });
    // --- End Auto Resize ---


        // Инициализируем переменные при загрузке
        window.addEventListener('DOMContentLoaded', function() {
            initializeVariables();
            if (typeof updateMonthDisplay === 'function') {
                updateMonthDisplay();
            }
            if (typeof renderSchedule === 'function') {
                renderSchedule();
            }
        });
    

    // ===== ФУНКЦИИ ДЛЯ ЛИСТА ОЗНАКОМЛЕНИЯ =====

    function getUniqueEmployees() {
        // Подгружаем сотрудников из глобальной переменной employees
        // которая заполняется из графика работы
        if (typeof employees !== 'undefined' && Array.isArray(employees)) {
            return employees
                .filter(emp => emp && emp.name && emp.name.length > 0)
                .filter(emp => !emp.name.match(/выберите|placeholder|---/i))
                // Исключаем подработчиков - только основные сотрудники
                .filter(emp => !(emp.isSubcontractor === true || emp.isSubcontractor === 1))
                .map(emp => ({
                    name: emp.name.trim(),
                    position: emp.position || 'Сотрудник'
                }))
                .sort((a, b) => a.name.localeCompare(b.name, 'ru'));
        }

        // Fallback: если employees не существует, читаем из таблицы
        const result = [];
        const employeeMap = new Map();

        const rows = document.querySelectorAll('#scheduleBody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
                // Ищем ФИО в первой ячейке с классом employee-position-cell
                const posCell = row.querySelector('.employee-position-cell');
                if (posCell) {
                    // Проверяем, есть ли метка "подработчик" в ячейке
                    const statusDiv = posCell.querySelector('.employee-status');
                    const isSubcontractor = statusDiv && statusDiv.textContent.toLowerCase().includes('подработчик');
                    
                    // Пропускаем подработчиков
                    if (isSubcontractor) {
                        return;
                    }
                    
                    const fio = posCell.textContent.trim();
                    // Удаляем метку "подработчик" из текста, если она есть
                    const cleanFio = fio.replace(/подработчик/gi, '').trim();
                    if (cleanFio && cleanFio.length > 2 && !cleanFio.match(/выберите|placeholder|---/i)) {
                        const key = cleanFio.toUpperCase();
                        if (!employeeMap.has(key)) {
                            employeeMap.set(key, {
                                name: cleanFio,
                                position: 'Сотрудник'
                            });
                        }
                    }
                }
            }
        });

        return Array.from(employeeMap.values()).sort((a, b) => 
            a.name.localeCompare(b.name, 'ru')
        );
    }

    // Глобальные переменные для экспорта
    let ackSheetExportData = null;

    function openAckSheetModal() {
        const modal = document.getElementById('ackSheetModal');
        if (!modal) return;

        // Используем полные данные сотрудников из глобальной переменной employees
        const fullEmployees = typeof employees !== 'undefined' && Array.isArray(employees) 
            ? employees.filter(emp => emp && emp.name && emp.name.length > 0)
            : [];
        
        if (fullEmployees.length === 0) {
            alert('Сотрудники в графике не найдены. Пожалуйста, добавьте сотрудников в график.');
            return;
        }

        const pharmacySelect = document.getElementById('pharmacyNumber');
        const monthYearSelect = document.getElementById('monthYearSelectModal');

        let pharmacyNumberText = '-- Не выбрано --';
        let pharmacyAddress = 'Адрес не указан';
        let pharmacyId = null;
        
        if (pharmacySelect && pharmacySelect.selectedIndex >= 0) {
            pharmacyId = pharmacySelect.value;
            const optionText = pharmacySelect.options[pharmacySelect.selectedIndex].text;
            // Извлекаем номер аптеки из текста "Аптека №123" или "Аптека №123-45"
            const match = optionText.match(/Аптека\s*№\s*(.+)/);
            pharmacyNumberText = match ? match[1].trim() : optionText.replace(/^Аптека\s*№\s*/, '').trim();
            
            // Берем адрес из справочника аптек
            if (pharmacyId && pharmacyId !== '--' && typeof pharmacyReference !== 'undefined' && pharmacyReference) {
                const ph = pharmacyReference.find(p => p.id === pharmacyId);
                if (ph && ph.address) {
                    pharmacyAddress = ph.address;
                }
            }
        }

        let monthText = '';
        let monthValue = currentMonth;
        let yearValue = currentYear;
        if (monthYearSelect && monthYearSelect.value) {
            const [month, year] = monthYearSelect.value.split('_').map(v => parseInt(v));
            monthValue = month;
            yearValue = year;
            const monthNames = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                               'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
            const monthName = monthNames[month] || 'месяц';
            monthText = monthName + ' ' + year;
        } else {
            const monthNames = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                               'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
            const monthName = monthNames[monthValue] || 'месяц';
            monthText = monthName + ' ' + yearValue;
        }

        // Сохраняем данные для экспорта
        ackSheetExportData = {
            employees: fullEmployees,
            pharmacyNum: pharmacyNumberText,
            pharmacyAddr: pharmacyAddress,
            month: monthText,
            monthIndex: monthValue,
            year: yearValue
        };

        // Сохраняем данные для экспорта
        ackSheetExportData = {
            employees: fullEmployees,
            pharmacyNum: pharmacyNumberText,
            pharmacyAddr: pharmacyAddress,
            month: monthText,
            monthIndex: monthValue,
            year: yearValue
        };

        generateAckSheetPreview(fullEmployees, pharmacyNumberText, pharmacyAddress, monthText, monthValue, yearValue);

        modal.classList.add('active');
    }

    function closeAckSheetModal() {
        const modal = document.getElementById('ackSheetModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function generateAckSheetPreview(employees, pharmacyNum, pharmacyAddr, month, monthIndex, year) {
        const preview = document.getElementById('ackSheetPreview');

        if (!pharmacyNum) pharmacyNum = '-- Не выбрано --';
        if (!pharmacyAddr) pharmacyAddr = 'Адрес не указан';
        if (!month) month = 'месяц не указан';
        if (monthIndex === undefined) monthIndex = currentMonth;
        if (!year) year = currentYear;

        const monthNames = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                           'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
        const monthName = monthNames[monthIndex] || 'месяц';
        const monthText = monthName + ' ' + year + 'г.';

        // Генерируем строки таблицы для сотрудников
        let tableRows = '';
        employees.forEach((emp, index) => {
            const name = emp.name || '';
            // Форматируем дату ознакомления в формате дд мммм ггггг
            const today = new Date();
            const day = today.getDate();
            const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 
                               'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const month = monthNames[today.getMonth()];
            const year = today.getFullYear();
            const dateFormatted = `${day} ${month} ${year}`;
            
            tableRows += `
                <tr>
                    <td style="text-align: center; border: 1px solid #000; padding: 8px;">${index + 1}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${name}</td>
                    <td style="text-align: center; border: 1px solid #000; padding: 8px;">${dateFormatted}</td>
                    <td style="text-align: center; border: 1px solid #000; padding: 8px;">✓</td>
                </tr>
            `;
        });

        const html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-weight: bold; font-size: 18px; margin-top: 30px;">
                    Лист ознакомления с графиком работы на
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="font-size: 12px; margin-bottom: 5px;">Месяц</div>
                    <div style="border: 2px solid #000; padding: 5px 10px; font-weight: bold; text-align: center;">
                        ${monthText}
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: inline-block; border: 2px solid #000; padding: 5px 10px; margin-bottom: 5px;">
                    <span style="font-weight: bold;">Аптечный пункт №</span> 
                    <span style="font-weight: bold;">${pharmacyNum}</span>
                </div>
                <div style="margin-top: 5px;">
                    <span style="font-weight: bold;">Адрес:</span> 
                    <span>${pharmacyAddr}</span>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">№ п/п</th>
                        <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">ФИО сотрудника</th>
                        <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Дата ознакомления</th>
                        <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Подпись</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;

        preview.innerHTML = html;
        preview.dataset.pharmacy = pharmacyNum;
        preview.dataset.address = pharmacyAddr;
        preview.dataset.month = month;
    }

    function printAckSheet() {
        const preview = document.getElementById('ackSheetPreview');
        const printWindow = window.open('', '', 'height=600,width=1200');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Лист ознакомления с графиком работы</title>
                <style>
                    @media print {
                        @page {
                            size: A4 portrait;
                            margin: 15mm;
                        }
                    }
                    body {
                        font-family: Arial, sans-serif;
                        padding: 10px;
                        color: #000;
                        font-size: 12px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                        font-size: 12px;
                    }
                    table th, table td {
                        border: 1px solid #000;
                        padding: 8px;
                    }
                    table th {
                        background-color: #ffffff;
                        font-weight: bold;
                        text-align: center;
                    }
                    table td:first-child {
                        text-align: center;
                    }
                    table td:nth-child(2) {
                        text-align: left;
                    }
                    table td:nth-child(3),
                    table td:nth-child(4) {
                        text-align: center;
                    }
                </style>
            </head>
            <body>
                ${preview.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => printWindow.print(), 250);
    }

    function exportAckSheetToCSV() {
        if (!ackSheetExportData) {
            alert('Нет данных для экспорта. Пожалуйста, откройте таблицу графика.');
            return;
        }

        const { employees, pharmacyNum, pharmacyAddr, month, monthIndex, year } = ackSheetExportData;
        const daysInMonth = getDaysInMonth(monthIndex, year);
        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                           'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        const monthNameUpper = monthNames[monthIndex].toUpperCase();
        const weekDays = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];

        let csv = '\uFEFF'; // BOM для правильной кодировки UTF-8
        csv += `ГРАФИК СОТРУДНИКОВ А/П НА ${monthNameUpper} ${year} г.\n`;
        csv += `Аптека № ${pharmacyNum}\n`;
        csv += `Адрес: ${pharmacyAddr}\n\n`;

        // Заголовки
        let header1 = 'Должность,Ф.И.О. сотрудника,';
        let header2 = ',,';
        for (let day = 1; day <= daysInMonth; day++) {
            header1 += day + ',';
            const date = new Date(year, monthIndex, day);
            header2 += weekDays[date.getDay()] + ',';
        }
        header1 += 'Отработано за месяц. час.\n';
        header2 += '\n';
        csv += header1 + header2;

        // Данные для каждого сотрудника
        employees.forEach((emp) => {
            const position = emp.position || 'Сотрудник';
            const name = emp.name || '';
            let totalHours = 0;

            // Строка "Начало работы"
            let startRow = `Начало работы,"${position} ${name}",`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let startTime = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        startTime = match[1] + ':00';
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        let hours = end - start - 1;
                        if (hours < 0) hours += 24;
                        totalHours += hours;
                    }
                }
                startRow += startTime + ',';
            }
            startRow += totalHours + '\n';
            csv += startRow;

            // Строка "Окончание работы"
            let endRow = 'Окончание работы,,';
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let endTime = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        endTime = match[2] + ':00';
                    }
                }
                endRow += endTime + ',';
            }
            endRow += '\n';
            csv += endRow;

            // Строка "Перерыв на обед"
            let breakRow = 'Перерыв на обед,,';
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                const hasBreak = dayValue ? '1' : '';
                breakRow += hasBreak + ',';
            }
            breakRow += '\n';
            csv += breakRow;

            // Строка "Количество часов"
            let hoursRow = 'Количество часов,,';
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let hours = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        let dayHours = end - start - 1;
                        if (dayHours < 0) dayHours += 24;
                        hours = dayHours.toString();
                    }
                }
                hoursRow += hours + ',';
            }
            hoursRow += totalHours + '\n';
            csv += hoursRow;
        });

        // Скачивание файла
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `График_сотрудников_${pharmacyNum}_${monthNameUpper}_${year}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportAckSheetToXLSX() {
        if (!ackSheetExportData) {
            alert('Нет данных для экспорта. Пожалуйста, откройте таблицу графика.');
            return;
        }

        if (typeof XLSX === 'undefined') {
            alert('Библиотека XLSX не загружена. Пожалуйста, обновите страницу.');
            return;
        }

        const { employees, pharmacyNum, pharmacyAddr, month, monthIndex, year } = ackSheetExportData;
        const daysInMonth = getDaysInMonth(monthIndex, year);
        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                           'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        const monthNameUpper = monthNames[monthIndex].toUpperCase();
        const weekDays = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];

        const wb = XLSX.utils.book_new();
        const ws_data = [];

        // Заголовок
        ws_data.push([`ГРАФИК СОТРУДНИКОВ А/П НА ${monthNameUpper} ${year} г.`]);
        ws_data.push([`Аптека № ${pharmacyNum}`]);
        ws_data.push([`Адрес: ${pharmacyAddr}`]);
        ws_data.push([]);

        // Заголовки таблицы
        const headerRow1 = ['Должность', 'Ф.И.О. сотрудника'];
        const headerRow2 = ['', ''];
        for (let day = 1; day <= daysInMonth; day++) {
            headerRow1.push(day);
            const date = new Date(year, monthIndex, day);
            headerRow2.push(weekDays[date.getDay()]);
        }
        headerRow1.push('Отработано за месяц. час.');
        headerRow2.push('');
        ws_data.push(headerRow1);
        ws_data.push(headerRow2);

        // Данные для каждого сотрудника
        employees.forEach((emp) => {
            const position = emp.position || 'Сотрудник';
            const name = emp.name || '';
            let totalHours = 0;

            // Строка "Начало работы"
            const startRow = ['Начало работы', `${position} ${name}`];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let startTime = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        startTime = match[1] + ':00';
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        let hours = end - start - 1;
                        if (hours < 0) hours += 24;
                        totalHours += hours;
                    }
                }
                startRow.push(startTime);
            }
            startRow.push(totalHours);
            ws_data.push(startRow);

            // Строка "Окончание работы"
            const endRow = ['Окончание работы', ''];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let endTime = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        endTime = match[2] + ':00';
                    }
                }
                endRow.push(endTime);
            }
            endRow.push('');
            ws_data.push(endRow);

            // Строка "Перерыв на обед"
            const breakRow = ['Перерыв на обед', ''];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                breakRow.push(dayValue ? '1' : '');
            }
            breakRow.push('');
            ws_data.push(breakRow);

            // Строка "Количество часов"
            const hoursRow = ['Количество часов', ''];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getDisplayValue(emp, day);
                let hours = '';
                if (dayValue) {
                    const match = dayValue.match(/(\d+)-(\d+)/);
                    if (match) {
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        let dayHours = end - start - 1;
                        if (dayHours < 0) dayHours += 24;
                        hours = dayHours.toString();
                    }
                }
                hoursRow.push(hours);
            }
            hoursRow.push(totalHours);
            ws_data.push(hoursRow);

            ws_data.push([]);
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [
            { wch: 18 },
            { wch: 25 },
            ...Array(daysInMonth).fill({ wch: 8 }),
            { wch: 20 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, 'График');
        XLSX.writeFile(wb, `График_сотрудников_${pharmacyNum}_${monthNameUpper}_${year}.xlsx`);
    }

    function downloadAckSheet() {
        const preview = document.getElementById('ackSheetPreview');
        const month = preview.dataset.month || 'sheet';
        const filename = `List-oznakomlenija-${month.replace(/\s+/g, '-')}.html`;

        const html = `
            <!DOCTYPE html>
            <html lang="ru">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Лист ознакомления</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        color: #000;
                        line-height: 1.4;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 8px;
                        font-size: 12px;
                    }
                    th {
                        background-color: #e8e8e8;
                        text-align: center;
                        font-weight: bold;
                    }
                    td:first-child {
                        text-align: center;
                        width: 40px;
                    }
                    .ack-title {
                        text-align: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-bottom: 5px;
                    }
                    .ack-subtitle {
                        text-align: center;
                        font-style: italic;
                        font-size: 12px;
                        margin-bottom: 15px;
                        color: #666;
                    }
                    .ack-info {
                        margin: 8px 0;
                        font-size: 12px;
                    }
                </style>
            </head>
            <body>
                ${preview.innerHTML}
            </body>
            </html>
        `;

        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modalOverlay = document.getElementById('ackSheetModal');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closeAckSheetModal();
                }
            });
        }
        
        const payrollModalOverlay = document.getElementById('payrollJournalModal');
        if (payrollModalOverlay) {
            payrollModalOverlay.addEventListener('click', function(e) {
                if (e.target === payrollModalOverlay) {
                    closePayrollJournalModal();
                }
            });
        }
    });

    // ===== ФУНКЦИИ ДЛЯ ЖУРНАЛА ВЫДАЧИ РАСЧЕТНЫХ ЛИСТКОВ =====

    function openPayrollJournalModal() {
        const modal = document.getElementById('payrollJournalModal');
        if (!modal) return;

        const employees = getUniqueEmployees();
        if (employees.length === 0) {
            alert('Сотрудники в графике не найдены. Пожалуйста, добавьте сотрудников в график.');
            return;
        }

        // Устанавливаем текущую дату по умолчанию
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const issueDateInput = document.getElementById('payrollIssueDate');
        if (issueDateInput) {
            issueDateInput.value = todayStr;
        }

        // Заполняем список годов (текущий год и несколько предыдущих/следующих)
        const yearSelect = document.getElementById('payrollPeriodYear');
        if (yearSelect) {
            yearSelect.innerHTML = '<option value="">Год</option>';
            const currentYear = today.getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Устанавливаем текущий месяц по умолчанию
        const monthSelect = document.getElementById('payrollPeriodMonth');
        if (monthSelect) {
            monthSelect.value = today.getMonth();
        }

        // Скрываем превью и кнопку печати до формирования
        const preview = document.getElementById('payrollJournalPreview');
        const printBtn = document.getElementById('btnPrintPayrollJournal');
        if (preview) preview.style.display = 'none';
        if (printBtn) printBtn.style.display = 'none';

        modal.classList.add('active');
    }

    function closePayrollJournalModal() {
        const modal = document.getElementById('payrollJournalModal');
        if (modal) {
            modal.classList.remove('active');
            // Сбрасываем форму
            const preview = document.getElementById('payrollJournalPreview');
            const printBtn = document.getElementById('btnPrintPayrollJournal');
            if (preview) {
                preview.innerHTML = '';
                preview.style.display = 'none';
            }
            if (printBtn) printBtn.style.display = 'none';
        }
    }

    // ===== EMPLOYEE MANAGER MODAL FUNCTIONS =====
    let employeeManagerData = {
        allEmployees: {},
        absenceData: {},
        compensationData: {},
        currentMonth: null,
        currentYear: null
    };

    // Функция для безопасного кодирования ключей Firebase
    function encodeFirebaseKeyEmployeeManager(key) {
        return String(key)
            .replace(/\./g, '_DOT_')
            .replace(/#/g, '_HASH_')
            .replace(/\$/g, '_DOLLAR_')
            .replace(/\//g, '_SLASH_')
            .replace(/\[/g, '_LBRACKET_')
            .replace(/\]/g, '_RBRACKET_');
    }

    // Функция для декодирования ключей Firebase
    function decodeFirebaseKeyEmployeeManager(key) {
        return String(key)
            .replace(/_DOT_/g, '.')
            .replace(/_HASH_/g, '#')
            .replace(/_DOLLAR_/g, '$')
            .replace(/_SLASH_/g, '/')
            .replace(/_LBRACKET_/g, '[')
            .replace(/_RBRACKET_/g, ']');
    }

    function openEmployeeManagerModal() {
        const modal = document.getElementById('employeeManagerModal');
        if (!modal) return;
        
        // Устанавливаем текущий месяц и год из основного графика
        employeeManagerData.currentMonth = currentMonth;
        employeeManagerData.currentYear = currentYear;
        
        // Обновляем селекторы месяца и года
        const monthSelect = document.getElementById('employeeManagerMonthSelect');
        const yearSelect = document.getElementById('employeeManagerYearSelect');
        if (monthSelect) monthSelect.value = currentMonth;
        if (yearSelect) yearSelect.value = currentYear;
        
        modal.classList.add('active');
        loadEmployeeManagerData();
    }

    function closeEmployeeManagerModal(event) {
        if (event && event.target !== event.currentTarget && !event.target.closest('.employee-manager-content')) {
            return;
        }
        const modal = document.getElementById('employeeManagerModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    async function loadEmployeeManagerData() {
        const loadingEl = document.getElementById('employeeManagerLoadingState');
        const emptyEl = document.getElementById('employeeManagerEmptyState');
        const infoEl = document.getElementById('employeeManagerInfo');
        
        if (loadingEl) loadingEl.style.display = 'block';
        if (emptyEl) emptyEl.style.display = 'none';
        if (infoEl) infoEl.classList.remove('active');
        
        try {
            // Проверяем, что аптека выбрана
            if (!currentPharmacyId || currentPharmacyId === '--') {
                if (loadingEl) loadingEl.style.display = 'none';
                if (emptyEl) {
                    emptyEl.style.display = 'block';
                    emptyEl.textContent = 'Выберите аптеку в основном графике для просмотра данных по сотрудникам.';
                }
                return;
            }
            
            // Загружаем данные об отсутствиях
            const absenceDataRaw = await firebaseGetItem('absenceData');
            employeeManagerData.absenceData = absenceDataRaw ? (typeof absenceDataRaw === 'string' ? JSON.parse(absenceDataRaw) : absenceDataRaw) : {};
            
            // Загружаем данные о компенсациях
            const compensationDataRaw = await firebaseGetItem('compensationData');
            const rawData = compensationDataRaw ? (typeof compensationDataRaw === 'string' ? JSON.parse(compensationDataRaw) : compensationDataRaw) : {};
            employeeManagerData.compensationData = {};
            if (rawData && typeof rawData === 'object') {
                for (const safeKey in rawData) {
                    const originalKey = decodeFirebaseKeyEmployeeManager(safeKey);
                    employeeManagerData.compensationData[originalKey] = rawData[safeKey];
                }
            }
            
            // Загружаем данные сотрудников для выбранного месяца/года (только текущей аптеки)
            await loadEmployeeManagerEmployees();
            
            populateEmployeeManagerSelect();
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (Object.keys(employeeManagerData.allEmployees).length === 0) {
                if (emptyEl) {
                    emptyEl.style.display = 'block';
                    emptyEl.textContent = 'Нет данных о сотрудниках выбранной аптеки за выбранный месяц. Попробуйте выбрать другой месяц.';
                }
            }
        } catch (error) {
            console.error('Error loading employee manager data:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (emptyEl) {
                emptyEl.style.display = 'block';
                emptyEl.textContent = 'Ошибка загрузки данных: ' + error.message;
            }
        }
    }

    async function loadEmployeeManagerEmployees() {
        employeeManagerData.allEmployees = {};
        
        // Получаем месяц и год из селекторов
        const monthSelect = document.getElementById('employeeManagerMonthSelect');
        const yearSelect = document.getElementById('employeeManagerYearSelect');
        const month = monthSelect ? parseInt(monthSelect.value) : employeeManagerData.currentMonth;
        const year = yearSelect ? parseInt(yearSelect.value) : employeeManagerData.currentYear;
        
        employeeManagerData.currentMonth = month;
        employeeManagerData.currentYear = year;
        
        // Загружаем данные только для текущей аптеки
        if (!currentPharmacyId || currentPharmacyId === '--' || !pharmacyReference || pharmacyReference.length === 0) {
            return;
        }
        
        // Находим текущую аптеку
        const currentPharmacy = pharmacyReference.find(p => {
            const pId = String(p.id || '');
            const pNumber = String(p.number || '');
            const currentId = String(currentPharmacyId);
            return pId === currentId || pNumber === currentId;
        });
        
        if (!currentPharmacy) {
            console.warn('Текущая аптека не найдена:', currentPharmacyId);
            return;
        }
        
        const pharmacyId = currentPharmacy.id || currentPharmacy.number;
        const key = getScheduleKey(year, month, pharmacyId);
        const data = await firebaseGetItem(key);
        
        if (data) {
            const scheduleData = typeof data === 'string' ? JSON.parse(data) : data;
            if (scheduleData && scheduleData.employees) {
                const employees = Array.isArray(scheduleData.employees) ? scheduleData.employees : [];
                employees.forEach(emp => {
                    if (!emp.name) return;
                    
                    // Фильтруем только основных сотрудников (не подработчиков)
                    const isSubcontractor = emp.isSubcontractor === true || 
                                           emp.isSubcontractor === 1 || 
                                           emp.isSubcontractor === 'true' || 
                                           emp.isSubcontractor === '1';
                    if (isSubcontractor) return; // Пропускаем подработчиков
                    
                    if (!employeeManagerData.allEmployees[emp.name]) {
                        employeeManagerData.allEmployees[emp.name] = [];
                    }
                    
                    const employeeRecord = {
                        ...emp,
                        pharmacyId: pharmacyId,
                        pharmacyNumber: currentPharmacy.number,
                        pharmacyName: `Аптека №${currentPharmacy.number}`,
                        isMain: !isSubcontractor
                    };
                    
                    employeeManagerData.allEmployees[emp.name].push(employeeRecord);
                });
            }
        }
    }

    function populateEmployeeManagerSelect() {
        const select = document.getElementById('employeeManagerSelect');
        if (!select) return;
        
        const names = Object.keys(employeeManagerData.allEmployees).sort();
        
        // Очищаем существующие опции кроме первой
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    function displayEmployeeManagerInfo() {
        const employeeName = document.getElementById('employeeManagerSelect').value;
        const infoEl = document.getElementById('employeeManagerInfo');
        const emptyEl = document.getElementById('employeeManagerEmptyState');
        
        if (!employeeName || !employeeManagerData.allEmployees[employeeName]) {
            if (infoEl) infoEl.classList.remove('active');
            if (emptyEl) emptyEl.style.display = 'block';
            return;
        }

        if (emptyEl) emptyEl.style.display = 'none';
        if (infoEl) infoEl.classList.add('active');

        const employeeData = employeeManagerData.allEmployees[employeeName];
        
        // Находим основную работу (используем логику из EmployeeManager.html)
        let mainPharmacyId = null;
        const employeeRef = employeeReference.find(e => e.name === employeeName);
        if (employeeRef && employeeRef.pharmacy) {
            mainPharmacyId = String(employeeRef.pharmacy);
        }
        
        let mainWork;
        if (mainPharmacyId) {
            mainWork = employeeData.find(e => {
                const empPharmacyId = String(e.pharmacyId || '');
                const empPharmacyNumber = String(e.pharmacyNumber || '');
                const mainPharmIdStr = String(mainPharmacyId);
                return empPharmacyId === mainPharmIdStr || empPharmacyNumber === mainPharmIdStr;
            });
        }
        if (!mainWork) {
            mainWork = employeeData.find(e => e.isMain === true);
        }
        if (!mainWork && employeeData.length > 0) {
            mainWork = employeeData[0];
        }
        
        if (!mainWork) {
            if (infoEl) infoEl.classList.remove('active');
            if (emptyEl) emptyEl.style.display = 'block';
            return;
        }
        
        // Отображаем основную информацию
        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                          'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        document.getElementById('empManagerName').textContent = employeeName;
        document.getElementById('empManagerPosition').textContent = mainWork.position || '-';
        document.getElementById('empManagerPharmacy').textContent = mainWork.pharmacyName || '-';
        document.getElementById('empManagerPeriod').textContent = `${monthNames[employeeManagerData.currentMonth]} ${employeeManagerData.currentYear}`;

        // Рассчитываем статистику (упрощенная версия, используя функции из EmployeeManager.html)
        const mainStats = calculateEmployeeManagerStats(mainWork, employeeManagerData.currentMonth, employeeManagerData.currentYear);
        
        // Фильтруем подработки
        const subWorks = employeeData.filter(e => e !== mainWork && 
                                                   !(e.pharmacyId === mainWork.pharmacyId && e.pharmacyNumber === mainWork.pharmacyNumber));
        
        let totalShifts = mainStats.totalShifts;
        let mainShifts = mainStats.totalShifts;
        let subShifts = 0;
        let subHours = 0;
        
        subWorks.forEach(sub => {
            const subStats = calculateEmployeeManagerStats(sub, employeeManagerData.currentMonth, employeeManagerData.currentYear);
            totalShifts += subStats.totalShifts;
            subShifts += subStats.totalShifts;
            subHours += subStats.totalHours;
        });

        document.getElementById('totalManagerShifts').textContent = totalShifts;
        document.getElementById('mainManagerShifts').textContent = mainShifts;
        document.getElementById('mainManagerHours').textContent = mainStats.totalHours + ' часов';
        document.getElementById('subManagerShifts').textContent = subShifts;
        document.getElementById('subManagerHours').textContent = subHours + ' часов';

        // Отображаем календарь и другие данные
        displayEmployeeManagerCalendar(mainWork, mainStats, subWorks, employeeName);
        displayEmployeeManagerCompensation(employeeName);
        displayEmployeeManagerAbsences(employeeName);
    }

    function calculateEmployeeManagerStats(employee, month, year) {
        if (!employee) {
            return { totalShifts: 0, totalHours: 0, shifts: [] };
        }
        
        const daysInMonth = getDaysInMonth(month, year);
        let totalShifts = 0;
        let totalHours = 0;
        const shifts = [];

        // Проверяем dayOverrides
        if (employee.dayOverrides && typeof employee.dayOverrides === 'object') {
            for (let day = 1; day <= daysInMonth; day++) {
                const absence = getAbsenceForEmployeeManager(employee.name, day, month, year);
                if (absence) continue;
                
                let override = employee.dayOverrides[day];
                if (!override && employee.dayOverrides[String(day)]) override = employee.dayOverrides[String(day)];
                
                if (override && override !== '' && override !== null && override !== undefined) {
                    const shift = parseShiftEmployeeManager(override);
                    if (shift) {
                        totalShifts++;
                        totalHours += shift.hours;
                        shifts.push({
                            day,
                            start: shift.start,
                            end: shift.end,
                            hours: shift.hours,
                            type: 'override',
                            pharmacyId: employee.pharmacyId
                        });
                    }
                }
            }
        }

        // Проверяем стандартное расписание
        if (employee.schedule && employee.schedule !== '') {
            const schedulePattern = employee.schedule.match(/^(\d+)\/(\d+)$/);
            
            if (schedulePattern) {
                const workDays = parseInt(schedulePattern[1]);
                const restDays = parseInt(schedulePattern[2]);
                const cycleLength = workDays + restDays;
                const startDay = employee.scheduleStartDay || 1;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const absence = getAbsenceForEmployeeManager(employee.name, day, month, year);
                    if (absence) continue;
                    
                    if (employee.dayOverrides && employee.dayOverrides[day] && employee.dayOverrides[day] !== '') {
                        continue;
                    }
                    
                    const dayInCycle = ((day - startDay) % cycleLength + cycleLength) % cycleLength;
                    const shouldWork = dayInCycle < workDays;
                    
                    if (shouldWork && employee.startHour && employee.endHour) {
                        const shift = parseShiftEmployeeManager(`${employee.startHour}-${employee.endHour}`);
                        if (shift) {
                            totalShifts++;
                            totalHours += shift.hours;
                            shifts.push({
                                day,
                                start: shift.start,
                                end: shift.end,
                                hours: shift.hours,
                                type: 'schedule',
                                pharmacyId: employee.pharmacyId
                            });
                        }
                    }
                }
            } else {
                const trimmedSchedule = employee.schedule.trim();
                let scheduleDays = [];
                if (/^\d+$/.test(trimmedSchedule)) {
                    scheduleDays = [parseInt(trimmedSchedule)];
                } else {
                    scheduleDays = employee.schedule.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const absence = getAbsenceForEmployeeManager(employee.name, day, month, year);
                    if (absence) continue;
                    
                    if (employee.dayOverrides && employee.dayOverrides[day] && employee.dayOverrides[day] !== '') {
                        continue;
                    }
                    
                    const date = new Date(year, month, day);
                    let dayOfWeekNum = date.getDay();
                    dayOfWeekNum = dayOfWeekNum === 0 ? 6 : dayOfWeekNum - 1;
                    const shouldWork = scheduleDays.includes(dayOfWeekNum);
                    
                    if (shouldWork && employee.startHour && employee.endHour) {
                        const shift = parseShiftEmployeeManager(`${employee.startHour}-${employee.endHour}`);
                        if (shift) {
                            totalShifts++;
                            totalHours += shift.hours;
                            shifts.push({
                                day,
                                start: shift.start,
                                end: shift.end,
                                hours: shift.hours,
                                type: 'schedule',
                                pharmacyId: employee.pharmacyId
                            });
                        }
                    }
                }
            }
        }

        return { totalShifts, totalHours, shifts };
    }

    function parseShiftEmployeeManager(shiftValue) {
        if (!shiftValue || shiftValue === '') return null;
        const match = shiftValue.match(/(\d+)-(\d+)/);
        if (match) {
            const start = parseInt(match[1]);
            const end = parseInt(match[2]);
            let hours = end - start - 1;
            if (hours < 0) hours += 24;
            return { start, end, hours };
        }
        return null;
    }

    function getAbsenceForEmployeeManager(employeeName, day, month, year) {
        if (!employeeManagerData.absenceData || !employeeManagerData.absenceData[employeeName]) return null;
        
        const checkDate = new Date(year, month, day);
        for (let absence of employeeManagerData.absenceData[employeeName]) {
            const startDate = new Date(absence.startDate);
            const endDate = new Date(absence.endDate);
            if (checkDate >= startDate && checkDate <= endDate) {
                return {
                    type: absence.type,
                    startDate: absence.startDate,
                    endDate: absence.endDate
                };
            }
        }
        return null;
    }

    function displayEmployeeManagerCalendar(mainWork, mainStats, subWorks, employeeName) {
        const container = document.getElementById('mainManagerWorkContent');
        if (!container) return;
        
        const daysInMonth = getDaysInMonth(employeeManagerData.currentMonth, employeeManagerData.currentYear);
        
        // Собираем все смены
        const allShifts = [];
        mainStats.shifts.forEach(shift => {
            allShifts.push({
                ...shift,
                isMain: true,
                pharmacyName: mainWork.pharmacyName,
                pharmacyNumber: mainWork.pharmacyNumber
            });
        });
        
        subWorks.forEach(sub => {
            const subStats = calculateEmployeeManagerStats(sub, employeeManagerData.currentMonth, employeeManagerData.currentYear);
            subStats.shifts.forEach(shift => {
                allShifts.push({
                    ...shift,
                    isMain: false,
                    pharmacyName: sub.pharmacyName,
                    pharmacyNumber: sub.pharmacyNumber
                });
            });
        });
        
        // Получаем отсутствия
        const absencesMap = {};
        if (employeeManagerData.absenceData && employeeManagerData.absenceData[employeeName]) {
            const absences = employeeManagerData.absenceData[employeeName];
            const currentMonthStart = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth, 1);
            const currentMonthEnd = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth + 1, 0);
            
            absences.forEach(absence => {
                const startDate = new Date(absence.startDate);
                const endDate = new Date(absence.endDate);
                
                if (startDate <= currentMonthEnd && endDate >= currentMonthStart) {
                    for (let d = new Date(Math.max(startDate, currentMonthStart)); 
                         d <= Math.min(endDate, currentMonthEnd); 
                         d.setDate(d.getDate() + 1)) {
                        if (d.getMonth() === employeeManagerData.currentMonth && d.getFullYear() === employeeManagerData.currentYear) {
                            const day = d.getDate();
                            if (!absencesMap[day]) {
                                absencesMap[day] = [];
                            }
                            absencesMap[day].push(absence.type);
                        }
                    }
                }
            });
        }
        
        // Создаем календарь
        let html = '<h3 style="font-size: 18px; margin-bottom: 15px; color: #000; padding: 10px; background: repeating-linear-gradient(45deg, #e8ecf5 0px, #e8ecf5 4px, rgba(232, 236, 245, 0.3) 4px, rgba(232, 236, 245, 0.3) 8px); border: 1px solid #000;">📅 Календарь смен</h3>';
        html += '<div class="employee-manager-calendar">';
        
        const weekDays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        weekDays.forEach(day => {
            html += `<div class="employee-manager-calendar-header">${day}</div>`;
        });
        
        const shiftsMap = {};
        allShifts.forEach(shift => {
            if (!shiftsMap[shift.day]) {
                shiftsMap[shift.day] = [];
            }
            shiftsMap[shift.day].push(shift);
        });
        
        const firstDay = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth, 1);
        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
        
        for (let i = 0; i < firstDayOfWeek; i++) {
            html += '<div class="employee-manager-calendar-day other-month"></div>';
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth, day);
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dayShifts = shiftsMap[day] || [];
            const dayAbsences = absencesMap[day] || [];
            const hasMainShift = dayShifts.some(s => s.isMain);
            const hasSubwork = dayShifts.some(s => !s.isMain);
            const hasAnyShift = dayShifts.length > 0;
            const hasAbsence = dayAbsences.length > 0;
            
            let dayClass = 'employee-manager-calendar-day';
            if (isWeekend) dayClass += ' weekend';
            if (hasMainShift) dayClass += ' has-shift';
            if (hasSubwork) dayClass += ' has-subwork';
            if (hasAbsence) dayClass += ' has-absence';
            
            html += `<div class="${dayClass}">`;
            html += `<div class="employee-manager-calendar-day-number">${day}</div>`;
            
            if (hasAbsence) {
                dayAbsences.forEach(absenceType => {
                    const absenceText = absenceType === 'vacation' ? 'Отпуск' : 'Больничный';
                    html += `<div class="employee-manager-calendar-day-absence">${absenceText}</div>`;
                });
            }
            
            if (hasAnyShift) {
                dayShifts.forEach(shift => {
                    const timeRange = `${String(shift.start).padStart(2, '0')}:00-${String(shift.end).padStart(2, '0')}:00`;
                    const shiftLabel = shift.isMain ? 'Смена' : `№${shift.pharmacyNumber}`;
                    html += `<div class="employee-manager-calendar-day-shift">${shiftLabel}</div>`;
                    html += `<div class="employee-manager-calendar-day-time">${timeRange}</div>`;
                    html += `<div class="employee-manager-calendar-day-time">${shift.hours} ч</div>`;
                });
            }
            
            html += '</div>';
        }
        
        const lastDay = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth, daysInMonth);
        let lastDayOfWeek = lastDay.getDay();
        lastDayOfWeek = lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1;
        const remainingDays = 6 - lastDayOfWeek;
        for (let i = 0; i < remainingDays; i++) {
            html += '<div class="employee-manager-calendar-day other-month"></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayEmployeeManagerCompensation(employeeName) {
        const container = document.getElementById('compensationManagerContent');
        if (!container) return;
        
        let foundData = employeeManagerData.compensationData && employeeManagerData.compensationData[employeeName];
        let actualEmployeeKey = employeeName;
        
        if (!foundData) {
            const shortName = formatFIOEmployeeManager(employeeName);
            if (employeeManagerData.compensationData && employeeManagerData.compensationData[shortName]) {
                foundData = employeeManagerData.compensationData[shortName];
                actualEmployeeKey = shortName;
            } else {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Нет данных о компенсациях</p>';
                return;
            }
        }
        
        employeeName = actualEmployeeKey;
        const employeeCompensations = employeeManagerData.compensationData[employeeName];
        const periodKey = `${employeeManagerData.currentYear}_${employeeManagerData.currentMonth}`;
        let currentCompensations = employeeCompensations[periodKey] || [];
        
        if (currentCompensations.length === 0) {
            container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Нет компенсаций в выбранном месяце</p>';
            return;
        }
        
        let html = `
            <table class="employee-manager-shifts-table">
                <thead>
                    <tr>
                        <th>Сумма / Время</th>
                        <th>Комментарий</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        currentCompensations.forEach((comp, index) => {
            const valueTypeDisplay = comp.valueType === 'hours' ? 'часов' : 'руб.';
            const valueText = comp.valueType === 'hours' 
                ? `${comp.value} ${valueTypeDisplay}` 
                : `${comp.value.toLocaleString('ru-RU', { minimumFractionDigits: 2 })} ${valueTypeDisplay}`;
            const commentText = comp.comment || '';
            
            html += `
                <tr>
                    <td>${valueText}</td>
                    <td>${commentText}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;
    }

    function displayEmployeeManagerAbsences(employeeName) {
        const container = document.getElementById('absenceManagerContent');
        if (!container) return;
        
        if (!employeeManagerData.absenceData || !employeeManagerData.absenceData[employeeName] || employeeManagerData.absenceData[employeeName].length === 0) {
            container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Нет больничных и отпусков</p>';
            return;
        }
        
        const absences = employeeManagerData.absenceData[employeeName];
        const currentAbsences = absences.filter(absence => {
            const startDate = new Date(absence.startDate);
            const endDate = new Date(absence.endDate);
            const currentMonthStart = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth, 1);
            const currentMonthEnd = new Date(employeeManagerData.currentYear, employeeManagerData.currentMonth + 1, 0);
            return (startDate <= currentMonthEnd && endDate >= currentMonthStart);
        });
        
        if (currentAbsences.length === 0) {
            container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Нет больничных и отпусков в выбранном месяце</p>';
            return;
        }
        
        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        function calculateDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }
        
        let html = `
            <table class="employee-manager-shifts-table">
                <thead>
                    <tr>
                        <th>Тип</th>
                        <th>Период</th>
                        <th>Количество дней</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        currentAbsences.forEach(absence => {
            const startDate = new Date(absence.startDate);
            const endDate = new Date(absence.endDate);
            const typeName = absence.type === 'vacation' ? 'Отпуск' : 'Больничный';
            const totalDays = calculateDays(startDate, endDate);
            
            html += `
                <tr>
                    <td>${typeName}</td>
                    <td>${formatDate(startDate)} - ${formatDate(endDate)}</td>
                    <td>${totalDays}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;
    }

    function formatFIOEmployeeManager(fullName) {
        if (!fullName) return '';
        if (fullName.match(/[А-ЯЁ]\.[А-ЯЁ]\./)) {
            return fullName;
        }
        const parts = fullName.trim().split(/\s+/);
        if (parts.length < 2) return fullName;
        const lastName = parts[0];
        const initials = parts.slice(1).map(part => {
            if (part.length > 0) {
                return part[0].toUpperCase() + '.';
            }
            return '';
        }).join('');
        return `${lastName} ${initials}`.trim();
    }

    // Event listeners для менеджера сотрудников
    document.addEventListener('DOMContentLoaded', function() {
        const employeeSelect = document.getElementById('employeeManagerSelect');
        const monthSelect = document.getElementById('employeeManagerMonthSelect');
        const yearSelect = document.getElementById('employeeManagerYearSelect');
        
        if (employeeSelect) {
            employeeSelect.addEventListener('change', displayEmployeeManagerInfo);
        }
        if (monthSelect) {
            monthSelect.addEventListener('change', function() {
                loadEmployeeManagerEmployees().then(() => {
                    populateEmployeeManagerSelect();
                    displayEmployeeManagerInfo();
                });
            });
        }
        if (yearSelect) {
            yearSelect.addEventListener('change', function() {
                loadEmployeeManagerEmployees().then(() => {
                    populateEmployeeManagerSelect();
                    displayEmployeeManagerInfo();
                });
            });
        }
    });

    async function generatePayrollJournalFromForm() {
        const issueDateInput = document.getElementById('payrollIssueDate');
        const monthSelect = document.getElementById('payrollPeriodMonth');
        const yearSelect = document.getElementById('payrollPeriodYear');

        if (!issueDateInput || !issueDateInput.value) {
            alert('Пожалуйста, выберите дату выдачи');
            return;
        }

        if (!monthSelect || !monthSelect.value || !yearSelect || !yearSelect.value) {
            alert('Пожалуйста, выберите расчетный период (месяц и год)');
            return;
        }

        const monthValue = parseInt(monthSelect.value);
        const yearValue = parseInt(yearSelect.value);
        
        // Получаем ID аптеки
        const pharmacySelect = document.getElementById('pharmacyNumber');
        let pharmacyId = currentPharmacyId;
        let pharmacyNumberText = '-- Не выбрано --';
        if (pharmacySelect && pharmacySelect.selectedIndex >= 0) {
            pharmacyId = pharmacySelect.value;
            const optionText = pharmacySelect.options[pharmacySelect.selectedIndex].text;
            const match = optionText.match(/Аптека\s*№\s*(.+)/);
            pharmacyNumberText = match ? match[1].trim() : optionText.replace(/^Аптека\s*№\s*/, '').trim();
        }

        // Сохраняем текущих сотрудников и текущий месяц/год
        const savedEmployees = [...employees];
        const savedMonth = currentMonth;
        const savedYear = currentYear;
        const savedPharmacyId = currentPharmacyId;

        // Загружаем сотрудников для выбранного месяца и года
        let selectedEmployees = [];
        try {
            await loadScheduleFor(yearValue, monthValue, pharmacyId);
            // Фильтруем сотрудников: только основные, без подработчиков
            selectedEmployees = employees
                .filter(emp => emp && emp.name && emp.name.length > 0)
                .filter(emp => !emp.name.match(/выберите|placeholder|---/i))
                .filter(emp => !(emp.isSubcontractor === true || emp.isSubcontractor === 1))
                .map(emp => ({
                    name: emp.name.trim(),
                    position: emp.position || 'Сотрудник'
                }))
                .sort((a, b) => a.name.localeCompare(b.name, 'ru'));
            
            // Восстанавливаем текущих сотрудников и период
            employees = savedEmployees;
            currentMonth = savedMonth;
            currentYear = savedYear;
            currentPharmacyId = savedPharmacyId;
        } catch (error) {
            console.error('Ошибка при загрузке сотрудников:', error);
            // Восстанавливаем в случае ошибки
            employees = savedEmployees;
            currentMonth = savedMonth;
            currentYear = savedYear;
            currentPharmacyId = savedPharmacyId;
            alert('Ошибка при загрузке сотрудников для выбранного периода.');
            return;
        }

        if (selectedEmployees.length === 0) {
            alert('Сотрудники в графике не найдены для выбранного периода.');
            return;
        }

        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                           'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        const monthName = monthNames[monthValue] || 'месяц';
        const payrollPeriod = monthName + ' ' + yearValue;

        const issueDate = new Date(issueDateInput.value);
        generatePayrollJournalPreview(selectedEmployees, pharmacyNumberText, payrollPeriod, issueDate);
    }

    function generatePayrollJournalPreview(employees, pharmacyNum, payrollPeriod, issueDate = null) {
        const preview = document.getElementById('payrollJournalPreview');
        const printBtn = document.getElementById('btnPrintPayrollJournal');

        if (!pharmacyNum) pharmacyNum = '-- Не выбрано --';
        if (!payrollPeriod) payrollPeriod = 'период не указан';

        // Используем переданную дату или текущую дату
        const dateToFormat = issueDate || new Date();
        const day = dateToFormat.getDate();
        const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 
                           'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
        const month = monthNames[dateToFormat.getMonth()];
        const year = dateToFormat.getFullYear();
        const todayFormatted = `${day} ${month} ${year} г.`; // Формат: "19 декабря 2025 г."

        // Генерируем строки таблицы - заполненные строки для сотрудников
        let tableRows = '';
        employees.forEach((emp, index) => {
            tableRows += `
                <tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td style="text-align:center;">${todayFormatted}</td>
                    <td>${emp.name}</td>
                    <td style="text-align:center;">${payrollPeriod}</td>
                    <td style="text-align:center;">✓</td>
                </tr>
            `;
        });

        const html = `
            <div class="payroll-journal-title">ЖУРНАЛ УЧЕТА ВЫДАЧИ РАСЧЕТНЫХ ЛИСТКОВ</div>
            <div style="text-align: center; font-size: 12px; margin-bottom: 5px; font-weight: normal;">Структурное подразделение: ООО "Парацельс"</div>
            <div style="text-align: center; font-size: 12px; margin-bottom: 15px; font-weight: normal;">Аптечный пункт № <span class="pharmacy-number-highlight">${pharmacyNum}</span></div>

            <table class="payroll-journal-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">№ п/п</th>
                        <th style="text-align: center;">Дата выдачи</th>
                        <th style="text-align: center;">ФИО работника</th>
                        <th style="text-align: center;">Расчетный период</th>
                        <th style="text-align: center;">Роспись в получении расчетного листка</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>

            <div class="payroll-journal-footer">
                <div style="display: flex; justify-content: flex-start; align-items: flex-start;">
                    <div>
                        <div style="margin-bottom: 5px; font-size: 12px;">Ответственный за выдачу расчетных листков</div>
                        <div style="display: flex; align-items: flex-start;">
                            <div style="margin-right: 20px; text-align: center;">
                                <div style="font-size: 11px; margin-bottom: 2px;">Востокова Ю.В.</div>
                                <div style="border-top: 1px solid #000; width: 150px; margin: 0 auto; margin-top: 5px;"></div>
                            </div>
                            <div style="text-align: center; padding-top: 20px;">
                                <div style="border-top: 1px solid #000; width: 150px; margin: 0 auto;"></div>
                                <div style="font-size: 10px; margin-top: 2px; text-align: center;">(подпись)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        preview.innerHTML = html;
        preview.dataset.pharmacy = pharmacyNum;
        preview.dataset.period = payrollPeriod;
        
        // Показываем превью и кнопку печати
        if (preview) preview.style.display = 'block';
        if (printBtn) printBtn.style.display = 'inline-block';
        
        // Прокручиваем к превью
        preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function printPayrollJournal() {
        const preview = document.getElementById('payrollJournalPreview');
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Журнал выдачи расчетных листков</title>
                <style>
                    * {
                        box-sizing: border-box;
                    }
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        color: #000;
                        margin: 0;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                        font-size: 12px;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 8px;
                        font-size: 12px;
                    }
                    th {
                        background-color: #ffffff !important;
                        text-align: center !important;
                        font-weight: normal !important;
                    }
                    td {
                        text-align: left;
                    }
                    td[style*="text-align: center"] {
                        text-align: center !important;
                    }
                    tbody tr {
                        height: 35px;
                    }
                    .payroll-journal-title {
                        text-align: center !important;
                        font-weight: bold !important;
                        font-size: 14px !important;
                        margin-bottom: 10px !important;
                        text-transform: uppercase !important;
                    }
                    .payroll-journal-subtitle {
                        text-align: center !important;
                        font-weight: normal !important;
                        font-size: 12px !important;
                        margin-bottom: 5px !important;
                    }
                    .payroll-journal-pharmacy {
                        text-align: center !important;
                        font-weight: normal !important;
                        font-size: 12px !important;
                        margin-bottom: 15px !important;
                    }
                    .pharmacy-number-highlight {
                        color: #ff0000 !important;
                        font-weight: bold !important;
                    }
                    .payroll-journal-footer {
                        margin-top: 30px !important;
                        font-size: 12px !important;
                    }
                    .payroll-journal-footer > div {
                        display: flex !important;
                        justify-content: space-between !important;
                        align-items: flex-end !important;
                    }
                    .payroll-journal-footer > div > div {
                        width: 250px !important;
                    }
                    .payroll-journal-footer > div > div[style*="text-align: center"] {
                        text-align: center !important;
                    }
                    .payroll-journal-footer > div > div:first-child {
                        width: 250px !important;
                    }
                    .payroll-journal-footer > div > div:first-child > div:first-child {
                        margin-bottom: 5px !important;
                        font-size: 12px !important;
                    }
                    .payroll-journal-footer > div > div:first-child > div:nth-child(2) {
                        border-top: 1px solid #000 !important;
                        width: 200px !important;
                        margin-top: 40px !important;
                    }
                    .payroll-journal-footer > div > div:first-child > div:last-child {
                        font-size: 10px !important;
                        margin-top: 5px !important;
                    }
                    .payroll-journal-footer > div > div:last-child > div:first-child {
                        border-top: 1px solid #000 !important;
                        width: 200px !important;
                        margin: 0 auto !important;
                        margin-top: 40px !important;
                    }
                    .payroll-journal-footer > div > div:last-child > div:last-child {
                        font-size: 10px !important;
                        margin-top: 5px !important;
                    }
                </style>
            </head>
            <body>
                ${preview.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => printWindow.print(), 250);
    }


        // ===== ФУНКЦИЯ ПОДСВЕТКИ НЕЗАКРЫТЫХ СМЕН И ДНЕЙ БЕЗ РАБОТНИКОВ =====
        function isNobodyWorkingOnDay(day) {
            // Функция для проверки отсутствия сотрудника на конкретный день
            function getAbsenceForDay(employeeName, day) {
                if (!absenceData || !absenceData[employeeName]) return null;
                const checkDate = new Date(currentYear, currentMonth, day);
                for (let absence of absenceData[employeeName]) {
                    const startDate = new Date(absence.startDate);
                    const endDate = new Date(absence.endDate);
                    if (checkDate >= startDate && checkDate <= endDate) {
                        return {
                            symbol: absence.type === 'vacation' ? 'О' : 'Б',
                            color: absence.type === 'vacation' ? '#fff3cd' : '#f8d7da'
                        };
                    }
                }
                return null;
            }
            
            // Проверяем всех сотрудников из глобального массива employees
            if (employees && employees.length > 0) {
                for (let emp of employees) {
                    if (!emp || !emp.name) continue;
                    const dayValue = getDisplayValue(emp, day);
                    const absence = getAbsenceForDay(emp.name, day);
                    // Если есть смена (dayValue) или отсутствие - значит сотрудник "занят" в этот день
                    if (dayValue || absence) {
                        return false; // Кто-то работает в этот день
                    }
                }
            }
            return true; // Никто не работает в этот день
        }

        function highlightDaysWithNobody() {
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            const tbody = document.getElementById('scheduleBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            if (rows.length < 2) return;

            // Сначала проходим по каждому сотруднику и подсвечиваем незакрытые смены
            // Обрабатываем все 4 строки каждого сотрудника: Начало, Окончание, Перерыв, Часы
            let employeeRowIndex = 2;
            for (let empIdx = 0; empIdx < employees.length; empIdx++) {
                if (employeeRowIndex >= rows.length) break;

                const employee = employees[empIdx];
                
                // Обрабатываем все 4 строки сотрудника
                for (let rowOffset = 0; rowOffset < 4; rowOffset++) {
                    const currentRowIndex = employeeRowIndex + rowOffset;
                    if (currentRowIndex >= rows.length) break;
                    
                    const row = rows[currentRowIndex];
                    const cells = row.querySelectorAll('td');

                    // Проходим по каждому дню
                    for (let day = 1; day <= daysInMonth; day++) {
                        let colIndex;
                        
                        if (rowOffset === 0) {
                            // Строка "Начало работы": Должность (0), ФИО (1), График (2), дни (3, 4, 5...)
                            colIndex = day + 2;
                        } else {
                            // Строки "Окончание работы", "Перерыв на обед", "Количество часов":
                            // Должность и ФИО не видны из-за rowSpan, График (0), дни (1, 2, 3...)
                            colIndex = day;
                        }

                        if (cells.length > colIndex) {
                            const cell = cells[colIndex];

                            // Проверяем: должен ли работать и закрыта ли смена?
                            // Только для строки "Начало работы" проверяем незакрытые смены
                            if (rowOffset === 0) {
                                const shouldWork = isEmployeeWorkDay(employee, day);
                                const displayValue = getDisplayValue(employee, day);

                                // Если должен работать, но смена не указана - незакрытая смена
                                if (shouldWork === true && !displayValue) {
                                    cell.classList.add('day-no-workers');
                                } else {
                                    cell.classList.remove('day-no-workers');
                                }
                            } else {
                                // Для остальных строк просто убираем подсветку незакрытых смен
                                // (подсветка дней без работников обрабатывается во втором цикле)
                                const shouldWork = isEmployeeWorkDay(employee, day);
                                const displayValue = getDisplayValue(employee, day);
                                if (!(shouldWork === true && !displayValue)) {
                                    // Убираем только если это не незакрытая смена
                                    // (но это не должно быть здесь, так как незакрытые смены только в строке "Начало")
                                }
                            }
                        }
                    }
                }

                employeeRowIndex += 4; // Каждый сотрудник занимает 4 строки
            }

            // Затем подсвечиваем дни, когда вообще никто не работает
            for (let day = 1; day <= daysInMonth; day++) {
                if (isNobodyWorkingOnDay(day)) {
                    // Подсвечиваем день во всех рядах
                    rows.forEach((row, rowIdx) => {
                        const cells = row.querySelectorAll('td');
                        let colIndex;
                        
                        // Для заголовков (первые 2 строки) структура отличается из-за rowSpan
                        if (rowIdx === 0) {
                            // row1: Должность (0), ФИО (1), График (2), дни (3, 4, 5...)
                            colIndex = day + 2;
                        } else if (rowIdx === 1) {
                            // row2: дни начинаются с индекса 0 (нет Должность/ФИО/График из-за rowSpan)
                            colIndex = day - 1;
                        } else {
                            // Для строк с данными сотрудников структура зависит от типа строки
                            // Каждый сотрудник занимает 4 строки: Начало (0), Окончание (1), Перерыв (2), Часы (3)
                            const rowInEmployeeBlock = (rowIdx - 2) % 4;
                            
                            if (rowInEmployeeBlock === 0) {
                                // Строка "Начало работы": Должность (0), ФИО (1), График (2), дни (3, 4, 5...)
                                colIndex = day + 2;
                            } else {
                                // Строки "Окончание работы", "Перерыв на обед", "Количество часов":
                                // Должность и ФИО не видны из-за rowSpan, График (0), дни (1, 2, 3...)
                                colIndex = day;
                            }
                        }
                        
                        if (cells.length > colIndex) {
                            cells[colIndex].classList.add('day-no-workers');
                        }
                    });
                } else {
                    // Убираем подсветку для дней, где кто-то работает
                    // Для заголовков и строк с данными (кроме незакрытых смен)
                    rows.forEach((row, rowIdx) => {
                        const cells = row.querySelectorAll('td');
                        let colIndex;
                        
                        // Для заголовков (первые 2 строки) структура отличается из-за rowSpan
                        if (rowIdx === 0) {
                            // row1: Должность (0), ФИО (1), График (2), дни (3, 4, 5...)
                            colIndex = day + 2;
                        } else if (rowIdx === 1) {
                            // row2: дни начинаются с индекса 0 (нет Должность/ФИО/График из-за rowSpan)
                            colIndex = day - 1;
                        } else {
                            // Для строк с данными сотрудников структура зависит от типа строки
                            // Каждый сотрудник занимает 4 строки: Начало (0), Окончание (1), Перерыв (2), Часы (3)
                            const rowInEmployeeBlock = (rowIdx - 2) % 4;
                            
                            if (rowInEmployeeBlock === 0) {
                                // Строка "Начало работы": Должность (0), ФИО (1), График (2), дни (3, 4, 5...)
                                colIndex = day + 2;
                                
                                // Проверяем, не является ли это незакрытой сменой
                                // Если это незакрытая смена, не убираем подсветку
                                const empRowIdx = Math.floor((rowIdx - 2) / 4);
                                if (empRowIdx >= 0 && empRowIdx < employees.length) {
                                    const emp = employees[empRowIdx];
                                    const shouldWork = isEmployeeWorkDay(emp, day);
                                    const displayValue = getDisplayValue(emp, day);
                                    // Если это незакрытая смена, не убираем подсветку
                                    if (shouldWork === true && !displayValue) {
                                        return; // Пропускаем удаление подсветки для незакрытых смен
                                    }
                                }
                            } else {
                                // Строки "Окончание работы", "Перерыв на обед", "Количество часов":
                                // Должность и ФИО не видны из-за rowSpan, График (0), дни (1, 2, 3...)
                                colIndex = day;
                            }
                        }
                        
                        if (cells.length > colIndex) {
                            cells[colIndex].classList.remove('day-no-workers');
                        }
                    });
                }
            }
        }


// ================= СИНХРОНИЗАЦИЯ =================

let GAS_URL = 'https://script.google.com/macros/s/AKfycbyQm-7IIfHwjRbHasApN6ojl15vD6p3v0tNaqbaoLEeOMIebxhq4fbh7ScG4IU3RQSpbA/exec';

// ⭐ ПРИМЕНИТЬ И ЗАГРУЗИТЬ ГРАФИК
function applyAndLoad() {
  console.log('🔄 Применить и загрузить график');
  applyMonthYear();
  setTimeout(() => {
    autoLoadSchedule();
  }, 800);
}

// ⭐ СОХРАНИТЬ ГРАФИК
async function saveSchedule() {
  try {
    const pharmacyId = currentPharmacyId;
    const month = currentMonth;
    const year = currentYear;

    if (!pharmacyId || month === null || month === undefined || !year) {
      alert('Выберите аптеку, месяц, год');
      return;
    }

    if (!employees || employees.length === 0) {
      alert('Нет сотрудников в графике');
      return;
    }

    const schedule = {};
    for (let day = 1; day <= getDaysInMonth(month, year); day++) {
      schedule[day] = {};
      for (let emp of employees) {
        if (isEmployeeWorkDay(emp, day)) {
          schedule[day][emp.name] = {
            position: emp.position || '',
            startHour: emp.startHour || 9,
            endHour: emp.endHour || 18
          };
        }
      }
    }

    // ⭐ ОТЛАДКА: Смотрим что отправляем
    let employeeRef = await firebaseGetItem('employeeReference') || [];
    let pharmacyRef = await firebaseGetItem('pharmacyReference') || [];
    if (typeof employeeRef === 'string') employeeRef = JSON.parse(employeeRef);
    if (typeof pharmacyRef === 'string') pharmacyRef = JSON.parse(pharmacyRef);
    if (!Array.isArray(employeeRef)) employeeRef = [];
    if (!Array.isArray(pharmacyRef)) pharmacyRef = [];
    console.log('📊 ОТПРАВЛЯЕМ:');
    console.log('   Сотрудники в Firebase:', employeeRef.length);
    console.log('   Аптеки в Firebase:', pharmacyRef.length);
    console.log('   Полный список сотрудников:', JSON.stringify(employeeRef));
    console.log('   Полный список аптек:', JSON.stringify(pharmacyRef));

    const absenceDataValue = await firebaseGetItem('absenceData') || {};
    const absenceDataFinal = typeof absenceDataValue === 'string' ? JSON.parse(absenceDataValue) : absenceDataValue;

    const payload = {
      action: 'save',
      pharmacy_id: pharmacyId,
      month: parseInt(month),
      year: parseInt(year),
      schedule_data: schedule,
      absence_data: absenceDataFinal,
      employee_ref: employeeRef,
      pharmacy_ref: pharmacyRef
    };

    const response = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (result.success) {
      let shifts = 0;
      Object.values(schedule).forEach(day => shifts += Object.keys(day).length);
      alert('✅ Сохранено: ' + employees.length + ' сотр., ' + shifts + ' смен\nСправочники: ' + employeeRef.length + ' сотр., ' + pharmacyRef.length + ' аптек');
    } else {
      alert('❌ Ошибка: ' + result.error);
    }
  } catch(e) {
    alert('❌ Ошибка: ' + e.message);
  }
}

// ⭐ ЗАГРУЗИТЬ ГРАФИК
async function autoLoadSchedule() {
  try {
    const pharmacyId = currentPharmacyId;
    const month = currentMonth;
    const year = currentYear;

    if (!pharmacyId || month === null || month === undefined || !year) {
      console.log('⚠️ Параметры не выбраны');
      return;
    }

    console.log('📥 Загрузка графика: аптека ' + pharmacyId + ', месяц ' + month);

    const response = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'load',
        pharmacy_id: pharmacyId,
        month: parseInt(month),
        year: parseInt(year)
      })
    });

    const result = await response.json();

    if (result.success && result.schedule && Object.keys(result.schedule).length > 0) {
      console.log('✅ График загружен');
      await firebaseSetItem('scheduleReferenceData', result.schedule);
      if (result.absence) await firebaseSetItem('absenceData', result.absence);
      if (result.employeeRef) await firebaseSetItem('employeeReference', result.employeeRef);
      if (result.pharmacyRef) await firebaseSetItem('pharmacyReference', result.pharmacyRef);
      alert('✅ Данные загружены, обновление...');
      location.reload();
    }
  } catch(e) {
    console.log('⚠️ Ошибка загрузки:', e.message);
  }
}

// ⭐ ЗАГРУЗИТЬ СПРАВОЧНИКИ
async function syncReferencesFromServer() {
  try {
    console.log('📥 Загрузка справочников с сервера');
    alert('⏳ Загрузка справочников...');

    const response = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'loadReferences'
      })
    });

    const result = await response.json();

    if (result.success) {
      console.log('✅ Справочники получены:');
      console.log('   Сотрудники:', result.employeeReference.length);
      console.log('   Аптеки:', result.pharmacyReference.length);
      console.log('   Полные данные:', result);

      if (result.employeeReference && result.employeeReference.length > 0) {
        await firebaseSetItem('employeeReference', result.employeeReference);
      }

      if (result.pharmacyReference && result.pharmacyReference.length > 0) {
        await firebaseSetItem('pharmacyReference', result.pharmacyReference);
      }

      alert('✅ Справочники загружены: ' + result.employeeReference.length + ' сотр., ' + result.pharmacyReference.length + ' аптек');
      location.reload();
    } else {
      alert('❌ Ошибка: ' + result.error);
    }
  } catch(e) {
    alert('❌ Ошибка подключения: ' + e.message);
  }
}

// ⭐ СОХРАНИТЬ СПРАВОЧНИКИ
async function syncReferencesToServer() {
  try {
    console.log('📤 Сохранение справочников на сервер');

    // ⭐ ВАЖНО: Берём справочники откуда-то нужно
    let employeeRef = [];
    let pharmacyRef = [];

    // Пробуем получить из window переменных
    if (typeof employeeReference !== 'undefined') {
      employeeRef = employeeReference;
      console.log('✓ Найдены employeeReference в window:', employeeRef.length);
    } else {
      employeeRef = await firebaseGetItem('employeeReference') || [];
      if (typeof employeeRef === 'string') employeeRef = JSON.parse(employeeRef);
      if (!Array.isArray(employeeRef)) employeeRef = [];
      console.log('✓ Получены employeeReference из Firebase:', employeeRef.length);
    }

    if (typeof pharmacyReference !== 'undefined') {
      pharmacyRef = pharmacyReference;
      console.log('✓ Найдены pharmacyReference в window:', pharmacyRef.length);
    } else {
      pharmacyRef = await firebaseGetItem('pharmacyReference') || [];
      if (typeof pharmacyRef === 'string') pharmacyRef = JSON.parse(pharmacyRef);
      if (!Array.isArray(pharmacyRef)) pharmacyRef = [];
      console.log('✓ Получены pharmacyReference из Firebase:', pharmacyRef.length);
    }

    console.log('📤 Отправляем: ' + employeeRef.length + ' сотр., ' + pharmacyRef.length + ' аптек');

    alert('⏳ Сохранение ' + employeeRef.length + ' сотр., ' + pharmacyRef.length + ' аптек...');

    const response = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'saveReferences',
        employee_ref: employeeRef,
        pharmacy_ref: pharmacyRef
      })
    });

    const result = await response.json();

    if (result.success) {
      console.log('✅ Справочники сохранены');
      alert('✅ ' + result.message);
    } else {
      alert('❌ Ошибка: ' + result.error);
    }
  } catch(e) {
    alert('❌ Ошибка: ' + e.message);
  }
}

console.log('✅ Синхронизация готова');

// ================= КОНЕЦ =================
</script>

    <div id="absenceModal" class="modal">
        <div class="modal-content" style="width: 550px; max-width: 95vw;">
            <div class="modal-title">Добавить отпуск/Больничный</div>
            <div class="modal-body">
            <form id="absenceForm">
                    <div class="form-group">
                        <label class="form-label">ФИО сотрудника:</label>
                        <select id="absenceEmployee" class="form-select" required>
                        <option value="">-- Выберите --</option>
                    </select>
                </div>
                    <div class="form-group">
                        <label class="form-label">Причина:</label>
                        <select id="absenceType" class="form-select" required>
                        <option value="">-- Выберите --</option>
                        <option value="vacation">Отпуск</option>
                        <option value="sick">Больничный</option>
                    </select>
                </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">От:</label>
                            <input type="date" id="absenceStartDate" class="form-input" required>
                    </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">До:</label>
                            <input type="date" id="absenceEndDate" class="form-input" required>
                    </div>
                </div>
            </form>
            </div>
            <div class="modal-buttons" style="justify-content: flex-end;">
                <button type="button" class="btn-submit" onclick="saveAbsence()">Сохранить</button>
                <button type="button" class="btn-cancel" onclick="closeAbsenceModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Лист ознакомления с графиком работы -->
    <div id="ackSheetModal" class="modal-overlay-ack">
        <div class="modal-ack">
            <div class="modal-header-ack">
                <h2>Лист ознакомления с графиком работы</h2>
                <button class="modal-close-ack" onclick="closeAckSheetModal()">×</button>
            </div>

            <div class="modal-body-ack">
                <div id="ackSheetPreview" class="ack-sheet-preview"></div>
            </div>

            <div class="modal-footer-ack">
                <button class="btn-print-ack" onclick="printAckSheet()">🖨️ Печать</button>
                <button class="btn-close-modal-ack" onclick="closeAckSheetModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Журнал выдачи расчетных листков -->
    <div id="payrollJournalModal" class="modal-overlay-ack">
        <div class="modal-ack">
            <div class="modal-header-ack">
                <h2>Журнал учета выдачи расчетных листков</h2>
                <button class="modal-close-ack" onclick="closePayrollJournalModal()">×</button>
            </div>

            <div class="modal-body-ack">
                <div id="payrollJournalForm" style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Дата выдачи:</label>
                            <input type="date" id="payrollIssueDate" class="form-input" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Расчетный период:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <select id="payrollPeriodMonth" class="form-select" required>
                                    <option value="">Месяц</option>
                                    <option value="0">Январь</option>
                                    <option value="1">Февраль</option>
                                    <option value="2">Март</option>
                                    <option value="3">Апрель</option>
                                    <option value="4">Май</option>
                                    <option value="5">Июнь</option>
                                    <option value="6">Июль</option>
                                    <option value="7">Август</option>
                                    <option value="8">Сентябрь</option>
                                    <option value="9">Октябрь</option>
                                    <option value="10">Ноябрь</option>
                                    <option value="11">Декабрь</option>
                                </select>
                                <select id="payrollPeriodYear" class="form-select" required>
                                    <option value="">Год</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn-submit" onclick="generatePayrollJournalFromForm()" style="width: 100%;">Сформировать журнал</button>
                </div>
                <div id="payrollJournalPreview" class="ack-sheet-preview" style="display: none;"></div>
            </div>

            <div class="modal-footer-ack">
                <button class="btn-print-ack" id="btnPrintPayrollJournal" onclick="printPayrollJournal()" style="display: none;">🖨️ Печать</button>
                <button class="btn-close-modal-ack" onclick="closePayrollJournalModal()">Закрыть</button>
            </div>
        </div>
    </div>
</body>
</html>
