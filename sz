<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –°–ó: –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: white;
        }
        
        /* –≠–º—É–ª—è—Ü–∏—è –ª–∏—Å—Ç–∞ A4 */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto 20px auto; 
            background: white;
            box-shadow: none;
            border: 1px solid #000;
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.15;
            color: #000;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* –°–µ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
        .doc-header-grid {
            display: grid;
            grid-template-columns: 60% 40%; 
            gap: 0 10px;
            margin-bottom: 5px;
        }
        
        .doc-col {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .doc-line {
            min-height: 1.2em;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-field {
            border: 1px solid #000;
            border-radius: 0;
            transition: none;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            );
        }
        .input-field:focus {
            outline: none;
            border-color: #000;
            box-shadow: none;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            );
        }
        .input-field:hover {
            border-color: #000;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —á–µ–∫–æ–≤ */
        .receipt-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
        }
        .receipt-img {
            max-width: 100%;
            max-height: 250mm; 
            object-fit: contain;
            border: 1px solid #000; 
        }
        .receipt-label {
            align-self: flex-start;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14pt;
        }

        /* –°–ø–∏—Å–æ–∫ —á–µ–∫–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        .receipt-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border: 1px solid #000;
            border-radius: 0;
            margin-bottom: 8px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è header */
        header {
            background: white !important;
            border-bottom: 1px solid #000 !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è aside */
        aside {
            background: white !important;
            border-right: 1px solid #000 !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        button {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0 0px,
                #f0f0f0 4px,
                rgba(240, 240, 240, 0.3) 4px,
                rgba(240, 240, 240, 0.3) 8px
            ) !important;
            color: #000 !important;
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            font-weight: 600 !important;
            transition: none !important;
            box-shadow: none !important;
        }
        
        button:hover {
            background: repeating-linear-gradient(
                45deg,
                #e0e0e0 0px,
                #e0e0e0 4px,
                rgba(224, 224, 224, 0.3) 4px,
                rgba(224, 224, 224, 0.3) 8px
            ) !important;
        }
        
        button:active {
            background: repeating-linear-gradient(
                45deg,
                #d0d0d0 0px,
                #d0d0d0 4px,
                rgba(208, 208, 208, 0.3) 4px,
                rgba(208, 208, 208, 0.3) 8px
            ) !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ */
        select {
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            ) !important;
        }
        
        select:focus {
            outline: none !important;
            border-color: #000 !important;
            box-shadow: none !important;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            ) !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è textarea */
        textarea {
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            background: repeating-linear-gradient(
                45deg,
                #fafbff 0px,
                #fafbff 4px,
                rgba(250, 251, 255, 0.3) 4px,
                rgba(250, 251, 255, 0.3) 8px
            ) !important;
        }
        
        textarea:focus {
            outline: none !important;
            border-color: #000 !important;
            box-shadow: none !important;
            background: repeating-linear-gradient(
                45deg,
                #ffffff 0px,
                #ffffff 4px,
                rgba(255, 255, 255, 0.3) 4px,
                rgba(255, 255, 255, 0.3) 8px
            ) !important;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        main {
            background: white !important;
        }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—á–∞—Ç–∏ */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            html {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
            }
            
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            header, aside {
                display: none !important;
            }
            
            main.no-print-page {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                background: white !important;
                height: auto !important;
            }
            
            main.no-print-page::after {
                display: none !important;
                content: none !important;
            }
            
            .pages-container {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            
            .pages-container::after {
                display: none !important;
                content: none !important;
            }
            
            .a4-page {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                width: 100% !important;
                min-height: 297mm !important;
                page-break-inside: avoid !important;
                padding: 20mm !important;
                display: block !important;
                background: white !important;
                position: relative !important;
                box-sizing: border-box !important;
            }
            
            /* –†–∞–∑—Ä—ã–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ */
            .a4-page:not(:last-child) {
                page-break-after: always !important;
            }
            
            /* –£–±–∏—Ä–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            .a4-page:last-child {
                page-break-after: avoid !important;
            }
            
            .pages-container > .a4-page:last-child {
                page-break-after: avoid !important;
            }
            
            .receipt-img {
                border: none !important;
                max-width: 100% !important;
                max-height: 257mm !important;
                height: auto !important;
                object-fit: contain !important;
            }
            
            #previewAmountTextBlock {
                background: transparent !important;
                border: none !important;
                padding: 0 !important;
            }
            
            @page {
                size: A4;
                margin: 0;
                padding: 0;
            }
            
            /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            body::after,
            html::after {
                display: none !important;
                content: none !important;
            }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <header class="h-16 flex-none no-print z-20" style="background: white; border-bottom: 1px solid #000;">
        <div class="container mx-auto px-4 h-full flex items-center justify-end">
            <div class="flex gap-3">
                <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 text-sm" style="background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); color: #000; border: 1px solid #000; border-radius: 0; font-weight: 600;">
                    <span>üñ®Ô∏è –ü–µ—á–∞—Ç—å</span>
                </button>
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <aside class="w-full md:w-[350px] overflow-y-auto no-print flex flex-col z-10" style="background: white; border-right: 1px solid #000;">
            <div class="p-6">
                <form id="docForm" class="space-y-4" onsubmit="return false;">
                    
                    <!-- 1. –û–¢ –ö–û–ì–û -->
                    <div class="space-y-3 border-b border-black pb-4">
                        <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider">–û—Ç –∫–æ–≥–æ</h3>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                            <select id="employeeSelect" 
                                class="input-field w-full px-3 py-2 text-sm text-black" style="padding: 12px 14px;">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–§–ò–û</label>
                            <input type="text" id="employeeInput" value="" 
                                class="input-field w-full px-3 py-2 text-sm text-black" style="padding: 12px 14px;">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <input type="text" id="employeeTitleInput" value="" 
                                class="input-field w-full px-3 py-2 text-sm text-black" style="padding: 12px 14px;">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                            <input type="text" id="employeeDepartmentInput" value="" 
                                class="input-field w-full px-3 py-2 text-sm text-black" style="padding: 12px 14px;">
                        </div>
                    </div>

                    <!-- 2. –¢–ï–ö–°–¢ –ó–ê–Ø–í–õ–ï–ù–ò–Ø -->
                    <div class="space-y-3 border-b border-black pb-4">
                        <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider">–¢–µ–∫—Å—Ç –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–†–∞—Å—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥</label>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="periodMonthInput" 
                                    class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                                    <option value="0">–Ø–Ω–≤–∞—Ä—å</option>
                                    <option value="1">–§–µ–≤—Ä–∞–ª—å</option>
                                    <option value="2">–ú–∞—Ä—Ç</option>
                                    <option value="3">–ê–ø—Ä–µ–ª—å</option>
                                    <option value="4">–ú–∞–π</option>
                                    <option value="5">–ò—é–Ω—å</option>
                                    <option value="6">–ò—é–ª—å</option>
                                    <option value="7">–ê–≤–≥—É—Å—Ç</option>
                                    <option value="8">–°–µ–Ω—Ç—è–±—Ä—å</option>
                                    <option value="9">–û–∫—Ç—è–±—Ä—å</option>
                                    <option value="10">–ù–æ—è–±—Ä—å</option>
                                    <option value="11">–î–µ–∫–∞–±—Ä—å</option>
                                </select>
                                <select id="periodYearInput" 
                                    class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea id="commentInput" rows="3" 
                                class="input-field w-full text-sm text-black"
                                placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="padding: 12px 14px;"></textarea>
                        </div>
                        <input type="hidden" id="reasonInput" value="">
                        <div class="hidden">
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–û–±—ä–µ–∫—Ç</label>
                            <input type="text" id="objectInput" list="objectsList" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ..."
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                            <datalist id="objectsList"></datalist>
                            <p id="sheetStatus" class="text-[10px] text-gray-600 mt-1">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–∑ Google Sheets...</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–¢–∏–ø –∑–Ω–∞—á–µ–Ω–∏—è</label>
                            <select id="valueTypeInput" 
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                                <option value="amount">–°—É–º–º–∞ (–†—É–±.)</option>
                                <option value="hours">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤</option>
                            </select>
                        </div>
                        <div id="amountContainer">
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–°—É–º–º–∞ (–†—É–±.)</label>
                            <input type="number" id="amountInput" placeholder="0.00" step="0.01" min="0"
                                class="input-field w-full text-sm font-bold text-black" style="padding: 12px 14px;">
                        </div>
                        <div id="hoursContainer" class="hidden">
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤</label>
                            <input type="number" id="hoursInput" placeholder="0" step="1" min="0"
                                class="input-field w-full text-sm font-bold text-black" style="padding: 12px 14px;">
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–î–∞—Ç–∞ –¥–æ–∫-—Ç–∞</label>
                             <input type="date" id="dateInput" 
                                 class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                        </div>
                    </div>

                    <!-- 3. –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–ß–ï–ö–ò) -->
                    <div class="space-y-3 border-b border-black pb-4">
                        <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ß–µ–∫–∏)</h3>
                        <div>
                            <label for="receiptsInput" class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold w-full justify-center" style="background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); color: #000; border: 1px solid #000; border-radius: 0; font-weight: 600;">
                                <span>‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–µ–∫–∏</span>
                            </label>
                            <input type="file" id="receiptsInput" multiple accept="image/*" class="hidden">
                        </div>
                        <div id="receiptsList" class="mt-2 space-y-2"></div>
                        <p id="noReceiptsMsg" class="text-[10px] text-gray-600 text-center py-2 mt-2">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤</p>
                    </div>

                    <!-- 4. –ê–î–†–ï–°–ê–¢–´ -->
                    <div class="space-y-3 border-b border-black pb-4">
                        <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider">–ö–æ–º—É</h3>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–§–ò–û</label>
                            <input type="text" id="directorInput" value="–ë–æ—á–∞—Ä–æ–≤–æ–π –ê.–í." 
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <input type="text" id="directorTitleInput" value="–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä" 
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                        </div>
                    </div>

                    <div class="space-y-3 border-b border-black pb-4">
                        <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider">–ö–æ–ø–∏—è</h3>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–§–ò–û</label>
                            <input type="text" id="copyToInput" value="–ö–ª—é–∫–∏–Ω –°.–ù." 
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <input type="text" id="copyTitleInput" value="–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä" 
                                class="input-field w-full text-sm text-black" style="padding: 12px 14px;">
                        </div>
                    </div>
                </form>
            </div>
        </aside>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center items-start" style="background: white;">
            
            <div id="pagesContainer" class="pages-container">

                <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –°–ª—É–∂–µ–±–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ -->
                <div id="documentPage" class="a4-page animate-fade-in-up">
                    
                    <div class="flex-none">
                        <div class="text-center font-bold text-[14pt] uppercase mb-4">
                            –°–õ–£–ñ–ï–ë–ù–ê–Ø –ó–ê–ü–ò–°–ö–ê
                        </div>

                        <div class="doc-header-grid text-[11pt]">
                            <div class="doc-col">
                                <div class="doc-line">–ò—Å—Ö. ‚Ññ <span id="previewOutNum"></span></div>
                                <div class="doc-line mt-2">–æ—Ç <span id="previewDateFull">¬´__¬ª _______ 20__ –≥.</span></div>
                                <div class="doc-line mt-4">–û—Ç –∫–æ–≥–æ: <span id="previewEmployeeName" class="font-bold">–ö–ª—é–∫–∏–Ω –°.–ù.</span></div>
                                <div class="doc-line">–î–æ–ª–∂–Ω–æ—Å—Ç—å: <span id="previewEmployeeTitle" class="italic">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</span></div>
                                <div class="doc-line">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: <span id="previewEmployeeDepartment" class="italic"></span></div>
                                <div class="doc-line mt-8">–¢–µ–ª–µ—Ñ–æ–Ω:</div>
                            </div>

                            <div class="doc-col">
                                <div class="doc-line">–í—Ö. ‚Ññ <span id="previewInNum"></span></div>
                                <div class="doc-line mt-2">–æ—Ç ¬´___¬ª ___________ 20__</div>
                                <div class="doc-line mt-4">–ö–æ–º—É: <span id="previewDirectorName" class="font-bold">–ë–æ—á–∞—Ä–æ–≤–æ–π –ê.–í.</span></div>
                                <div class="doc-line">–î–æ–ª–∂–Ω–æ—Å—Ç—å: <span id="previewDirectorTitle" class="italic">–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä</span></div>
                                <div class="doc-line mt-2">–ö–æ–º—É (–∫–æ–ø–∏—è): <span id="previewCopyTo">–ö–ª—é–∫–∏–Ω –°.–ù.</span></div>
                                <div class="doc-line">–î–æ–ª–∂–Ω–æ—Å—Ç—å: <span id="previewCopyTitle">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</span></div>
                                <div class="doc-line mt-2">–¢–µ–ª–µ—Ñ–æ–Ω:</div>
                            </div>
                        </div>

                        <div class="font-medium text-[12pt] mt-4 mb-2">–ü—Ä–µ–¥–º–µ—Ç: –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É</div>
                    </div>

                    <div class="w-full border-b border-black mb-4"></div>

                    <div class="flex-1 flex flex-col pt-24">
                        <div class="text-justify mb-1 indent-12 leading-relaxed text-[12pt]">
                            <span id="previewReason">–ü—Ä–æ—à—É –≤–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É –∑–∞ —Ä–∞—Å—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥</span>.
                        </div>

                        <div id="previewComment" class="text-justify mb-8 leading-relaxed text-[12pt]"></div>

                        <div id="previewAmountBlock" class="text-justify mb-2 leading-relaxed text-[12pt]">
                            –°—É–º–º–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ ‚Äì <span id="previewAmountNum" class="font-bold">____</span> —Ä—É–±.
                        </div>
                        <div id="previewHoursBlock" class="text-justify mb-2 leading-relaxed text-[12pt] hidden">
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ ‚Äì <span id="previewHoursNum" class="font-bold">____</span>
                        </div>
                        
                        <div id="previewAmountTextBlock" class="text-justify italic mb-8 p-2 border border-black text-[12pt]" style="background: repeating-linear-gradient(45deg, #fafbff 0px, #fafbff 4px, rgba(250, 251, 255, 0.3) 4px, rgba(250, 251, 255, 0.3) 8px);">
                            (<span id="previewAmountText">________________________</span>)
                        </div>

                        <div id="previewReceiptsText" class="mb-12 text-[12pt]">–ß–µ–∫–∏ –ø—Ä–∏–ª–∞–≥–∞—é.</div>
                    </div>

                    <div class="flex-none mt-auto pt-8">
                        <div class="flex justify-between items-end text-[12pt]">
                            <div id="previewEmployeeTitleSig" class="w-1/3 text-[11pt]">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</div>
                            <div class="w-1/3 border-b border-black h-8 relative mx-4 flex items-end justify-center"></div>
                            <div id="previewEmployeeNameSig" class="w-1/3 text-right">–ö–ª—é–∫–∏–Ω –°.–ù.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ================= FIREBASE INITIALIZATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyCnltG-ciUwtpZhFaAhTzLI_cjtVZURgEo",
            authDomain: "grafiki-aptek.firebaseapp.com",
            projectId: "grafiki-aptek",
            storageBucket: "grafiki-aptek.firebasestorage.app",
            messagingSenderId: "372041187072",
            appId: "1:372041187072:web:14b4326e85d3f347523de5",
            measurementId: "G-2KTEGH1MFK",
            databaseURL: "https://grafiki-aptek-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase wrapper functions
        async function firebaseGetItem(key) {
            try {
                const ref = database.ref('appData/' + key);
                const snapshot = await ref.once('value');
                const result = snapshot.exists() ? snapshot.val() : null;
                return result;
            } catch (error) {
                console.error('‚ùå Firebase getItem error:', error);
                // Fallback to localStorage
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('‚ùå localStorage —Ç–∞–∫–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', e);
                    return null;
                }
            }
        }

        // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
        let employeeReference = [];
        let pharmacyReference = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
        async function loadReferences() {
            try {
                const refData = await firebaseGetItem('scheduleReferenceData');
                if (refData) {
                    const data = typeof refData === 'string' ? JSON.parse(refData) : refData;
                    employeeReference = data.employeeReference || [];
                    pharmacyReference = data.pharmacyReference || [];
                    updateEmployeeSelect();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', e);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ select
        function updateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            if (!select) return;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
            const sorted = [...employeeReference].sort((a, b) => a.name.localeCompare(b.name));

            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>';
            sorted.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§–ò–û –≤ —Ñ–æ—Ä–º–∞—Ç "–§–∞–º–∏–ª–∏—è –ò.–û."
        function formatFIO(fullName) {
            if (!fullName) return '';
            
            // –ï—Å–ª–∏ —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–§–∞–º–∏–ª–∏—è –ò.–û." (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–∫—É –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∞), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if (fullName.match(/[–ê-–Ø–Å]\.[–ê-–Ø–Å]\./)) {
                return fullName;
            }
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
            const parts = fullName.trim().split(/\s+/);
            if (parts.length < 2) return fullName;
            
            // –ë–µ—Ä–µ–º —Ñ–∞–º–∏–ª–∏—é (–ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å)
            const lastName = parts[0];
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —á–∞—Å—Ç–µ–π
            const initials = parts.slice(1).map(part => {
                if (part.length > 0) {
                    return part[0].toUpperCase() + '.';
                }
                return '';
            }).join('');
            
            return `${lastName} ${initials}`.trim();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function onEmployeeSelectChange() {
            const select = document.getElementById('employeeSelect');
            const employeeInput = document.getElementById('employeeInput');
            const employeeTitleInput = document.getElementById('employeeTitleInput');
            const employeeDepartmentInput = document.getElementById('employeeDepartmentInput');

            if (!select || !select.value) {
                // –û–±–Ω—É–ª—è–µ–º –ø–æ–ª—è –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –≤—ã–±–æ—Ä–∞
                if (employeeInput) employeeInput.value = "";
                if (employeeTitleInput) employeeTitleInput.value = "";
                if (employeeDepartmentInput) employeeDepartmentInput.value = "";
                state.employee = "";
                state.employeeTitle = "";
                state.employeeDepartment = "";
                updateDocument();
                return;
            }

            const employee = employeeReference.find(e => e.id === select.value);
            if (employee) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –§–ò–û –≤ —Ñ–æ—Ä–º–∞—Ç "–§–∞–º–∏–ª–∏—è –ò.–û."
                const formattedName = formatFIO(employee.name);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –§–ò–û –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
                if (employeeInput) employeeInput.value = formattedName;
                if (employeeTitleInput) employeeTitleInput.value = employee.position || '';

                // –ù–∞—Ö–æ–¥–∏–º –∞–ø—Ç–µ–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                let departmentText = '';
                if (employee.pharmacy && pharmacyReference.length > 0) {
                    const pharmacy = pharmacyReference.find(p => p.id === employee.pharmacy);
                    if (pharmacy) {
                        departmentText = `–ê–ø—Ç–µ–∫–∞ ‚Ññ${pharmacy.number}, ${pharmacy.address}`;
                    }
                }
                if (employeeDepartmentInput) employeeDepartmentInput.value = departmentText;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                state.employee = formattedName;
                state.employeeTitle = employee.position || '';
                state.employeeDepartment = departmentText;

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
                updateDocument();
            }
        }

        const state = {
            director: "–ë–æ—á–∞—Ä–æ–≤–æ–π –ê.–í.",
            directorTitle: "–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä",
            employee: "",
            employeeTitle: "",
            employeeDepartment: "",
            copyTo: "–ö–ª—é–∫–∏–Ω –°.–ù.",
            copyTitle: "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä",
            reasonText: "–ü—Ä–æ—à—É –≤–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É –∑–∞ —Ä–∞—Å—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥",
            comment: "",
            date: "",
            outNum: "",
            amount: 0,
            hours: 0,
            valueType: "amount", // "amount" –∏–ª–∏ "hours"
            periodMonth: 0, // 0-11 (0 = —è–Ω–≤–∞—Ä—å, 11 = –¥–µ–∫–∞–±—Ä—å)
            periodYear: 2025,
            object: "",
            receipts: []
        };

        async function fetchGoogleSheetData() {
            const sheetId = '1KUegEdHb1Cl-AfriiZD7m6hwgTkHxfO5PDRsoDq1Isk';
            const gid = '0'; 
            const googleUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(googleUrl)}`;
            
            const statusEl = document.getElementById('sheetStatus');
            const dataList = document.getElementById('objectsList');

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error();
                const text = await response.text();
                const rows = text.split('\n');
                if (dataList) dataList.innerHTML = '';
                let count = 0;
                rows.forEach(row => {
                    const matches = row.match(/^"((?:""|[^"])*)"|([^,]*)/);
                    if (matches) {
                        let cell = matches[1] ? matches[1].replace(/""/g, '"') : matches[2];
                        if (cell && cell.trim().length > 0) {
                            const option = document.createElement('option');
                            option.value = cell.trim();
                            if (dataList) dataList.appendChild(option);
                            count++;
                        }
                    }
                });
                if (statusEl) {
                    statusEl.textContent = `–û–±—ä–µ–∫—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${count}`;
                    statusEl.classList.add('text-green-600');
                }
            } catch (e) {
                if (statusEl) {
                    statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.';
                    statusEl.classList.add('text-red-500');
                }
            }
        }

        const numToText = (number) => {
            if (!number || number === 0) return "________________________";
            const units = ['', '–æ–¥–∏–Ω', '–¥–≤–∞', '—Ç—Ä–∏', '—á–µ—Ç—ã—Ä–µ', '–ø—è—Ç—å', '—à–µ—Å—Ç—å', '—Å–µ–º—å', '–≤–æ—Å–µ–º—å', '–¥–µ–≤—è—Ç—å'];
            const teens = ['–¥–µ—Å—è—Ç—å', '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å', '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å', '—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å', '—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å', '–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å', '—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å', '—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å', '–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å', '–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å'];
            const tens = ['', '', '–¥–≤–∞–¥—Ü–∞—Ç—å', '—Ç—Ä–∏–¥—Ü–∞—Ç—å', '—Å–æ—Ä–æ–∫', '–ø—è—Ç—å–¥–µ—Å—è—Ç', '—à–µ—Å—Ç—å–¥–µ—Å—è—Ç', '—Å–µ–º—å–¥–µ—Å—è—Ç', '–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç', '–¥–µ–≤—è–Ω–æ—Å—Ç–æ'];
            const hundreds = ['', '—Å—Ç–æ', '–¥–≤–µ—Å—Ç–∏', '—Ç—Ä–∏—Å—Ç–∞', '—á–µ—Ç—ã—Ä–µ—Å—Ç–∞', '–ø—è—Ç—å—Å–æ—Ç', '—à–µ—Å—Ç—å—Å–æ—Ç', '—Å–µ–º—å—Å–æ—Ç', '–≤–æ—Å–µ–º—å—Å–æ—Ç', '–¥–µ–≤—è—Ç—å—Å–æ—Ç'];

            const morph = (n, f1, f2, f5) => {
                n = Math.abs(n) % 100;
                if (n > 10 && n < 20) return f5;
                const n1 = n % 10;
                if (n1 > 1 && n1 < 5) return f2;
                if (n1 === 1) return f1;
                return f5;
            };

            const convertGroup = (n, gender) => {
                let res = "";
                const h = Math.floor(n / 100);
                const t = Math.floor((n % 100) / 10);
                const u = n % 10;
                if (h > 0) res += hundreds[h] + " ";
                if (t === 1) res += teens[u] + " ";
                else {
                    if (t > 1) res += tens[t] + " ";
                    if (u > 0) {
                        if (gender === 'female' && u === 1) res += "–æ–¥–Ω–∞ ";
                        else if (gender === 'female' && u === 2) res += "–¥–≤–µ ";
                        else if (gender === 'male' && u === 1) res += "–æ–¥–∏–Ω ";
                        else if (gender === 'male' && u === 2) res += "–¥–≤–∞ ";
                        else res += units[u] + " ";
                    }
                }
                return res;
            };

            let rub = Math.floor(number);
            let kop = Math.round((number - rub) * 100);
            let text = "";
            const th = Math.floor(rub / 1000);
            if (th > 0) {
                text += convertGroup(th, 'female') + morph(th, "—Ç—ã—Å—è—á–∞", "—Ç—ã—Å—è—á–∏", "—Ç—ã—Å—è—á") + " ";
                rub %= 1000;
            }
            text += convertGroup(rub, 'male');
            text += morph(Math.floor(number), "—Ä—É–±–ª—å", "—Ä—É–±–ª—è", "—Ä—É–±–ª–µ–π");
            
            let kopText = (kop < 10 ? "0" + kop : kop) + " " + morph(kop, "–∫–æ–ø–µ–π–∫–∞", "–∫–æ–ø–µ–π–∫–∏", "–∫–æ–ø–µ–µ–∫");
            return (text + " " + kopText).trim();
        };

        function setupImageHandling() {
            const receiptsInput = document.getElementById('receiptsInput');
            if (receiptsInput) {
                receiptsInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            state.receipts.push({ id: Date.now() + Math.random(), dataUrl: ev.target.result });
                            renderReceiptUI();
                            renderReceiptPages();
                        };
                        reader.readAsDataURL(file);
                    });
                    receiptsInput.value = '';
                });
            }
        }

        function renderReceiptUI() {
            const list = document.getElementById('receiptsList');
            const noMsg = document.getElementById('noReceiptsMsg');
            if (!list) return;
            list.innerHTML = '';
            if (noMsg) noMsg.style.display = state.receipts.length ? 'none' : 'block';
            state.receipts.forEach((r, idx) => {
                const div = document.createElement('div');
                div.className = 'receipt-list-item animate-fade-in';
                div.innerHTML = `
                    <div class="flex items-center gap-2"><img src="${r.dataUrl}" class="w-8 h-8 object-cover" style="border: 1px solid #000; border-radius: 0;"><span>–ß–µ–∫ ‚Ññ${idx+1}</span></div>
                    <button onclick="removeReceipt(${r.id})" style="background: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 4px, rgba(240, 240, 240, 0.3) 4px, rgba(240, 240, 240, 0.3) 8px); color: #000; border: 1px solid #000; border-radius: 0; font-weight: 600; padding: 4px 8px; cursor: pointer;">‚úï</button>`;
                list.appendChild(div);
            });
        }

        function renderReceiptPages() {
            const container = document.getElementById('pagesContainer');
            const mainPage = document.getElementById('documentPage');
            if (!container || !mainPage) return;
            while (mainPage.nextElementSibling) mainPage.nextElementSibling.remove();
            state.receipts.forEach((r, idx) => {
                const page = document.createElement('div');
                page.className = 'a4-page animate-fade-in-up';
                page.innerHTML = `<div class="receipt-container"><div class="receipt-label">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ß–µ–∫ ‚Ññ${idx+1}</div><img src="${r.dataUrl}" class="receipt-img"></div>`;
                container.appendChild(page);
            });
        }

        window.removeReceipt = (id) => {
            state.receipts = state.receipts.filter(r => r.id !== id);
            renderReceiptUI();
            renderReceiptPages();
        };

        function updateDocument() {
            // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª–µ–π
            const elDirector = document.getElementById('directorInput');
            const elDirectorTitle = document.getElementById('directorTitleInput');
            const elEmployee = document.getElementById('employeeInput');
            const elEmployeeTitle = document.getElementById('employeeTitleInput');
            const elCopyTo = document.getElementById('copyToInput');
            const elCopyTitle = document.getElementById('copyTitleInput');
            const elObject = document.getElementById('objectInput');
            const elReason = document.getElementById('reasonInput');
            const elDate = document.getElementById('dateInput');
            const elEmployeeDepartment = document.getElementById('employeeDepartmentInput');
            const elValueType = document.getElementById('valueTypeInput');
            const elAmount = document.getElementById('amountInput');
            const elHours = document.getElementById('hoursInput');
            const elPeriodMonth = document.getElementById('periodMonthInput');
            const elPeriodYear = document.getElementById('periodYearInput');
            const elComment = document.getElementById('commentInput');

            if (elDirector) state.director = elDirector.value;
            if (elDirectorTitle) state.directorTitle = elDirectorTitle.value;
            if (elEmployee) state.employee = elEmployee.value;
            if (elEmployeeTitle) state.employeeTitle = elEmployeeTitle.value;
            if (elEmployeeDepartment) state.employeeDepartment = elEmployeeDepartment.value;
            if (elCopyTo) state.copyTo = elCopyTo.value;
            if (elCopyTitle) state.copyTitle = elCopyTitle.value;
            if (elAmount) state.amount = parseFloat(elAmount.value) || 0;
            if (elHours) state.hours = parseFloat(elHours.value) || 0;
            if (elValueType) state.valueType = elValueType.value;
            if (elPeriodMonth !== null) state.periodMonth = parseInt(elPeriodMonth.value) || 11;
            if (elPeriodYear !== null) state.periodYear = parseInt(elPeriodYear.value) || new Date().getFullYear();
            if (elObject) state.object = elObject.value;
            if (elComment) state.comment = elComment.value;
            if (elDate) state.date = elDate.value;

            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è —Å —Ä–∞—Å—á–µ—Ç–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º
            const months = ['—è–Ω–≤–∞—Ä—å', '—Ñ–µ–≤—Ä–∞–ª—å', '–º–∞—Ä—Ç', '–∞–ø—Ä–µ–ª—å', '–º–∞–π', '–∏—é–Ω—å', '–∏—é–ª—å', '–∞–≤–≥—É—Å—Ç', '—Å–µ–Ω—Ç—è–±—Ä—å', '–æ–∫—Ç—è–±—Ä—å', '–Ω–æ—è–±—Ä—å', '–¥–µ–∫–∞–±—Ä—å'];
            const periodText = `${months[state.periodMonth]} ${state.periodYear}`;
            state.reasonText = `–ü—Ä–æ—à—É –≤–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É –∑–∞ ${periodText}`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
            const previewIds = {
                'previewDirectorName': state.director,
                'previewDirectorTitle': state.directorTitle,
                'previewEmployeeName': state.employee,
                'previewEmployeeTitle': state.employeeTitle,
                'previewEmployeeNameSig': state.employee,
                'previewEmployeeTitleSig': state.employeeTitle,
                'previewEmployeeDepartment': state.employeeDepartment || '',
                'previewCopyTo': state.copyTo,
                'previewCopyTitle': state.copyTitle,
                'previewReason': state.reasonText,
                'previewOutNum': state.outNum
            };

            for (let id in previewIds) {
                const el = document.getElementById(id);
                if (el) el.textContent = previewIds[id];
            }

            // –û–±—ä–µ–∫—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –≤ –∑–∞—Ä–∞–±–æ—Ç–Ω—É—é –ø–ª–∞—Ç—É

            const previewDateFull = document.getElementById('previewDateFull');
            if (previewDateFull) {
                if (state.date) {
                    const d = new Date(state.date);
                    const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
                    previewDateFull.innerHTML = `¬´${d.getDate()}¬ª ${months[d.getMonth()]} ${d.getFullYear()} –≥.`;
                } else {
                    previewDateFull.innerHTML = `¬´__¬ª _______ 20__ –≥.`;
                }
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—É–º–º–æ–π –∏ —á–∞—Å–∞–º–∏
            const amountBlock = document.getElementById('previewAmountBlock');
            const hoursBlock = document.getElementById('previewHoursBlock');
            const amountTextBlock = document.getElementById('previewAmountTextBlock');
            const receiptsText = document.getElementById('previewReceiptsText');
            
            if (state.valueType === 'hours') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã, —Å–∫—Ä—ã–≤–∞–µ–º —Å—É–º–º—É –∏ "–ß–µ–∫–∏ –ø—Ä–∏–ª–∞–≥–∞—é"
                if (amountBlock) amountBlock.classList.add('hidden');
                if (hoursBlock) hoursBlock.classList.remove('hidden');
                if (amountTextBlock) amountTextBlock.classList.add('hidden');
                if (receiptsText) receiptsText.classList.add('hidden');
                
                const hoursEl = document.getElementById('previewHoursNum');
                if (hoursEl) {
                    if (state.hours > 0) {
                        hoursEl.textContent = Math.round(state.hours).toLocaleString('ru-RU');
                    } else {
                        hoursEl.textContent = "____";
                    }
                }
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º—É, —Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ß–µ–∫–∏ –ø—Ä–∏–ª–∞–≥–∞—é"
                if (amountBlock) amountBlock.classList.remove('hidden');
                if (hoursBlock) hoursBlock.classList.add('hidden');
                if (amountTextBlock) amountTextBlock.classList.remove('hidden');
                if (receiptsText) receiptsText.classList.remove('hidden');
                
                const amtEl = document.getElementById('previewAmountNum');
                const amtTxt = document.getElementById('previewAmountText');
                if (amtEl && amtTxt) {
                    if (state.amount > 0) {
                        amtEl.textContent = state.amount.toLocaleString('ru-RU', { minimumFractionDigits: 2 });
                        amtTxt.textContent = numToText(state.amount);
                    } else {
                        amtEl.textContent = "____";
                        amtTxt.textContent = "________________________";
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            const commentEl = document.getElementById('previewComment');
            if (commentEl) {
                if (state.comment && state.comment.trim()) {
                    commentEl.textContent = state.comment.trim();
                    commentEl.classList.remove('hidden');
                } else {
                    commentEl.textContent = '';
                    commentEl.classList.add('hidden');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–¥–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
        function initPeriodYear() {
            const yearSelect = document.getElementById('periodYearInput');
            if (!yearSelect) return;
            
            yearSelect.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–¥—ã —Å 2025 –ø–æ 2030
            for (let year = 2025; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === state.periodYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—É–º–º–æ–π –∏ —á–∞—Å–∞–º–∏
        function toggleValueType() {
            const valueType = document.getElementById('valueTypeInput');
            const amountContainer = document.getElementById('amountContainer');
            const hoursContainer = document.getElementById('hoursContainer');
            
            if (!valueType) return;
            
            valueType.addEventListener('change', (e) => {
                if (e.target.value === 'hours') {
                    if (amountContainer) amountContainer.classList.add('hidden');
                    if (hoursContainer) hoursContainer.classList.remove('hidden');
                } else {
                    if (amountContainer) amountContainer.classList.remove('hidden');
                    if (hoursContainer) hoursContainer.classList.add('hidden');
                }
                updateDocument();
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            const elDirector = document.getElementById('directorInput');
            if (elDirector) elDirector.value = state.director;
            
            const elDirectorTitle = document.getElementById('directorTitleInput');
            if (elDirectorTitle) elDirectorTitle.value = state.directorTitle;
            
            const elEmployee = document.getElementById('employeeInput');
            if (elEmployee) elEmployee.value = state.employee;
            
            const elEmployeeTitle = document.getElementById('employeeTitleInput');
            if (elEmployeeTitle) elEmployeeTitle.value = state.employeeTitle;
            
            const elCopyTo = document.getElementById('copyToInput');
            if (elCopyTo) elCopyTo.value = state.copyTo;
            
            const elCopyTitle = document.getElementById('copyTitleInput');
            if (elCopyTitle) elCopyTitle.value = state.copyTitle;
            
            const elDate = document.getElementById('dateInput');
            if (elDate) elDate.valueAsDate = new Date();
            
            const elReason = document.getElementById('reasonInput');
            if (elReason) elReason.value = state.reasonText;
            
            // –û–±–Ω—É–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const elEmployeeSelect = document.getElementById('employeeSelect');
            if (elEmployeeSelect) elEmployeeSelect.value = "";
            
            const elEmployeeDepartment = document.getElementById('employeeDepartmentInput');
            if (elEmployeeDepartment) elEmployeeDepartment.value = "";
            
            const elAmount = document.getElementById('amountInput');
            if (elAmount) elAmount.value = "";
            
            const elHours = document.getElementById('hoursInput');
            if (elHours) elHours.value = "";
            
            const elComment = document.getElementById('commentInput');
            if (elComment) elComment.value = "";
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            const elPeriodMonth = document.getElementById('periodMonthInput');
            if (elPeriodMonth) elPeriodMonth.value = state.periodMonth;
            initPeriodYear();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∞ –∑–Ω–∞—á–µ–Ω–∏—è
            const elValueType = document.getElementById('valueTypeInput');
            if (elValueType) elValueType.value = state.valueType;
            toggleValueType();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
            const amountContainer = document.getElementById('amountContainer');
            const hoursContainer = document.getElementById('hoursContainer');
            if (state.valueType === 'hours') {
                if (amountContainer) amountContainer.classList.add('hidden');
                if (hoursContainer) hoursContainer.classList.remove('hidden');
            } else {
                if (amountContainer) amountContainer.classList.remove('hidden');
                if (hoursContainer) hoursContainer.classList.add('hidden');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
            await loadReferences();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employeeSelect = document.getElementById('employeeSelect');
            if (employeeSelect) {
                employeeSelect.addEventListener('change', onEmployeeSelectChange);
            }
            
            setupImageHandling();
            fetchGoogleSheetData();

            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(i => i.addEventListener('input', updateDocument));

            // –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            const periodMonth = document.getElementById('periodMonthInput');
            const periodYear = document.getElementById('periodYearInput');
            if (periodMonth) {
                periodMonth.addEventListener('change', updateDocument);
            }
            if (periodYear) {
                periodYear.addEventListener('change', updateDocument);
            }

            updateDocument();
        });
    </script>
</body>
</html>
